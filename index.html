<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeTrack - Â∞àÊ•≠ AI Êó•Ë™åËàáÂÆòÊñπËÇ°Â∏ÇË®òÂ∏≥</title>
    <!-- ÂºïÂÖ• Vue 3, Tailwind CSS Ëàá Lucide ÂúñÁ§∫Â∫´ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDK ÂºïÂÖ•ËàáÂÖ®ÂüüÂÆ£Âëä -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.FirebaseSDK = { 
            initializeApp, getAuth, onAuthStateChanged, signInWithCustomToken, 
            signInAnonymously, signOut, GoogleAuthProvider, signInWithPopup,
            getFirestore, doc, setDoc, getDoc, onSnapshot, collection 
        };
    </script>

    <style>
        [v-cloak] { display: none; }
        :root { --p-color: #4f46e5; }
        
        /* Âü∫Á§é‰ΩàÂ±Ä */
        .app-container { height: 100dvh; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background-color: #f1f5f9;
            overscroll-behavior: none;
        }

        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .text-p { color: var(--p-color) !important; }
        .bg-p { background-color: var(--p-color) !important; }
        .border-p { border-color: var(--p-color) !important; }
        .ring-p { --tw-ring-color: var(--p-color) !important; }

        .app-font-small { font-size: 12px; }
        .app-font-medium { font-size: 16px; }
        .app-font-large { font-size: 20px; }
        
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .safe-pb { padding-bottom: calc(8.5rem + env(safe-area-inset-bottom)); }

        /* ÁîúÁîúÂúàÂúñÊ®£Âºè (Donut Chart) */
        .pie-chart-flat {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            transition: all 0.5s ease;
        }
        .pie-hole {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 155px; height: 155px;
            background-color: #ffffff;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .modal-scrollable {
            touch-action: pan-y;
            overflow-x: hidden;
            overflow-y: auto;
            will-change: transform, opacity;
        }
        .modal-transition {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 1.25rem;
            transition: all 0.2s;
            overflow: hidden;
        }
        .nav-active { font-weight: 900; }
        
        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .version-watermark {
            position: absolute;
            bottom: 110px;
            left: 0;
            right: 0;
            text-align: center;
            color: #94a3b8;
            font-size: 10px;
            font-weight: 900;
            opacity: 0.4;
            pointer-events: none;
            letter-spacing: 2px;
        }
        .slide-down-enter-active, .slide-down-leave-active { transition: all 0.3s ease; }
        .slide-down-enter-from, .slide-down-leave-to { transform: translateY(-100%); opacity: 0; }
        
        .photo-grid-1 { grid-template-columns: 1fr; }
        .photo-grid-2 { grid-template-columns: 1fr 1fr; }
        .photo-grid-3 { grid-template-areas: "a b" "a c"; grid-template-columns: 1.5fr 1fr; }
    </style>
</head>
<body class="antialiased overflow-hidden text-slate-900">

<div id="app" v-cloak class="flex justify-center items-center app-container" :style="{'--p-color': settings.themeColor}">
    <!-- Èõ≤Á´ØÂêåÊ≠•‰∏≠Ë¶ÜËìãÂ±§ -->
    <div v-if="isGlobalLoading" class="absolute inset-0 z-[200] bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-slate-100 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black text-slate-400 tracking-widest uppercase">Cloud Syncing...</p>
    </div>

    <div :class="['w-full sm:max-w-md h-full bg-slate-50 shadow-2xl relative flex flex-col overflow-hidden transition-all duration-300', 'app-font-' + settings.fontSize]">
        
        <!-- ÈÄöÁü•Âàó -->
        <transition name="slide-down">
            <div v-if="errorMsg" class="absolute top-0 left-0 right-0 z-[100] bg-red-500 text-white py-3 px-6 text-center font-black text-xs shadow-xl flex items-center justify-center gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                {{ errorMsg }}
            </div>
        </transition>

        <!-- Ê®ôÈ°åÂçÄÂüü -->
        <header :style="{ backgroundColor: settings.themeColor }" class="p-4 text-white shadow-md shrink-0 z-50 transition-all duration-500">
            <div v-if="currentView === 'ledger'" class="space-y-2">
                <div class="flex items-center justify-between">
                    <button @click="changeYear(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showYearPicker = true" class="text-lg font-black tracking-widest cursor-pointer active:opacity-70">{{ currentYear }} {{ t('year') }}</span>
                    <button @click="changeYear(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="flex items-center justify-between">
                    <button @click="changeMonth(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showMonthPicker = true" class="text-xl font-black tracking-widest cursor-pointer active:opacity-70">{{ currentMonth + 1 }} {{ t('month') }}</span>
                    <button @click="changeMonth(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div v-else class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
                        <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="white" stroke-width="2.5"/>
                        <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="12" cy="12" r="3" fill="white" fill-opacity="0.3"/>
                    </svg>
                    <h1 class="font-black tracking-tight" style="font-size: 1.3em">{{ t(currentView) }}</h1>
                </div>
                <div @click="showYearPicker = true" class="text-right cursor-pointer active:opacity-60 bg-white/10 px-3 py-1 rounded-xl backdrop-blur-sm border border-white/10">
                    <p class="text-[0.6em] font-bold opacity-70">{{ currentYear }}{{ t('year') }}</p>
                    <p class="text-[1.1em] font-black leading-none">{{ currentMonth + 1 }}{{ t('month') }}</p>
                </div>
            </div>
        </header>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 safe-pb relative">
            <!-- Âπ¥ÊúàÈÅ∏ÊìáÂΩàÁ™ó -->
            <div v-if="showYearPicker || showMonthPicker" class="absolute inset-0 z-[60] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showYearPicker = false; showMonthPicker = false"></div>
                <div class="relative w-full max-w-xs bg-white rounded-[2.5rem] p-6 shadow-2xl animate-in zoom-in duration-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-black text-slate-400 text-xs uppercase tracking-widest">{{ showYearPicker ? t('choose_year') : t('choose_month') }}</h3>
                        <div class="flex gap-2">
                            <button @click="showYearPicker = true; showMonthPicker = false" :class="showYearPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                            <button @click="showMonthPicker = true; showYearPicker = false" :class="showMonthPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="layers" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="picker-grid max-h-60 overflow-y-auto hide-scrollbar">
                        <template v-if="showYearPicker">
                            <button v-for="y in yearRange" :key="y" @click="changeYearTo(y)" 
                                :class="currentYear === y ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ y }}</button>
                        </template>
                        <template v-if="showMonthPicker">
                            <button v-for="m in 12" :key="m" @click="changeMonthTo(m-1)" 
                                :class="currentMonth === m-1 ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ m }}{{ t('month') }}</button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- ÂàÜÈ†ÅÔºöÂ∏≥Êú¨ -->
            <section v-if="currentView === 'ledger'" class="animate-in fade-in duration-300">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="calendar-grid text-center text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">
                        <div v-for="d in t('weekdays')" :key="d">{{ d }}</div>
                    </div>
                    <div class="calendar-grid gap-1">
                        <div v-for="empty in firstDayOfMonth" :key="'e'+empty"></div>
                        <div v-for="day in daysInMonth" :key="day" @click="selectedDay = day"
                            :style="selectedDay === day ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                            class="p-2 text-center rounded-xl cursor-pointer transition relative aspect-square flex flex-col items-center justify-center hover:bg-slate-100"
                            :class="selectedDay === day ? 'shadow-lg scale-105 z-10 font-black' : ''"
                        >
                            <span class="text-[0.85em] font-bold">{{ day }}</span>
                            <div class="flex gap-0.5 mt-0.5">
                                <div v-if="getDayEntries(day).hasDiary" :class="selectedDay === day ? 'bg-white' : 'bg-blue-400'" class="w-1 h-1 rounded-full"></div>
                                <div v-if="getDayEntries(day).hasFinance" :class="selectedDay === day ? 'bg-white' : 'bg-green-400'" class="w-1 h-1 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-4">
                    <h3 class="text-[0.75em] font-black text-slate-400 uppercase tracking-wider px-1">{{ selectedDateString }}</h3>
                    
                    <div v-if="currentDayData" class="flex flex-col gap-4">
                        <!-- Áï∂Êó•Ë≤°Âãô -->
                        <div @click="openAddModal('finance')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between mb-4 border-b border-slate-50 pb-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="circle-dollar-sign" class="w-4 h-4 text-p"></i>
                                    <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_finance') }}</span>
                                </div>
                                <span class="text-[0.7em] font-bold text-slate-300">#{{ currentDayData?.records?.length || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center px-1">
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-red-50 flex items-center justify-center text-red-600 font-black"><i data-lucide="arrow-down-left" class="w-3 h-3"></i></div><span class="text-[0.95em] font-black text-red-600 font-mono">+{{ formatNumber(dayTotalIncome) }}</span></div>
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-green-50 flex items-center justify-center text-green-600 font-black"><i data-lucide="arrow-up-right" class="w-3 h-3"></i></div><span class="text-[0.95em] font-black text-green-600 font-mono">-{{ formatNumber(dayTotalExpense) }}</span></div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1">{{ t('daily_net') }}</p>
                                    <div :class="dayNetBalance >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[1.8em] font-black font-mono tracking-tighter leading-none">
                                        {{ dayNetBalance >= 0 ? '+' : '' }}{{ formatNumber(dayNetBalance) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂøÉÊÉÖÊó•Ë™å -->
                        <div @click="openAddModal('diary')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between mb-4 border-b border-slate-50 pb-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="pen-tool" class="w-4 h-4 text-orange-400"></i>
                                    <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_diary') }}</span>
                                </div>
                                <div class="text-[1.2em] leading-none">{{ currentDayData?.feeling || 'üòä' }}</div>
                            </div>
                            <div class="px-1 space-y-3">
                                <div v-if="currentDayData?.photos?.length" class="grid gap-1 overflow-hidden rounded-xl" :class="getPhotoGridClass(currentDayData.photos.length)">
                                    <img v-for="(img, idx) in currentDayData.photos.slice(0, 3)" :key="idx" :src="img" class="w-full h-full object-cover min-h-[80px]">
                                </div>
                                <p class="text-[0.9em] text-slate-600 leading-relaxed truncate">{{ currentDayData?.diaryText || t('no_diary_text') }}</p>
                                <div v-if="currentDayData?.locations?.length" class="flex gap-1 overflow-x-auto hide-scrollbar pt-1">
                                    <div v-for="loc in currentDayData.locations" :key="loc.name" class="flex items-center whitespace-nowrap bg-slate-100 px-2 py-1 rounded text-[0.6em] font-bold text-slate-500">
                                        <i data-lucide="map-pin" class="w-2.5 h-2.5 mr-1"></i>{{ loc.name }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÂàÜÈ†ÅÔºöËÇ°Â∏ÇÊäïË≥á -->
            <section v-if="currentView === 'stocks'" class="p-6 space-y-6 animate-in fade-in">
                <div class="bg-slate-900 text-white p-7 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10 space-y-5 text-center">
                        <div class="flex justify-between items-center border-b border-white/10 pb-5">
                            <div class="flex-1"><p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('market_value') }}</p><p class="text-xl font-black font-mono tracking-tighter">${{ formatNumber(stockTotalValue) }}</p></div>
                            <div class="w-px h-8 bg-white/10 mx-2"></div>
                            <div class="flex-1"><p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('total_profit') }}</p><p :class="stockTotalProfit >= 0 ? 'text-red-400' : 'text-green-400'" class="text-xl font-black font-mono tracking-tighter">{{ stockTotalProfit >= 0 ? '+' : '' }}{{ formatNumber(stockTotalProfit) }}</p></div>
                        </div>
                        <button @click="updatePortfolioPrices" :disabled="isAILoading" class="w-full py-3 bg-white/10 rounded-2xl font-black text-[0.75em] flex items-center justify-center gap-2 active:scale-95 transition-all"><i v-if="isAILoading" data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>{{ isAILoading ? t('fetching') : t('stat_btn') }}</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(stk, idx) in stockPortfolio" :key="idx" class="bg-white p-4 rounded-3xl border border-slate-100 card-shadow flex justify-between items-center transition-all cursor-pointer" @touchstart="startStockLongPress(stk, idx)" @touchend="endStockLongPress" @mousedown="startStockLongPress(stk, idx)" @mouseup="endStockLongPress">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center mr-4 text-[1.25em] font-bold text-p shadow-inner">{{ stk?.name?.[0] || '?' }}</div>
                            <div class="min-w-0 flex-1"><p class="text-sm font-black text-slate-800 truncate pr-2">{{ stk?.name || '---' }}</p><p class="text-[0.6em] text-slate-400 font-bold uppercase mt-1">{{ stk?.qty }} {{ t('shares_unit') }} ¬∑ cost - {{ formatNumber(stk?.buyPrice) }}</p></div>
                        </div>
                        <div class="flex items-center gap-4 text-right shrink-0">
                            <div><p :class="((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[0.9em] font-black font-mono">{{ ((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) >= 0 ? '+' : '' }}{{ formatNumber(((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) * (stk?.qty || 0)) }}</p><p class="text-[0.55em] text-slate-400 font-bold uppercase">ÁèæÂÉπ: {{ stk?.currentPrice || '---' }}</p></div>
                            <button @click.stop="stockPortfolio.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-6 bg-white rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4 relative">
                        <div class="relative">
                            <input v-model="newStock.name" @input="debouncedSearch" type="text" class="bg-slate-50 w-full p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner" :placeholder="t('stock_name_ph')">
                            <div v-if="stockSuggestions.length" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-2xl shadow-2xl border border-slate-100 z-[100] max-h-60 overflow-y-auto hide-scrollbar">
                                <div v-for="sug in stockSuggestions" :key="sug.id" @click="selectStockSuggestion(sug)" class="suggestion-item cursor-pointer hover:bg-slate-50">
                                    <div class="flex justify-between items-center"><span class="text-sm font-black">{{ sug.name }}</span><span class="text-xs font-bold text-slate-400">{{ sug.id }}</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model.number="newStock.qty" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_qty_ph')">
                            <input v-model.number="newStock.buyPrice" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_buy_ph')">
                        </div>
                        <button @click="addStockItem" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-4 rounded-2xl font-black text-[0.8em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_stock_btn') }}</button>
                    </div>
                </div>
            </section>

            <!-- ÂàÜÊûêÁµ±Ë®àÈ†ÅÈù¢ -->
            <section v-if="currentView === 'charts'" class="p-6 space-y-8 animate-in fade-in text-center text-slate-700">
                <div class="bg-white p-4 rounded-[2rem] card-shadow border border-slate-50 flex items-center justify-between transition-all overflow-hidden gap-1">
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-red-600 uppercase mb-0.5 truncate">{{ t('income_short') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.income) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-green-600 uppercase mb-0.5 truncate">{{ t('expense_short') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.expense) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-indigo-500 uppercase mb-0.5 truncate">{{ t('balance') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.net) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-orange-500 uppercase mb-0.5 truncate">{{ t('unrealized_pl_short') }}</p><p :class="stockTotalProfit >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[0.75em] font-black truncate">${{ formatNumber(stockTotalProfit) }}</p></div>
                </div>

                <div class="bg-white p-8 rounded-[3rem] card-shadow flex flex-col items-center border border-slate-50 overflow-hidden">
                    <div class="flex justify-between items-center w-full mb-8 px-2">
                        <h4 class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ chartMode === 'expense' ? t('expense_structure') : t('income_structure') }}</h4>
                        <div class="flex bg-slate-50 p-1 rounded-full text-[0.6em] font-black border border-slate-100 overflow-hidden">
                            <button @click="chartMode = 'expense'" :class="chartMode === 'expense' ? 'bg-green-600 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('expense_short') }}</button>
                            <button @click="chartMode = 'income'" :class="chartMode === 'income' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('income_short') }}</button>
                        </div>
                    </div>
                    
                    <div class="pie-chart-flat" :style="{ background: pieGradient }">
                        <div class="pie-hole">
                            <p class="text-[0.5em] text-slate-400 font-black uppercase tracking-widest mb-1">{{ chartMode === 'expense' ? t('expense') : t('income') }}</p>
                            <p class="text-[1.25rem] font-black leading-tight" :class="chartMode === 'expense' ? 'text-green-600' : 'text-red-500'">${{ formatNumber(chartTotalValue) }}</p>
                        </div>
                    </div>

                    <div class="w-full mt-10 space-y-2">
                        <template v-for="(cat, cidx) in chartCategories" :key="cat.name">
                             <div @click="jumpToCategoryDetails(cat.name)" class="group flex items-center p-3 rounded-[1.25rem] bg-white hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all cursor-pointer">
                                <div class="w-8 text-center text-[0.7em] font-black text-slate-300">{{ cidx + 1 }}</div>
                                <div class="w-4 h-4 rounded-full mr-3 shrink-0 shadow-sm" :style="{backgroundColor: cat.color}"></div>
                                <div class="flex flex-col min-w-0 flex-1 text-left">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[0.9em] font-black text-slate-700 truncate">{{ cat.name }}</span>
                                        <span class="text-[0.8em] font-black" :class="chartMode==='expense'?'text-green-600':'text-red-500'">${{ formatNumber(cat.value) }}</span>
                                    </div>
                                    <div class="h-1.5 bg-slate-100 rounded-full w-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-700" :style="{ width: (cat.value / chartTotalValue * 100) + '%', backgroundColor: cat.color }"></div>
                                    </div>
                                </div>
                                <div class="w-10 text-right">
                                    <span class="text-[0.65em] font-bold text-slate-400">{{ chartTotalValue > 0 ? Math.round((cat.value / chartTotalValue) * 100) : 0 }}%</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 ml-1 group-hover:text-slate-400 transition-colors"></i>
                            </div>
                        </template>
                        <div v-if="chartCategories.length === 0" class="py-12 opacity-30 text-center font-black text-xs">ÁõÆÂâçÁÑ°Ë≥áÊñô</div>
                    </div>
                </div>
            </section>
            
            <!-- Ë®≠ÂÆöÂàÜÈ†Å -->
            <section v-if="currentView === 'settings'" class="p-6 space-y-6">
                <!-- Â∏≥ËôüËàáÂêåÊ≠•ÂçÄÂ°ä -->
                <div class="bg-white rounded-[2.5rem] p-8 card-shadow space-y-6 border border-slate-100">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-indigo-600 shadow-inner overflow-hidden">
                            <img v-if="user?.photoURL" :src="user.photoURL" class="w-full h-full object-cover">
                            <i v-else data-lucide="user" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest">{{ t('account_sync') }}</h3>
                            <p class="text-[10px] font-bold text-slate-400">{{ user ? user.email : t('not_logged_in') }}</p>
                        </div>
                    </div>
                    
                    <div v-if="user" class="space-y-4">
                        <div class="flex justify-between items-center bg-green-50 p-4 rounded-2xl border border-green-100">
                            <span class="text-[10px] font-black text-green-700 tracking-widest uppercase">Cloud Status</span>
                            <div class="flex items-center gap-1.5 text-green-600 font-black text-[10px]">
                                <i data-lucide="check-circle" class="w-3 h-3"></i> Synchronized
                            </div>
                        </div>
                        <button @click="handleLogout" class="w-full py-4 bg-slate-50 text-red-500 rounded-2xl font-black text-xs hover:bg-red-50 transition-all">
                            {{ t('logout_btn') }}
                        </button>
                    </div>
                    <div v-else class="space-y-4">
                        <p class="text-xs font-bold text-slate-500 leading-relaxed px-1">{{ t('sync_hint') }}</p>
                        <button @click="showLoginModal = true" class="w-full py-5 bg-indigo-600 text-white rounded-3xl font-black text-xs shadow-xl shadow-indigo-100 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                            {{ t('login_start_btn') }}
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] p-8 card-shadow space-y-8 transition-all">
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('lang_label') }}</span>
                        <select v-model="settings.lang" class="bg-slate-50 rounded-xl px-4 py-3 font-black text-[0.7em] outline-none border-none ring-1 ring-slate-100"><option value="zh">ÁπÅÈ´î‰∏≠Êñá</option><option value="en">English</option></select>
                    </div>
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('theme_label') }}</span>
                        <div class="flex gap-3"><div v-for="color in ['#4f46e5', '#10b981', '#f43f5e', '#1e293b', '#f59e0b']" @click="settings.themeColor = color" :style="{ backgroundColor: color }" class="w-8 h-8 rounded-full cursor-pointer border-2 shadow-md active:scale-75 transition-all" :class="settings.themeColor === color ? 'border-white ring-2 ring-indigo-200 scale-125' : 'border-transparent'"></div></div>
                    </div>
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('font_label') }}</span>
                        <div class="flex bg-slate-50 p-1 rounded-xl ring-1 ring-slate-100 overflow-hidden"><button v-for="sz in ['small', 'medium', 'large']" :key="sz" @click="settings.fontSize = sz" :style="settings.fontSize === sz ? { backgroundColor: settings.themeColor, color: 'white' } : {}" class="px-4 py-2 text-[0.65em] font-black rounded-lg transition-all">{{ t('font_' + sz) }}</button></div>
                    </div>
                </div>
                <div class="version-watermark">{{ version }}</div>
            </section>
        </main>

        <!-- ÁôªÂÖ•ÈÅ∏ÂñÆÂΩàÁ™ó -->
        <transition name="fade">
            <div v-if="showLoginModal" class="fixed inset-0 z-[210] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" @click="showLoginModal = false"></div>
                <div class="relative w-full max-w-sm bg-white rounded-[2.5rem] p-10 shadow-2xl animate-in zoom-in duration-200 text-center">
                    <h2 class="text-xl font-black text-slate-800 mb-2">ÁôªÂÖ• LifeTrack</h2>
                    <p class="text-xs font-bold text-slate-400 mb-8 leading-relaxed">ÈÅ∏ÊìáÊÇ®ÁöÑÁôªÂÖ•ÊñπÂºè‰ª•ÈñãÂßãÂêåÊ≠•</p>
                    <div class="space-y-3">
                        <button @click="handleGoogleLogin" class="w-full py-4 bg-white border-2 border-slate-100 text-slate-700 rounded-2xl font-black text-xs shadow-sm hover:bg-slate-50 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                            <svg class="w-4 h-4" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            ‰ΩøÁî® Google Â∏≥ËôüÈÄ£Áµê
                        </button>
                    </div>
                    <button @click="showLoginModal = false" class="mt-8 text-[10px] font-black text-slate-300 uppercase tracking-widest hover:text-slate-400 transition-colors">Á®çÂæåÂÜçË™™</button>
                </div>
            </div>
        </transition>

        <!-- Á∑®ËºØ/Êñ∞Â¢ûË¶ñÁ™ó (‰øùÊåÅ‰∏çËÆä) -->
        <transition name="fade">
            <div v-if="showAddModal" class="fixed inset-0 z-[100] flex items-end justify-center">
                <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showAddModal = false"></div>
                <div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[96vh] shadow-2xl modal-scrollable overflow-x-hidden" :class="{ 'modal-transition': !isDraggingModal }" :style="modalStyle" @touchstart="handleModalTouchStart" @touchmove="handleModalTouchMove" @touchend="handleModalTouchEnd">
                    <button @click="showAddModal = false" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600 transition-colors z-[110]"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div>
                    <div class="flex justify-between items-center mb-6 px-1"><h2 class="text-[1.3em] font-black text-slate-800">{{ currentMonth+1 }}/{{ selectedDay }} {{ t('new_record') }}</h2><button @click="saveRecord" :style="{ backgroundColor: settings.themeColor }" class="text-white px-10 py-3 rounded-full font-black shadow-xl active:scale-95 transition-all text-[0.8em] mr-8">{{ t('save') }}</button></div>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8"><button @click="editTab = 'diary'" :class="editTab === 'diary' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'diary' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_diary') }}</button><button @click="editTab = 'finance'" :class="editTab === 'finance' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'finance' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_finance') }}</button></div>
                    <div v-if="editTab === 'finance'" class="space-y-8 pb-24">
                        <div class="space-y-4">
                            <div v-for="(rec, ridx) in form.records" :key="ridx" class="flex items-center justify-between bg-white p-4 rounded-[1.5rem] card-shadow border border-slate-50 overflow-hidden"><div class="flex items-center min-w-0 flex-1"><div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center mr-3 text-[1.25em] shadow-inner">{{ getCategoryIcon(rec?.category) }}</div><div class="min-w-0 flex-1"><p class="text-sm font-black text-slate-800">{{ rec?.category }}</p><p v-if="rec?.note" class="text-[10px] text-slate-400 font-bold truncate pr-4">{{ rec?.note }}</p></div></div><div class="flex items-center gap-3"><span :class="rec?.type === 'income' ? 'text-red-600' : 'text-green-600'" class="font-mono font-black">{{ rec?.type === 'income' ? '+' : '-' }}{{ formatNumber(rec?.amount) }}</span><button @click="form.records.splice(ridx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>
                        </div>
                        <div class="p-6 bg-slate-50/80 rounded-[2.5rem] border border-slate-200 space-y-6">
                            <div class="flex justify-between items-center px-1"><span class="text-[10px] font-black text-slate-400 tracking-widest uppercase">{{ t('add_new_line') }}</span><div class="flex bg-white p-1 rounded-full shadow-sm text-[9px] font-black border border-slate-100 overflow-hidden"><button @click="newRecord.type = 'expense'" :class="newRecord.type === 'expense' ? 'bg-green-600 text-white shadow-md' : 'text-slate-400'" class="px-6 py-2.5 transition-all">{{ t('expense_short') }}</button><button @click="newRecord.type = 'income'" :class="newRecord.type === 'income' ? 'bg-red-500 text-white shadow-md' : 'text-red-500'" class="px-6 py-2.5 transition-all">{{ t('income_short') }}</button></div></div>
                            <div class="grid grid-cols-4 gap-3">
                                <button v-for="cat in currentCategories" :key="cat?.name" @click="newRecord.category = cat.name" @touchstart="startCategoryLongPress(cat)" @touchend="endCategoryLongPress" @mousedown="startCategoryLongPress(cat)" @mouseup="endCategoryLongPress" :class="newRecord.category === cat?.name ? 'ring-4 ring-indigo-100 bg-white scale-105 shadow-sm' : 'bg-white/40 opacity-70'" class="category-btn transition-all"><span class="text-xl mb-1">{{ cat?.icon }}</span><span class="text-[0.6em] font-black truncate w-full text-center">{{ cat?.name }}</span></button>
                                <button @click="showAddCategory = true" class="category-btn bg-white/40 border border-dashed border-slate-300 active:scale-90 flex items-center justify-center"><i data-lucide="plus" class="w-6 h-6 text-slate-300"></i></button>
                            </div>
                            <div class="flex gap-3 items-center w-full"><div class="w-[30%] shrink-0"><input type="number" v-model="newRecord.amount" class="w-full bg-white p-4 rounded-2xl outline-none font-black text-[1em] border-none shadow-inner text-center" :placeholder="t('amount_ph')"></div><div class="w-[70%] shrink-0"><input type="text" v-model="newRecord.note" class="w-full bg-white p-4 rounded-2xl outline-none font-bold text-[0.85em] border-none shadow-inner" :placeholder="t('note_ph')"></div></div>
                            <button @click="addNewRecord" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-5 rounded-2xl font-black text-[0.85em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_to_list') }}</button>
                        </div>
                    </div>
                    <div v-if="editTab === 'diary'" class="space-y-8 pb-24 px-1 overflow-x-hidden">
                        <div class="flex items-center justify-between bg-slate-50 p-5 rounded-[2.5rem] border border-slate-100"><div class="flex items-center"><div class="w-12 h-12 rounded-2xl bg-white shadow-md flex items-center justify-center mr-4" :class="{'recording-pulse': isRecording}"><i data-lucide="mic" class="w-6 h-6" :class="isRecording ? 'text-red-500' : 'text-p'"></i></div><div class="flex flex-col"><span class="text-xs font-black">{{ isRecording ? t('recording') : (form.audio ? t('recorded') : t('voice_memo')) }}</span><span class="text-[0.6em] text-slate-400 font-bold uppercase tracking-widest">Voice Note</span></div></div><div class="flex gap-2"><button v-if="!isRecording" @click="startRecording" class="p-3 bg-p text-white rounded-xl shadow-lg active:scale-90 transition-all"><i data-lucide="play" class="w-4 h-4 fill-current text-white"></i></button><button v-else @click="stopRecording" class="p-3 bg-red-500 text-white rounded-xl shadow-lg animate-pulse"><i data-lucide="square" class="w-4 h-4 fill-current text-white"></i></button><button v-if="form.audio && !isRecording" @click="playAudio(form.audio)" class="p-3 bg-indigo-100 text-p rounded-xl active:scale-90"><i data-lucide="volume-2" class="w-4 h-4"></i></button></div></div>
                        <div class="space-y-4"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest px-1">{{ t('journal_feeling') }}</label><div class="flex gap-2.5 px-1 overflow-x-auto hide-scrollbar"><button v-for="f in ['üòä','üòî','üò°','ü§©','üò¥','üí™','üç∑','üè¢','‚úàÔ∏è']" :key="f" @click="form.feeling = f" :class="form.feeling === f ? 'scale-125 ring-2 ring-orange-200 bg-white' : 'opacity-40'" class="text-[1.5em] p-2 rounded-xl transition-all">{{ f }}</button></div></div>
                        <div class="space-y-4"><div class="flex justify-between items-center px-1"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('photo') }} ({{ form.photos?.length || 0 }}/10)</label><div class="relative p-3 bg-slate-100 rounded-2xl active:scale-90 transition-all"><i data-lucide="camera" class="w-5 h-5 text-slate-500"></i><input type="file" multiple @change="handleMultiPhotoUpload" class="absolute inset-0 opacity-0 cursor-pointer"></div></div><div v-if="form.photos?.length" class="flex gap-3 overflow-x-auto py-2 hide-scrollbar"><div v-for="(img, idx) in form.photos" :key="idx" class="relative shrink-0"><img :src="img" class="photo-thumb"><button @click="form.photos.splice(idx, 1)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg"><i data-lucide="x" class="w-3 h-3 text-white"></i></button></div></div></div>
                        <div class="space-y-4"><div class="flex justify-between items-center px-1"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('location_map') }}</label><button @click="openGoogleMapsSearch" class="px-5 py-2 bg-indigo-50 text-p rounded-full text-[0.6em] font-black active:scale-90 transition-all border border-indigo-100">{{ t('search_on_map') }}</button></div><div class="flex gap-3"><input v-model="locationSearch" @keyup.enter="addLocation" :placeholder="t('location_ph')" class="flex-1 bg-slate-50 p-4 rounded-2xl text-[0.85em] font-bold outline-none border-2 border-transparent focus:border-p transition-all shadow-inner"><button @click="addLocation" class="bg-p text-white w-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-all"><i data-lucide="plus" class="w-6 h-6 text-white"></i></button></div><div class="space-y-2"><div v-for="(loc, lidx) in form.locations" :key="lidx" class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 card-shadow animate-in slide-in-from-bottom"><div class="flex items-center text-[0.85em] font-black text-indigo-700 cursor-pointer" @click="openGoogleMaps(loc?.name)"><i data-lucide="map-pin" class="w-4 h-4 mr-3 opacity-50"></i><span>{{ loc?.name }}</span></div><button @click="form.locations.splice(lidx, 1)" class="text-red-300 p-2 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>
                        <textarea v-model="form.diaryText" class="w-full h-48 bg-slate-50 p-6 rounded-[2.5rem] border-none outline-none focus:ring-4 ring-indigo-50 shadow-inner text-[0.9em] font-bold leading-relaxed" :placeholder="t('journal_placeholder')"></textarea>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ÊòéÁ¥∞Ë∑≥Á™ó (‰øÆÊ≠£ÔºöÂ∑≤Ë£úÂõû‰∫íÂãïÂáΩÂºè) -->
        <transition name="fade"><div v-if="showCategoryDetailModal" class="fixed inset-0 z-[120] flex items-end justify-center"><div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showCategoryDetailModal = false"></div><div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[85vh] shadow-2xl modal-scrollable overflow-x-hidden" :class="{ 'modal-transition': !isDraggingModal }" :style="modalStyle" @touchstart="handleModalTouchStart" @touchmove="handleModalTouchMove" @touchend="handleModalTouchEnd"><button @click="showCategoryDetailModal = false" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600 transition-colors z-[110]"><i data-lucide="x" class="w-6 h-6"></i></button><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div><div class="flex items-center gap-3 mb-6 px-2"><div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-[1.5em]">{{ selectedCategoryForDetail?.icon || '?' }}</div><h2 class="text-[1.5em] font-black text-slate-800">{{ selectedCategoryForDetail?.name }} {{ t('new_record') }}</h2></div><div class="space-y-4 pb-12"><div v-for="(item, idx) in categoryDetailRecords" :key="idx" @click="jumpToEdit(item.date, item.originalIndex)" class="flex justify-between items-center bg-slate-50 p-4 rounded-[1.5rem] cursor-pointer hover:bg-slate-100 transition-all"><div class="flex flex-col"><span class="text-[0.7em] font-bold text-slate-400 uppercase tracking-widest">{{ item.date }}</span><span class="text-[0.9em] font-black text-slate-700 truncate w-48">{{ item.record.note || '---' }}</span></div><div class="flex items-center gap-4"><span class="font-mono font-black text-[1.1em]" :class="item.record.type==='income'?'text-red-500':'text-green-600'">{{ item.record.type==='income'?'+':'-' }}{{ formatNumber(item.record.amount) }}</span><button @click.stop="deleteSpecificRecord(item.date, item.originalIndex)" class="text-slate-300 hover:text-red-500 transition-colors p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div v-if="categoryDetailRecords.length === 0" class="text-center py-12 text-slate-300 font-bold">ÁõÆÂâçÁÑ°Ê≠§È°ûÂà•Ë≥áÊñô</div></div></div></div></transition>
        <transition name="fade"><div v-if="showEditStockModal" class="fixed inset-0 z-[200] flex items-center justify-center p-6"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showEditStockModal = false"></div><div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in"><h3 class="text-xl font-black mb-6 text-slate-800">Á∑®ËºØÊäïË≥áÈ†ÖÁõÆ</h3><div class="space-y-4"><div class="p-4 bg-slate-50 rounded-2xl"><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1">ËÇ°Á•®ÂêçÁ®±</p><p class="font-black text-p">{{ editingStock?.name || '---' }}</p></div><div class="grid grid-cols-2 gap-3"><div><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1 px-1">ËÇ°Êï∏</p><input v-model.number="editingStock.qty" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-black outline-none shadow-inner text-center"></div><div><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1 px-1">ÊàêÊú¨</p><input v-model.number="editingStock.buyPrice" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-black outline-none shadow-inner text-center"></div></div><div class="flex gap-4 pt-4"><button @click="showEditStockModal = false" class="flex-1 py-4 rounded-2xl font-black text-slate-400">{{ t('cancel') }}</button><button @click="confirmEditStock" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95">Êõ¥Êñ∞</button></div></div></div></div></transition>
        <transition name="fade"><div v-if="showAddCategory || showEditCategory" class="fixed inset-0 z-[200] flex items-center justify-center p-6"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeCategoryModal"></div><div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in"><h3 class="text-[1.25em] font-black mb-8 text-slate-800">{{ showEditCategory ? t('edit_cat_title') : t('custom_cat_title') }}</h3><div class="space-y-8"><div class="grid grid-cols-5 gap-3 max-h-48 overflow-y-auto p-1 hide-scrollbar"><button v-for="ico in iconPool" :key="ico" @click="categoryForm.icon = ico" :class="categoryForm.icon === ico ? 'bg-indigo-100 ring-4 ring-indigo-200' : 'bg-slate-50'" class="text-[1.5em] p-3 rounded-2xl transition-all flex items-center justify-center">{{ ico }}</button></div><input v-model="categoryForm.name" type="text" class="w-full bg-slate-50 p-5 rounded-3xl outline-none font-bold border-none shadow-inner text-[0.9em]" :placeholder="t('cat_name_ph')"><div class="flex gap-4 pt-4"><button @click="closeCategoryModal" class="flex-1 py-5 rounded-2xl font-black text-slate-400 text-[0.8em]">{{ t('cancel') }}</button><button @click="confirmCategoryAction" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 text-[0.8em]">{{ t('confirm') }}</button></div></div></div></div></transition>

        <!-- Â∫ïÈÉ®Â∞éË¶ΩÂàó -->
        <nav class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-slate-100 h-24 tab-bar z-40 px-3 flex items-center shadow-lg shrink-0">
            <div class="flex w-full items-center justify-around"><button v-for="v in ['ledger', 'stocks', 'add', 'charts', 'settings']" :key="v" @click="v === 'add' ? openAddModal() : (currentView = v)" :style="(currentView === v && v !== 'add') ? { color: settings.themeColor } : {}" class="flex flex-col items-center transition-all flex-1" :class="[currentView === v ? 'nav-active scale-110' : 'text-slate-300', v === 'add' ? 'relative' : '']"><template v-if="v === 'add'"><div :style="{ backgroundColor: settings.themeColor }" class="text-white w-16 h-16 rounded-[2.2rem] shadow-xl border-[6px] border-white flex items-center justify-center -translate-y-8 active:scale-90 transition-all hover:rotate-90"><i data-lucide="plus" class="w-8 h-8"></i></div></template><template v-else><i :data-lucide="v === 'ledger' ? 'calendar' : (v === 'stocks' ? 'trending-up' : (v === 'charts' ? 'pie-chart' : 'settings'))" class="w-6 h-6"></i><span class="text-[0.6em] mt-1.5 uppercase font-black tracking-tighter">{{ t(v) }}</span></template></button></div>
        </nav>
    </div>
</div>

<script type="module">
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        const appVersion = "v1.2.4";
        const fb = window.FirebaseSDK;
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = fb.initializeApp(firebaseConfig);
        const auth = fb.getAuth(app);
        const db = fb.getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'lifetrack-pro';
        const apiKey = ""; 

        // Ê†∏ÂøÉÁãÄÊÖã
        const currentYear = ref(new Date().getFullYear());
        const currentMonth = ref(new Date().getMonth());
        const selectedDay = ref(new Date().getDate());
        const currentView = ref('ledger');
        const settings = ref({ lang: 'zh', themeColor: '#4f46e5', fontSize: 'medium' });
        const user = ref(null);
        const isGlobalLoading = ref(true);
        const lastSyncTime = ref('');
        const errorMsg = ref('');

        const showAddModal = ref(false);
        const showCategoryDetailModal = ref(false);
        const showLoginModal = ref(false);
        const showYearPicker = ref(false);
        const showMonthPicker = ref(false);
        const showAddCategory = ref(false);
        const showEditCategory = ref(false);
        const showEditStockModal = ref(false);
        const chartRange = ref('all');
        const chartMode = ref('expense');
        const isAILoading = ref(false);
        const editTab = ref('diary');
        const isRecording = ref(false);
        const locationSearch = ref('');
        const stockSuggestions = ref([]);
        const isDraggingModal = ref(false);
        const touchYStart = ref(0);
        const modalDeltaY = ref(0);

        const editingStock = ref({ name: '', qty: 0, buyPrice: 0 });
        const selectedCategoryForDetail = ref(null);
        const categoryForm = ref({ name: '', icon: 'üç≤' });
        const iconPool = ['üç≤', '‚òï', 'üç∫', 'üç∞', 'üöó', 'üö≤', '‚õΩ', '‚úàÔ∏è', 'üõçÔ∏è', 'üëï', 'üì±', 'üéÆ', 'üé¨', 'üìö', 'üíä', 'ü©∫', 'üè†', ' Couch', 'üêà', 'üê∂', 'üåø', 'üí∞', 'üè¶', 'üíº', 'üéÅ', 'üç∑', 'üö¨', '‚õ™', 'üöï', 'üé†', 'üé®', 'üéª', 'üè∏', 'üõÄ', 'üç£', 'üçº', 'üë∂', 'üêæ', 'üíà', 'üíá', 'üíÑ'];
        
        let targetCategory = null;
        let editingStockIdx = -1;
        let mediaRecorder = null;
        let audioChunks = [];
        let searchTimeout = null;
        let longPressTimer = null;

        const categories = ref([
            { name: 'È§êÈ£≤', icon: 'üç≤', type: 'expense' }, { name: '‰∫§ÈÄö', icon: 'üöó', type: 'expense' },
            { name: 'Ë≥ºÁâ©', icon: 'üõçÔ∏è', type: 'expense' }, { name: 'Â®õÊ®Ç', icon: 'üé¨', type: 'expense' },
            { name: 'Â±ÖÂÆ∂', icon: 'üè†', type: 'expense' }, { name: 'ÈÜ´ÁôÇ', icon: 'üíä', type: 'expense' },
            { name: 'Ëñ™Ë≥á', icon: 'üí∞', type: 'income' }, { name: 'Á¥ÖÂà©', icon: 'üßß', type: 'income' },
            { name: 'ÂÖ∂ÂÆÉ', icon: 'üì¶', type: 'expense' }
        ]);
        const entries = ref({});
        const stockPortfolio = ref([]);
        const form = ref({ records: [], diaryText: '', feeling: 'üòä', photos: [], locations: [], audio: null });
        const newRecord = ref({ type: 'expense', amount: null, category: 'È§êÈ£≤', note: '' });
        const newStock = ref({ name: '', qty: null, buyPrice: null });

        const dictionary = {
            zh: { 
                ledger: 'Â∏≥Êú¨', stocks: 'ËÇ°Â∏ÇÊäïË≥á', charts: 'ÂàÜÊûêÁµ±Ë®à', settings: 'Á≥ªÁµ±Ë®≠ÁΩÆ', add: 'Êñ∞Â¢û',
                year: 'Âπ¥', month: 'Êúà', steps: 'Ê≠•', in_prefix: 'Êî∂', out_prefix: 'ÊîØ', daily_net: 'Áï∂Êó•ÁµêÈ§ò',
                weekdays: ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'],
                daily_finance: 'Áï∂Êó•Ë≤°Âãô', daily_diary: 'ÂøÉÊÉÖÊó•Ë™å', fetching: 'Ë°åÊÉÖÁç≤Âèñ‰∏≠',
                no_data_hint: '‰ªäÂ§©Â∞öÊú™ÊúâÁ¥ÄÈåÑ', balance: 'ÁµêÈ§ò', choose_year: 'ÈÅ∏ÊìáÂπ¥‰ªΩ', choose_month: 'ÈÅ∏ÊìáÊúà‰ªΩ', confirm: 'Á¢∫Ë™ç', cancel: 'ÂèñÊ∂à',
                income: 'Êî∂ÂÖ•', expense: 'ÊîØÂá∫', income_short: 'Êî∂', expense_short: 'ÊîØ',
                stock_name_ph: 'Ëº∏ÂÖ•ÂêçÁ®±Êàñ‰ª£Á¢º (Â¶ÇÔºöÂè∞Á©çÊàñ2330)', stock_qty_ph: 'ËÇ°Êï∏', stock_buy_ph: 'ÊàêÊú¨', add_stock_btn: 'Âä†ÂÖ•Ê∏ÖÂñÆ',
                shares_unit: 'ËÇ°', unrealized_pl: 'Êú™ÂØ¶ÁèæÊêçÁõä', unrealized_pl_short: 'Êú™ÂØ¶Áõä', expense_structure: 'ÊîØÂá∫ÁµêÊßã', income_structure: 'Êî∂ÂÖ•ÁµêÊßã',
                lang_label: 'Ë™ûË®ÄÈÅ∏Êìá', theme_label: 'ÈÖçËâ≤ÊñπÊ°à', font_label: 'ÊñáÂ≠óÂ§ßÂ∞è', new_record: 'Á¥ÄÈåÑË©≥ÊÉÖ', save: '‰øùÂ≠ò',
                font_small: 'Â∞è (0.75x)', font_medium: '‰∏≠ (1.0x)', font_large: 'Â§ß (1.25x)', journal_placeholder: 'ÂàÜ‰∫´‰ªäÂ§©ÁôºÁîüÁöÑ‰∫ã...',
                voice_memo: 'Ë™ûÈü≥ÂÇôÂøò', recorded: 'ÈåÑÈü≥Â∑≤Â≠ò', recording: 'ÈåÑÈü≥‰∏≠', amount_ph: 'ÈáëÈ°ç', note_ph: 'ÂÇôË®ª', add_to_list: 'Âä†ÂÖ•',
                stat_btn: 'Êô∫ÊÖßÁµ±Ë®à', no_diary_text: 'Â∞öÊú™Â°´ÂØ´‰ªäÊó•Êó•Ë™å...', market_value: 'Â∏ÇÂÄº', total_profit: 'ÊêçÁõä',
                photo: 'Áõ∏Áâá', location_map: 'Âú∞Èªû', search_on_map: 'Âú∞Âúñ', location_ph: 'Ëº∏ÂÖ•Âú∞Èªû...', add_new_line: 'Êñ∞Â¢ûÊî∂ÊîØÊòéÁ¥∞', journal_feeling: 'ÊÑüÂèó',
                edit_cat_title: 'Á∑®ËºØÈ°ûÂà•', custom_cat_title: 'Ëá™ÂÆöÁæ©È°ûÂà•', cat_name_ph: 'ÂêçÁ®±',
                account_sync: 'Â∏≥ËôüËàáÂêåÊ≠•', login_start_btn: 'ÈÄ£ÁµêÂ∏≥Ëôü', logout_btn: 'ÁôªÂá∫Â∏≥Ëôü', not_logged_in: 'Â∞öÊú™ÈÄ£ÁµêÂ∏≥Ëôü', sync_hint: 'ÈÄ£Áµê Google Â∏≥ËôüÂæåÔºåÊÇ®ÁöÑÊâÄÊúâÁ¥ÄÈåÑÂ∞áËá™ÂãïÂÇô‰ªΩËá≥Èõ≤Á´Ø„ÄÇ'
            },
            en: { 
                ledger: 'Ledger', stocks: 'Stocks', charts: 'Analysis', settings: 'Settings', add: 'New',
                year: 'Y', month: 'M', steps: 'steps', in_prefix: 'IN', out_prefix: 'OUT', daily_net: 'Net',
                weekdays: ['S','M','T','W','T','F','S'], daily_finance: 'Finance', daily_diary: 'Journal', fetching: 'Updating',
                no_data_hint: 'No data', balance: 'Balance', choose_year: 'Year', choose_month: 'Month', confirm: 'Done', cancel: 'Cancel',
                income: 'Income', expense: 'Expense', income_short: 'IN', expense_short: 'OUT',
                stock_name_ph: 'Name/ID', stock_qty_ph: 'Qty', stock_buy_ph: 'Cost', add_stock_btn: 'Add',
                shares_unit: 'shs', unrealized_pl: 'U-PL', unrealized_pl_short: 'U-PL', expense_structure: 'Expenses', income_structure: 'Income',
                lang_label: 'Language', theme_label: 'Theme', font_label: 'Font', new_record: 'Details', save: 'Save',
                photo: 'Photos', location_map: 'Locations', add_new_line: 'Add Record', journal_feeling: 'Feelings',
                total: 'Total', avg_day: 'Avg/Day', category: 'Category', ratio: 'Ratio',
                font_small: 'Small', font_medium: 'Medium', font_large: 'Large', journal_placeholder: 'What happened today...',
                voice_memo: 'Voice Memo', recorded: 'Recorded', recording: 'Recording', amount_ph: 'Amount', note_ph: 'Note',
                add_to_list: 'Add', stat_btn: 'Smart Stats', no_diary_text: 'No entry yet...', market_value: 'Market Value', total_profit: 'Total Profit',
                search_on_map: 'Map', location_ph: 'Location...', edit_cat_title: 'Edit Category', custom_cat_title: 'Custom Category', cat_name_ph: 'Name',
                account_sync: 'Account & Sync', login_start_btn: 'Link Account', logout_btn: 'Log Out', not_logged_in: 'Not Linked', sync_hint: 'Link Google account to backup data.'
            }
        };

        const t = (key) => {
            const lang = settings.value.lang || 'zh';
            return dictionary[lang]?.[key] || dictionary['zh'][key] || key;
        };

        // --- ÂÖ∑ÂêçÂäüËÉΩÂáΩÂºè ---
        function updateIcons() { nextTick(() => { if(window.lucide) lucide.createIcons(); }); }
        function formatNumber(num) { return Math.floor(num || 0).toLocaleString(); }
        function showError(msg) { errorMsg.value = msg; setTimeout(() => { errorMsg.value = ''; }, 4000); }
        function getCategoryIcon(n) { return categories.value.find(c => c.name === n)?.icon || '‚ùì'; }
        function getPhotoGridClass(c) { return c === 1 ? 'photo-grid-1 h-48' : (c === 2 ? 'photo-grid-2 h-32' : 'photo-grid-3 h-48'); }

        function changeYear(delta) { currentYear.value += delta; }
        function changeMonth(delta) { 
            let nm = currentMonth.value + delta;
            if (nm > 11) { nm = 0; currentYear.value++; } else if (nm < 0) { nm = 11; currentYear.value--; }
            currentMonth.value = nm;
        }
        function changeYearTo(y) { currentYear.value = y; showYearPicker.value = false; showMonthPicker.value = true; }
        function changeMonthTo(m) { currentMonth.value = m; showMonthPicker.value = false; }

        async function syncToCloud() {
            if (!user.value) return;
            try {
                const stateDoc = fb.doc(db, 'artifacts', appId, 'users', user.value.uid, 'appData', 'globalState');
                await fb.setDoc(stateDoc, { entries: JSON.stringify(entries.value), stockPortfolio: stockPortfolio.value, categories: categories.value, settings: settings.value, lastSync: Date.now() });
            } catch (e) { console.error(e); }
        }

        async function loadFromCloud() {
            if (!user.value) return;
            isGlobalLoading.value = true;
            try {
                const stateDoc = fb.doc(db, 'artifacts', appId, 'users', user.value.uid, 'appData', 'globalState');
                const snap = await fb.getDoc(stateDoc);
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.entries) entries.value = JSON.parse(data.entries);
                    if (data.stockPortfolio) stockPortfolio.value = data.stockPortfolio;
                    if (data.categories) categories.value = data.categories;
                    if (data.settings) settings.value = data.settings;
                }
            } catch (e) { showError("ËÆÄÂèñÈõ≤Á´ØÂ§±Êïó"); }
            isGlobalLoading.value = false;
        }

        async function handleGoogleLogin() {
            showLoginModal.value = false;
            setTimeout(async () => {
                isGlobalLoading.value = true;
                try {
                    const provider = new fb.GoogleAuthProvider();
                    provider.setCustomParameters({ prompt: 'select_account' });
                    await fb.signInWithPopup(auth, provider);
                } catch (e) {
                    if (e.code === 'auth/popup-blocked') showError("ÁôªÂÖ•Ë¶ñÁ™óË¢´ÊîîÊà™");
                    else if (e.code !== 'auth/popup-closed-by-user') showError("ÈÄ£ÁµêÂ§±Êïó");
                } finally { isGlobalLoading.value = false; }
            }, 100);
        }

        async function handleLogout() {
            await fb.signOut(auth);
            user.value = null; entries.value = {}; stockPortfolio.value = [];
        }

        // --- ‰øÆÊ≠£ËàáË£úÂõûÁöÑÊ†∏ÂøÉÂáΩÂºè ---
        function getRecordsByCategory(catName) {
            const results = [];
            Object.keys(entries.value).forEach(dateKey => {
                const dailyRecs = entries.value[dateKey].records || [];
                dailyRecs.forEach((r, idx) => {
                    if (r.category === catName && r.type === chartMode.value) results.push({ date: dateKey, record: r, originalIndex: idx });
                });
            });
            return results.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function jumpToCategoryDetails(catName) {
            const cat = categories.value.find(c => c.name === catName);
            if (cat) selectedCategoryForDetail.value = cat;
            showCategoryDetailModal.value = true; updateIcons();
        }

        function jumpToEdit(dateStr, index) {
            const [y, m, d] = dateStr.split('-').map(Number);
            currentYear.value = y; currentMonth.value = m - 1; selectedDay.value = d;
            showCategoryDetailModal.value = false; openAddModal('finance');
        }

        async function deleteSpecificRecord(dateStr, index) {
            if (entries.value[dateStr]) {
                entries.value[dateStr].records.splice(index, 1);
                updateIcons(); await syncToCloud();
            }
        }

        async function updatePortfolioPrices() {
            if (!stockPortfolio.value.length) return;
            isAILoading.value = true;
            try {
                const syms = stockPortfolio.value.map(s => s.name).join(', ');
                const sys = `‰Ω†ÊòØ‰∏Ä‰ΩçÂ∞àÊ•≠ÁöÑÂè∞ËÇ°Âä©ÁêÜ„ÄÇÊêúÂ∞ã Google ‰∏¶ÂèÉËÄÉ Yahoo ËÇ°Â∏ÇÂè∞ÁÅ£ Êàñ TWSE/TPEx ÂÆòÊñπË≥áË®ä„ÄÇ
                ÁõÆÊ®ôÔºöÂèñÂæóÈÄôÂπæÊ™îËÇ°Á•®ÁöÑÊúÄÊñ∞„ÄéÊàê‰∫§ÂÉπ„Äè(Trade Price)Ôºö${syms}„ÄÇ
                Ê†ºÂºèË¶ÅÊ±ÇÔºöÂÉÖÂõûÂÇ≥ JSON ‰æãÂ¶Ç {"2330": 1050, "6547": 155}„ÄÇÊ≥®ÊÑèÂçÄÂàÜ‰∏äÂ∏ÇËàá‰∏äÊ´ÉËÇ°Á¢º„ÄÇ`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ÂèñÂæóÂè∞ËÇ°Âç≥ÊôÇÊàê‰∫§ÂÉπÔºö${syms}` }] }], systemInstruction: { parts: [{ text: sys }] }, tools: [{ "google_search": {} }] })
                });
                const d = await res.json();
                const text = d.candidates?.[0]?.content?.parts?.[0]?.text;
                const match = text?.match(/\{[\s\S]*\}/);
                if (match) {
                    const priceMap = JSON.parse(match[0]);
                    stockPortfolio.value.forEach(stk => {
                        const id = stk.name.match(/\d{4,}/)?.[0] || stk.name;
                        const matchKey = Object.keys(priceMap).find(k => k.includes(id) || id.includes(k));
                        if (matchKey) stk.currentPrice = Number(priceMap[matchKey]);
                    });
                    lastSyncTime.value = new Date().toLocaleTimeString(); await syncToCloud();
                } else { showError("Ë°åÊÉÖÊö´ÊôÇÁÑ°Ê≥ïÊõ¥Êñ∞"); }
            } catch (e) { showError("Ë°åÊÉÖÁç≤ÂèñÂ§±Êïó"); }
            isAILoading.value = false;
        }

        function addNewRecord() { if (newRecord.value.amount) { form.value.records.unshift({ ...newRecord.value }); newRecord.value.amount = null; newRecord.value.note = ''; } }
        async function saveRecord() {
            entries.value[currentDayKey.value] = JSON.parse(JSON.stringify(form.value));
            showAddModal.value = false; updateIcons(); await syncToCloud();
        }
        function openAddModal(tab = 'diary') {
            editTab.value = tab;
            form.value = entries.value[currentDayKey.value] ? JSON.parse(JSON.stringify(entries.value[currentDayKey.value])) : { records: [], diaryText: '', feeling: 'üòä', photos: [], locations: [], audio: null };
            showAddModal.value = true; updateIcons();
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            if (!newStock.value.name) { stockSuggestions.value = []; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const sys = `Lookup TWSE codes. Return JSON: [{"name": "Âè∞Á©çÈõª", "id": "2330"}]. Key: ${newStock.value.name}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Search ${newStock.value.name}` }] }], systemInstruction: { parts: [{ text: sys }] }, tools: [{ "google_search": {} }] })
                    });
                    const d = await res.json();
                    const match = d.candidates?.[0]?.content?.parts?.[0]?.text?.match(/\[[\s\S]*\]/);
                    if (match) stockSuggestions.value = JSON.parse(match[0]);
                } catch (e) {}
            }, 800);
        }

        function selectStockSuggestion(sug) { newStock.value.name = `${sug.name}(${sug.id})`; stockSuggestions.value = []; }
        function startStockLongPress(stk, idx) { longPressTimer = setTimeout(() => { editingStock.value = { ...stk }; editingStockIdx = idx; showEditStockModal.value = true; }, 800); }
        function endStockLongPress() { clearTimeout(longPressTimer); }
        async function confirmEditStock() { if (editingStockIdx !== -1) stockPortfolio.value[editingStockIdx] = { ...editingStock.value }; showEditStockModal.value = false; await syncToCloud(); }
        function startCategoryLongPress(cat) { longPressTimer = setTimeout(() => { targetCategory = cat; categoryForm.value = { ...cat }; showEditCategory.value = true; }, 800); }
        function endCategoryLongPress() { clearTimeout(longPressTimer); }
        function closeCategoryModal() { showAddCategory.value = false; showEditCategory.value = false; categoryForm.value = { name: '', icon: 'üç≤' }; }
        async function confirmCategoryAction() { 
            if (!categoryForm.value.name.trim()) return; 
            if (showEditCategory.value && targetCategory) { targetCategory.name = categoryForm.value.name.trim(); targetCategory.icon = categoryForm.value.icon; } 
            else { categories.value.push({ name: categoryForm.value.name.trim(), icon: categoryForm.value.icon, type: newRecord.value.type }); } 
            closeCategoryModal(); await syncToCloud();
        }

        function handleMultiPhotoUpload(e) { Array.from(e.target.files).slice(0, 10).forEach(file => { const reader = new FileReader(); reader.onload = (f) => form.value.photos.push(f.target.result); reader.readAsDataURL(file); }); }
        function addLocation() { if (locationSearch.value.trim()) { form.value.locations.push({ name: locationSearch.value.trim() }); locationSearch.value = ''; updateIcons(); } }
        function openGoogleMapsSearch() { window.open(`https://www.google.com/maps`, '_blank'); }
        function openGoogleMaps(n) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank'); }
        async function startRecording() { const s = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(s); mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data); mediaRecorder.onstop = () => { const b = new Blob(audioChunks, { type: 'audio/webm' }); const r = new FileReader(); r.onload = (x) => form.value.audio = x.target.result; r.readAsDataURL(b); audioChunks = []; }; mediaRecorder.start(); isRecording.value = true; }
        function stopRecording() { if (mediaRecorder) { mediaRecorder.stop(); isRecording.value = false; } }
        function playAudio(u) { new Audio(u).play(); }

        function handleModalTouchStart(e) { if (e.currentTarget.scrollTop <= 0) { touchYStart.value = e.touches[0].clientY; isDraggingModal.value = true; } }
        function handleModalTouchMove(e) { if (isDraggingModal.value) { const d = e.touches[0].clientY - touchYStart.value; if (d > 0) { modalDeltaY.value = d; if (e.cancelable) e.preventDefault(); } else isDraggingModal.value = false; } }
        function handleModalTouchEnd() { if (modalDeltaY.value > 150) { showAddModal.value = false; showCategoryDetailModal.value = false; } modalDeltaY.value = 0; isDraggingModal.value = false; }

        async function addStockItem() { 
            if (newStock.value.name) { 
                stockPortfolio.value.push({ name: newStock.value.name, qty: newStock.value.qty || 0, buyPrice: newStock.value.buyPrice || 0, currentPrice: newStock.value.buyPrice || 0 }); 
                newStock.value = { name: '', qty: null, buyPrice: null }; updateIcons(); await syncToCloud();
            } 
        }

        // --- 4. Ë®àÁÆóÂ±¨ÊÄß (ÂÆöÁæ©Âú® function ‰πãÂæå) ---
        const yearRange = computed(() => { const y = new Date().getFullYear(); return Array.from({length: 12}, (_, i) => y - 5 + i); });
        const daysInMonth = computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate());
        const firstDayOfMonth = computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay());
        const currentDayKey = computed(() => `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`);
        const currentDayData = computed(() => entries.value[currentDayKey.value]);
        const selectedDateString = computed(() => `${currentYear.value}Âπ¥ ${currentMonth.value + 1}Êúà ${selectedDay.value}Êó•`);
        const currentCategories = computed(() => categories.value.filter(c => c.type === newRecord.value.type || !c.type));
        const categoryDetailRecords = computed(() => selectedCategoryForDetail.value ? getRecordsByCategory(selectedCategoryForDetail.value.name) : []);

        const dayTotalIncome = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'income').reduce((a, b) => a + (b.amount || 0), 0));
        const dayTotalExpense = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'expense').reduce((a, b) => a + (b.amount || 0), 0));
        const dayNetBalance = computed(() => dayTotalIncome.value - dayTotalExpense.value);

        const allDataTotals = computed(() => {
            let inc = 0, exp = 0;
            Object.values(entries.value).forEach(e => { (e.records || []).forEach(r => { if (r.type === 'income') inc += (r.amount || 0); else exp += (r.amount || 0); }); });
            return { income: inc, expense: exp, net: inc - exp };
        });

        const stockTotalValue = computed(() => stockPortfolio.value.reduce((s, x) => s + ((x.currentPrice || x.buyPrice) * x.qty), 0));
        const stockTotalProfit = computed(() => stockPortfolio.value.reduce((s, x) => s + (((x.currentPrice || x.buyPrice) - x.buyPrice) * x.qty), 0));

        const chartCategories = computed(() => {
            const totals = {};
            const colors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#9B59B6', '#F39C12', '#1ABC9C', '#E67E22', '#3498DB', '#7F8C8D'];
            Object.keys(entries.value).forEach(dateKey => {
                (entries.value[dateKey].records || []).forEach(r => { if (r.type === chartMode.value) totals[r.category] = (totals[r.category] || 0) + r.amount; });
            });
            return Object.keys(totals).map(n => ({ name: n, value: totals[n] })).sort((a, b) => b.value - a.value).map((item, i) => ({ ...item, color: colors[i % colors.length] }));
        });

        const chartTotalValue = computed(() => chartCategories.value.reduce((a, b) => a + b.value, 0) || 0);
        const pieGradient = computed(() => {
            const total = chartTotalValue.value;
            if (total <= 0) return '#f1f5f9';
            let offset = 0;
            const parts = chartCategories.value.map(cat => {
                const p = (cat.value / total) * 100;
                const part = `${cat.color} ${offset}% ${offset + p}%`;
                offset += p; return part;
            });
            return `conic-gradient(${parts.join(', ')})`;
        });

        const modalStyle = computed(() => { 
            if (!isDraggingModal.value && modalDeltaY.value === 0) return {}; 
            return { 
                transform: `translateY(${modalDeltaY.value}px) scale(${Math.max(0.85, 1 - modalDeltaY.value/2500)})`, 
                opacity: Math.max(0.7, 1 - modalDeltaY.value/1000), 
                transformOrigin: 'bottom center' 
            }; 
        });

        // --- 6. ÁîüÂëΩÈÄ±Êúü ---
        onMounted(() => {
            updateIcons();
            fb.onAuthStateChanged(auth, (u) => {
                user.value = u;
                if (u) loadFromCloud();
                else isGlobalLoading.value = false;
            });
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                fb.signInWithCustomToken(auth, __initial_auth_token).catch(() => { isGlobalLoading.value = false; });
            } else isGlobalLoading.value = false;
        });

        watch([currentView, showAddModal, settings, editTab, chartRange, chartMode, showCategoryDetailModal, showLoginModal], () => updateIcons());

        return {
            currentView, showAddModal, showYearPicker, showMonthPicker, showAddCategory, showEditCategory, showEditStockModal, showCategoryDetailModal, showLoginModal,
            yearRange, chartRange, chartMode, t, settings, currentYear, currentMonth, selectedDay, daysInMonth, firstDayOfMonth, selectedDateString, version: appVersion, stockSuggestions, debouncedSearch,
            getDayEntries: (d) => { const k = `${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const e = entries.value[k]; return { hasDiary: !!(e?.diaryText || e?.photos?.length || e?.audio), hasFinance: !!(e?.records?.length) }; },
            form, saveRecord, openAddModal, allDataTotals, formatNumber, chartCategories, chartTotalValue, pieGradient, dayNetBalance, dayTotalIncome, dayTotalExpense, editTab, newRecord, currentCategories, errorMsg, editingStock, addNewRecord, getCategoryIcon, iconPool, categoryForm, confirmCategoryAction, closeCategoryModal, startCategoryLongPress, endCategoryLongPress, startStockLongPress, endStockLongPress, confirmEditStock,
            stockPortfolio, newStock, addStockItem, updatePortfolioPrices, stockTotalValue, stockTotalProfit, isAILoading, lastSyncTime,
            handleModalTouchStart, handleModalTouchMove, handleModalTouchEnd, isDraggingModal, modalStyle,
            handleMultiPhotoUpload, addLocation, locationSearch, openGoogleMaps, openGoogleMapsSearch, startRecording, stopRecording, playAudio, isRecording, selectStockSuggestion, getPhotoGridClass, changeYear, changeMonth, currentDayData,
            selectedCategoryForDetail, categoryDetailRecords, jumpToCategoryDetails, jumpToEdit, deleteSpecificRecord,
            user, handleGoogleLogin, handleLogout, isGlobalLoading, changeYearTo, changeMonthTo
        };
    }
}).mount('#app');
</script>
</body>
</html>
