<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeTrack - å°ˆæ¥­ AI æ—¥èªŒèˆ‡å®˜æ–¹è‚¡å¸‚è¨˜å¸³</title>
    <!-- å¼•å…¥ Vue 3, Tailwind CSS èˆ‡ Lucide åœ–ç¤ºåº« -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none; }
        :root { --p-color: #4f46e5; }
        
        /* åŸºç¤ä½ˆå±€èˆ‡é–å®šç¸®æ”¾é¸å– */
        .app-container { height: 100dvh; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background-color: #f1f5f9;
        }

        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .text-p { color: var(--p-color) !important; }
        .bg-p { background-color: var(--p-color) !important; }
        .border-p { border-color: var(--p-color) !important; }
        .ring-p { --tw-ring-color: var(--p-color) !important; }

        /* æ–‡å­—å¤§å°ç¸®æ”¾ç³»çµ± */
        .app-font-small { font-size: 12px; }
        .app-font-medium { font-size: 16px; }
        .app-font-large { font-size: 20px; }
        
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .safe-pb { padding-bottom: calc(8.5rem + env(safe-area-inset-bottom)); }

        /* ç”œç”œåœˆåœ– (Donut Chart) - ä¿®æ­£è‰²å½©é¡¯ç¤ºå•é¡Œ */
        .pie-chart-flat {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            /* ä¿®æ­£ï¼šç”± var ç›´æ¥æ¥æ”¶å®Œæ•´çš„ gradient å­—ä¸² */
            background: var(--gradient, #f1f5f9); 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pie-hole {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 155px; height: 155px;
            background-color: #ffffff;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }

        /* ç…§ç‰‡ç¸®åœ– */
        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .modal-scrollable {
            touch-action: pan-y;
            overflow-x: hidden;
            overflow-y: auto;
            will-change: transform, opacity;
        }
        .modal-transition {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 1.25rem;
            transition: all 0.2s;
            overflow: hidden;
        }
        .nav-active { font-weight: 900; }
        
        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        .version-watermark {
            position: absolute;
            bottom: 110px;
            left: 0;
            right: 0;
            text-align: center;
            color: #94a3b8;
            font-size: 10px;
            font-weight: 900;
            opacity: 0.4;
            pointer-events: none;
            letter-spacing: 2px;
        }
        .slide-down-enter-active, .slide-down-leave-active { transition: all 0.3s ease; }
        .slide-down-enter-from, .slide-down-leave-to { transform: translateY(-100%); opacity: 0; }
        
        .photo-grid-1 { grid-template-columns: 1fr; }
        .photo-grid-2 { grid-template-columns: 1fr 1fr; }
        .photo-grid-3 { grid-template-areas: "a b" "a c"; grid-template-columns: 1.5fr 1fr; }
    </style>
</head>
<body class="antialiased overflow-hidden text-slate-900">

<div id="app" v-cloak class="flex justify-center items-center app-container" :style="{'--p-color': settings.themeColor}">
    <div :class="['w-full sm:max-w-md h-full bg-slate-50 shadow-2xl relative flex flex-col overflow-hidden transition-all duration-300', 'app-font-' + settings.fontSize]">
        
        <!-- é€šçŸ¥åˆ— -->
        <transition name="slide-down">
            <div v-if="errorMsg" class="absolute top-0 left-0 right-0 z-[100] bg-red-500 text-white py-3 px-6 text-center font-black text-xs shadow-xl flex items-center justify-center gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                {{ errorMsg }}
            </div>
        </transition>

        <!-- æ¨™é¡Œå€åŸŸ -->
        <header :style="{ backgroundColor: settings.themeColor }" class="p-4 text-white shadow-md shrink-0 z-50 transition-all duration-500">
            <div v-if="currentView === 'ledger'" class="space-y-2">
                <div class="flex items-center justify-between">
                    <button @click="changeYear(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showYearPicker = true" class="text-lg font-black tracking-widest cursor-pointer active:opacity-70">{{ currentYear }} {{ t('year') }}</span>
                    <button @click="changeYear(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="flex items-center justify-between">
                    <button @click="changeMonth(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showMonthPicker = true" class="text-xl font-black tracking-widest cursor-pointer active:opacity-70">{{ currentMonth + 1 }} {{ t('month') }}</span>
                    <button @click="changeMonth(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div v-else class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
                        <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="white" stroke-width="2.5"/>
                        <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="12" cy="12" r="3" fill="white" fill-opacity="0.3"/>
                    </svg>
                    <h1 class="font-black tracking-tight" style="font-size: 1.3em">{{ t(currentView) }}</h1>
                </div>
                <div @click="showYearPicker = true" class="text-right cursor-pointer active:opacity-60 bg-white/10 px-3 py-1 rounded-xl backdrop-blur-sm border border-white/10">
                    <p class="text-[0.6em] font-bold opacity-70">{{ currentYear }}{{ t('year') }}</p>
                    <p class="text-[1.1em] font-black leading-none">{{ currentMonth + 1 }}{{ t('month') }}</p>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 safe-pb relative">
            
            <!-- å¹´æœˆé¸æ“‡å½ˆçª— -->
            <div v-if="showYearPicker || showMonthPicker" class="absolute inset-0 z-[60] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showYearPicker = false; showMonthPicker = false"></div>
                <div class="relative w-full max-w-xs bg-white rounded-[2.5rem] p-6 shadow-2xl animate-in zoom-in duration-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-black text-slate-400 text-xs uppercase tracking-widest">{{ showYearPicker ? t('choose_year') : t('choose_month') }}</h3>
                        <div class="flex gap-2">
                            <button @click="showYearPicker = true; showMonthPicker = false" :class="showYearPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                            <button @click="showMonthPicker = true; showYearPicker = false" :class="showMonthPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="layers" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="picker-grid max-h-60 overflow-y-auto hide-scrollbar">
                        <template v-if="showYearPicker">
                            <button v-for="y in yearRange" :key="y" @click="currentYear = y; showYearPicker = false; showMonthPicker = true" 
                                :class="currentYear === y ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ y }}</button>
                        </template>
                        <template v-if="showMonthPicker">
                            <button v-for="m in 12" :key="m" @click="currentMonth = m-1; showMonthPicker = false" 
                                :class="currentMonth === m-1 ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ m }}{{ t('month') }}</button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- åˆ†é ï¼šå¸³æœ¬ (ç´…æ”¶ç¶ æ”¯) -->
            <section v-if="currentView === 'ledger'" class="animate-in fade-in duration-300">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="calendar-grid text-center text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">
                        <div v-for="d in t('weekdays')" :key="d">{{ d }}</div>
                    </div>
                    <div class="calendar-grid gap-1">
                        <div v-for="empty in firstDayOfMonth" :key="'e'+empty"></div>
                        <div v-for="day in daysInMonth" :key="day" @click="selectedDay = day"
                            :style="selectedDay === day ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                            class="p-2 text-center rounded-xl cursor-pointer transition relative aspect-square flex flex-col items-center justify-center hover:bg-slate-100"
                            :class="selectedDay === day ? 'shadow-lg scale-105 z-10 font-black' : ''"
                        >
                            <span class="text-[0.85em] font-bold">{{ day }}</span>
                            <div class="flex gap-0.5 mt-0.5">
                                <div v-if="getDayEntries(day).hasDiary" :class="selectedDay === day ? 'bg-white' : 'bg-blue-400'" class="w-1 h-1 rounded-full"></div>
                                <div v-if="getDayEntries(day).hasFinance" :class="selectedDay === day ? 'bg-white' : 'bg-green-400'" class="w-1 h-1 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-4">
                    <h3 class="text-[0.75em] font-black text-slate-400 uppercase tracking-wider px-1">{{ selectedDateString }}</h3>
                    <div v-if="currentDayData" class="space-y-4">
                        <div @click="openAddModal('finance')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between mb-4 border-b border-slate-50 pb-2">
                                <div class="flex items-center gap-2"><i data-lucide="circle-dollar-sign" class="w-4 h-4 text-p"></i><span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_finance') }}</span></div>
                                <span class="text-[0.7em] font-bold text-slate-300">#{{ currentDayData?.records?.length || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-red-50 flex items-center justify-center text-red-600 font-black"><i data-lucide="arrow-down-left" class="w-3 h-3"></i></div><span class="text-[0.95em] font-black text-red-600 font-mono">+{{ formatNumber(dayTotalIncome) }}</span></div>
                                    <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-green-50 flex items-center justify-center text-green-600 font-black"><i data-lucide="arrow-up-right" class="w-3 h-3"></i></div><span class="text-[0.95em] font-black text-green-600 font-mono">-{{ formatNumber(dayTotalExpense) }}</span></div>
                                </div>
                                <div class="text-right"><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1">{{ t('daily_net') }}</p><div :class="dayNetBalance >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[1.8em] font-black font-mono tracking-tighter leading-none">{{ dayNetBalance >= 0 ? '+' : '' }}{{ formatNumber(dayNetBalance) }}</div></div>
                            </div>
                        </div>

                        <div @click="openAddModal('diary')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 space-y-3 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between border-b border-slate-50 pb-2"><div class="flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4 text-orange-400"></i><span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_diary') }}</span></div><div class="text-[1.2em]">{{ currentDayData?.feeling || 'ğŸ˜Š' }}</div></div>
                            <div v-if="currentDayData?.photos?.length" class="grid gap-1 overflow-hidden rounded-xl" :class="getPhotoGridClass(currentDayData.photos.length)"><img v-for="(img, idx) in currentDayData.photos.slice(0, 3)" :key="idx" :src="img" class="w-full h-full object-cover min-h-[80px]"></div>
                            <p class="text-[0.9em] text-slate-600 leading-relaxed truncate">{{ currentDayData?.diaryText || t('no_diary_text') }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åˆ†é ï¼šè‚¡å¸‚æŠ•è³‡ (ç´…æ¼²ç¶ è·Œ) -->
            <section v-if="currentView === 'stocks'" class="p-6 space-y-6 animate-in fade-in">
                <div class="bg-slate-900 text-white p-7 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10 space-y-5 text-center">
                        <div class="flex justify-between items-center border-b border-white/10 pb-5">
                            <div class="flex-1"><p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('market_value') }}</p><p class="text-xl font-black font-mono tracking-tighter">${{ formatNumber(stockTotalValue) }}</p></div>
                            <div class="w-px h-8 bg-white/10 mx-2"></div>
                            <div class="flex-1"><p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('total_profit') }}</p><p :class="stockTotalProfit >= 0 ? 'text-red-400' : 'text-green-400'" class="text-xl font-black font-mono tracking-tighter">{{ stockTotalProfit >= 0 ? '+' : '' }}{{ formatNumber(stockTotalProfit) }}</p></div>
                        </div>
                        <button @click="updatePortfolioPrices" :disabled="isAILoading" class="w-full py-3 bg-white/10 rounded-2xl font-black text-[0.75em] flex items-center justify-center gap-2 active:scale-95 transition-all"><i v-if="isAILoading" data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>{{ isAILoading ? t('fetching') : t('stat_btn') }}</button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(stk, idx) in stockPortfolio" :key="idx" class="bg-white p-4 rounded-3xl border border-slate-100 card-shadow flex justify-between items-center transition-all cursor-pointer" @touchstart="startStockLongPress(stk, idx)" @touchend="endStockLongPress" @mousedown="startStockLongPress(stk, idx)" @mouseup="endStockLongPress">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center mr-4 text-[1.25em] font-bold text-p shadow-inner">{{ stk?.name?.[0] || '?' }}</div>
                            <div class="min-w-0 flex-1"><p class="text-sm font-black text-slate-800 truncate pr-2">{{ stk?.name || '---' }}</p><p class="text-[0.6em] text-slate-400 font-bold uppercase mt-1">{{ stk?.qty }} {{ t('shares_unit') }} Â· cost - {{ formatNumber(stk?.buyPrice) }}</p></div>
                        </div>
                        <div class="flex items-center gap-4 text-right shrink-0">
                            <div><p :class="((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[0.9em] font-black font-mono">{{ ((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) >= 0 ? '+' : '' }}{{ formatNumber(((stk?.currentPrice || 0) - (stk?.buyPrice || 0)) * (stk?.qty || 0)) }}</p><p class="text-[0.55em] text-slate-400 font-bold uppercase">ç¾åƒ¹: {{ stk?.currentPrice || '---' }}</p></div>
                            <button @click.stop="stockPortfolio.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-6 bg-white rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4 relative">
                        <div class="relative">
                            <input v-model="newStock.name" @input="debouncedSearch" type="text" class="bg-slate-50 w-full p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner" :placeholder="t('stock_name_ph')">
                            <div v-if="stockSuggestions.length" class="absolute left-0 right-0 top-full mt-2 bg-white rounded-2xl shadow-2xl border border-slate-100 z-[100] max-h-60 overflow-y-auto hide-scrollbar">
                                <div v-for="sug in stockSuggestions" :key="sug.id" @click="selectStockSuggestion(sug)" class="suggestion-item cursor-pointer hover:bg-slate-50">
                                    <div class="flex justify-between items-center"><span class="text-sm font-black">{{ sug.name }}</span><span class="text-xs font-bold text-slate-400">{{ sug.id }}</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model.number="newStock.qty" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_qty_ph')">
                            <input v-model.number="newStock.buyPrice" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_buy_ph')">
                        </div>
                        <button @click="addStockItem" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-4 rounded-2xl font-black text-[0.8em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_stock_btn') }}</button>
                    </div>
                </div>
            </section>

            <!-- åˆ†é ï¼šåˆ†æçµ±è¨ˆ (ç”œç”œåœˆåœ–) -->
            <section v-if="currentView === 'charts'" class="p-6 space-y-8 animate-in fade-in text-center text-slate-700">
                <div class="bg-white p-4 rounded-[2rem] card-shadow border border-slate-50 flex items-center justify-between transition-all overflow-hidden gap-1">
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-red-600 uppercase mb-0.5 truncate">{{ t('income_short') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.income) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-green-600 uppercase mb-0.5 truncate">{{ t('expense_short') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.expense) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-indigo-500 uppercase mb-0.5 truncate">{{ t('balance') }}</p><p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.net) }}</p></div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0"><p class="text-[0.5em] font-black text-orange-500 uppercase mb-0.5 truncate">{{ t('unrealized_pl_short') }}</p><p :class="stockTotalProfit >= 0 ? 'text-red-600' : 'text-green-600'" class="text-[0.75em] font-black truncate">${{ formatNumber(stockTotalProfit) }}</p></div>
                </div>

                <div class="bg-white p-8 rounded-[3rem] card-shadow flex flex-col items-center border border-slate-50 overflow-hidden">
                    <div class="flex justify-between items-center w-full mb-8 px-2">
                        <h4 class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ chartMode === 'expense' ? t('expense_structure') : t('income_structure') }}</h4>
                        <div class="flex bg-slate-50 p-1 rounded-full text-[0.6em] font-black border border-slate-100 overflow-hidden">
                            <button @click="chartMode = 'expense'" :class="chartMode === 'expense' ? 'bg-green-600 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('expense_short') }}</button>
                            <button @click="chartMode = 'income'" :class="chartMode === 'income' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('income_short') }}</button>
                        </div>
                    </div>
                    
                    <!-- ç”œç”œåœˆåœ–ä¸»é«” -->
                    <div class="pie-chart-flat" :style="{ '--gradient': pieGradient }">
                        <div class="pie-hole">
                            <p class="text-[0.5em] text-slate-400 font-black uppercase tracking-widest mb-1">{{ chartMode === 'expense' ? t('expense') : t('income') }}</p>
                            <p class="text-[1.25rem] font-black leading-tight" :class="chartMode === 'expense' ? 'text-green-600' : 'text-red-500'">${{ formatNumber(chartTotalValue) }}</p>
                        </div>
                    </div>

                    <!-- é¡åˆ¥æ˜ç´°åˆ— -->
                    <div class="w-full mt-10 space-y-2">
                        <template v-for="(cat, cidx) in chartCategories" :key="cat.name">
                             <div @click="jumpToCategoryDetails(cat.name)" class="group flex items-center p-3 rounded-[1.25rem] bg-white hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all cursor-pointer">
                                <div class="w-8 text-center text-[0.7em] font-black text-slate-300">{{ cidx + 1 }}</div>
                                <div class="w-4 h-4 rounded-full mr-3 shrink-0 shadow-sm" :style="{backgroundColor: cat.color}"></div>
                                <div class="flex flex-col min-w-0 flex-1 text-left">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[0.9em] font-black text-slate-700 truncate">{{ cat.name }}</span>
                                        <span class="text-[0.8em] font-black" :class="chartMode==='expense'?'text-green-600':'text-red-500'">${{ formatNumber(cat.value) }}</span>
                                    </div>
                                    <div class="h-1.5 bg-slate-100 rounded-full w-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-700" :style="{ width: (cat.value / chartTotalValue * 100) + '%', backgroundColor: cat.color }"></div>
                                    </div>
                                </div>
                                <div class="w-10 text-right">
                                    <span class="text-[0.65em] font-bold text-slate-400">{{ chartTotalValue > 0 ? Math.round((cat.value / chartTotalValue) * 100) : 0 }}%</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 ml-1 group-hover:text-slate-400 transition-colors"></i>
                            </div>
                        </template>
                        <div v-if="chartCategories.length === 0" class="py-12 opacity-30 text-center font-black text-xs">ç›®å‰ç„¡è³‡æ–™</div>
                    </div>
                </div>
            </section>
            
            <!-- è¨­å®šåˆ†é  -->
            <section v-if="currentView === 'settings'" class="p-6">
                <div class="bg-white rounded-[2.5rem] p-8 card-shadow space-y-8 transition-all">
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('lang_label') }}</span>
                        <select v-model="settings.lang" class="bg-slate-50 rounded-xl px-4 py-3 font-black text-[0.7em] outline-none border-none ring-1 ring-slate-100"><option value="zh">ç¹é«”ä¸­æ–‡</option><option value="en">English</option></select>
                    </div>
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('theme_label') }}</span>
                        <div class="flex gap-3"><div v-for="color in ['#4f46e5', '#10b981', '#f43f5e', '#1e293b', '#f59e0b']" @click="settings.themeColor = color" :style="{ backgroundColor: color }" class="w-8 h-8 rounded-full cursor-pointer border-2 shadow-md active:scale-75 transition-all" :class="settings.themeColor === color ? 'border-white ring-2 ring-indigo-200 scale-125' : 'border-transparent'"></div></div>
                    </div>
                    <div class="flex justify-between items-center"><span class="text-[0.9em] font-black text-slate-700">{{ t('font_label') }}</span>
                        <div class="flex bg-slate-50 p-1 rounded-xl ring-1 ring-slate-100 overflow-hidden"><button v-for="sz in ['small', 'medium', 'large']" :key="sz" @click="settings.fontSize = sz" :style="settings.fontSize === sz ? { backgroundColor: settings.themeColor, color: 'white' } : {}" class="px-4 py-2 text-[0.65em] font-black rounded-lg transition-all">{{ t('font_' + sz) }}</button></div>
                    </div>
                </div>
                <div class="version-watermark">{{ version }}</div>
            </section>
        </main>

        <!-- æ–°å¢/ç·¨è¼¯è¦–çª— -->
        <transition name="fade">
            <div v-if="showAddModal" class="fixed inset-0 z-[100] flex items-end justify-center">
                <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showAddModal = false"></div>
                <div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[96vh] shadow-2xl modal-scrollable overflow-x-hidden" :class="{ 'modal-transition': !isDraggingModal }" :style="modalStyle" @touchstart="handleModalTouchStart" @touchmove="handleModalTouchMove" @touchend="handleModalTouchEnd">
                    <button @click="showAddModal = false" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600 transition-colors z-[110]"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div>
                    <div class="flex justify-between items-center mb-6 px-1"><h2 class="text-[1.3em] font-black text-slate-800">{{ currentMonth+1 }}/{{ selectedDay }} {{ t('new_record') }}</h2><button @click="saveRecord" :style="{ backgroundColor: settings.themeColor }" class="text-white px-10 py-3 rounded-full font-black shadow-xl active:scale-95 transition-all text-[0.8em] mr-8">{{ t('save') }}</button></div>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8"><button @click="editTab = 'diary'" :class="editTab === 'diary' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'diary' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_diary') }}</button><button @click="editTab = 'finance'" :class="editTab === 'finance' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'finance' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_finance') }}</button></div>

                    <!-- è²¡å‹™è¼¸å…¥ -->
                    <div v-if="editTab === 'finance'" class="space-y-8 pb-24">
                        <div class="space-y-4">
                            <div v-for="(rec, ridx) in form.records" :key="ridx" class="flex items-center justify-between bg-white p-4 rounded-[1.5rem] card-shadow border border-slate-50 overflow-hidden"><div class="flex items-center min-w-0 flex-1"><div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center mr-3 text-[1.25em] shadow-inner">{{ getCategoryIcon(rec?.category) }}</div><div class="min-w-0 flex-1"><p class="text-sm font-black text-slate-800">{{ rec?.category }}</p><p v-if="rec?.note" class="text-[10px] text-slate-400 font-bold truncate pr-4">{{ rec?.note }}</p></div></div><div class="flex items-center gap-3"><span :class="rec?.type === 'income' ? 'text-red-600' : 'text-green-600'" class="font-mono font-black">{{ rec?.type === 'income' ? '+' : '-' }}{{ formatNumber(rec?.amount) }}</span><button @click="form.records.splice(ridx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>
                        </div>

                        <div class="p-6 bg-slate-50/80 rounded-[2.5rem] border border-slate-200 space-y-6">
                            <div class="flex justify-between items-center px-1"><span class="text-[10px] font-black text-slate-400 tracking-widest uppercase">{{ t('add_new_line') }}</span><div class="flex bg-white p-1 rounded-full shadow-sm text-[9px] font-black border border-slate-100 overflow-hidden"><button @click="newRecord.type = 'expense'" :class="newRecord.type === 'expense' ? 'bg-green-600 text-white shadow-md' : 'text-slate-400'" class="px-6 py-2.5 transition-all">{{ t('expense_short') }}</button><button @click="newRecord.type = 'income'" :class="newRecord.type === 'income' ? 'bg-red-500 text-white shadow-md' : 'text-red-500'" class="px-6 py-2.5 transition-all">{{ t('income_short') }}</button></div></div>
                            <div class="grid grid-cols-4 gap-3">
                                <button v-for="cat in currentCategories" :key="cat?.name" @click="newRecord.category = cat.name" @touchstart="startCategoryLongPress(cat)" @touchend="endCategoryLongPress" @mousedown="startCategoryLongPress(cat)" @mouseup="endCategoryLongPress" :class="newRecord.category === cat?.name ? 'ring-4 ring-indigo-100 bg-white scale-105 shadow-sm' : 'bg-white/40 opacity-70'" class="category-btn transition-all"><span class="text-xl mb-1">{{ cat?.icon }}</span><span class="text-[0.6em] font-black truncate w-full text-center">{{ cat?.name }}</span></button>
                                <button @click="showAddCategory = true" class="category-btn bg-white/40 border border-dashed border-slate-300 active:scale-90 flex items-center justify-center"><i data-lucide="plus" class="w-6 h-6 text-slate-300"></i></button>
                            </div>
                            <div class="flex gap-3 items-center w-full"><div class="w-[30%] shrink-0"><input type="number" v-model="newRecord.amount" class="w-full bg-white p-4 rounded-2xl outline-none font-black text-[1em] border-none shadow-inner text-center" :placeholder="t('amount_ph')"></div><div class="w-[70%] shrink-0"><input type="text" v-model="newRecord.note" class="w-full bg-white p-4 rounded-2xl outline-none font-bold text-[0.85em] border-none shadow-inner" :placeholder="t('note_ph')"></div></div>
                            <button @click="addNewRecord" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-5 rounded-2xl font-black text-[0.85em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_to_list') }}</button>
                        </div>
                    </div>

                    <!-- å¿ƒæƒ…æ—¥èªŒ -->
                    <div v-if="editTab === 'diary'" class="space-y-8 pb-24 px-1 overflow-x-hidden">
                        <div class="flex items-center justify-between bg-slate-50 p-5 rounded-[2.5rem] border border-slate-100"><div class="flex items-center"><div class="w-12 h-12 rounded-2xl bg-white shadow-md flex items-center justify-center mr-4" :class="{'recording-pulse': isRecording}"><i data-lucide="mic" class="w-6 h-6" :class="isRecording ? 'text-red-500' : 'text-p'"></i></div><div class="flex flex-col"><span class="text-xs font-black">{{ isRecording ? t('recording') : (form.audio ? t('recorded') : t('voice_memo')) }}</span><span class="text-[0.6em] text-slate-400 font-bold uppercase tracking-widest">Voice Note</span></div></div><div class="flex gap-2"><button v-if="!isRecording" @click="startRecording" class="p-3 bg-p text-white rounded-xl shadow-lg active:scale-90 transition-all"><i data-lucide="play" class="w-4 h-4 fill-current text-white"></i></button><button v-else @click="stopRecording" class="p-3 bg-red-500 text-white rounded-xl shadow-lg animate-pulse"><i data-lucide="square" class="w-4 h-4 fill-current text-white"></i></button><button v-if="form.audio && !isRecording" @click="playAudio(form.audio)" class="p-3 bg-indigo-100 text-p rounded-xl active:scale-90"><i data-lucide="volume-2" class="w-4 h-4"></i></button></div></div>
                        <div class="space-y-4"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest px-1">{{ t('journal_feeling') }}</label><div class="flex gap-2.5 px-1 overflow-x-auto hide-scrollbar"><button v-for="f in ['ğŸ˜Š','ğŸ˜”','ğŸ˜¡','ğŸ¤©','ğŸ˜´','ğŸ’ª','ğŸ·','ğŸ¢','âœˆï¸']" :key="f" @click="form.feeling = f" :class="form.feeling === f ? 'scale-125 ring-2 ring-orange-200 bg-white' : 'opacity-40'" class="text-[1.5em] p-2 rounded-xl transition-all">{{ f }}</button></div></div>
                        <div class="space-y-4"><div class="flex justify-between items-center px-1"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('photo') }} ({{ form.photos?.length || 0 }}/10)</label><div class="relative p-3 bg-slate-100 rounded-2xl active:scale-90 transition-all"><i data-lucide="camera" class="w-5 h-5 text-slate-500"></i><input type="file" multiple @change="handleMultiPhotoUpload" class="absolute inset-0 opacity-0 cursor-pointer"></div></div><div v-if="form.photos?.length" class="flex gap-3 overflow-x-auto py-2 hide-scrollbar"><div v-for="(img, idx) in form.photos" :key="idx" class="relative shrink-0"><img :src="img" class="photo-thumb"><button @click="form.photos.splice(idx, 1)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg"><i data-lucide="x" class="w-3 h-3 text-white"></i></button></div></div></div>
                        <div class="space-y-4"><div class="flex justify-between items-center px-1"><label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('location_map') }}</label><button @click="openGoogleMapsSearch" class="px-5 py-2 bg-indigo-50 text-p rounded-full text-[0.6em] font-black active:scale-90 transition-all border border-indigo-100">{{ t('search_on_map') }}</button></div><div class="flex gap-3"><input v-model="locationSearch" @keyup.enter="addLocation" :placeholder="t('location_ph')" class="flex-1 bg-slate-50 p-4 rounded-2xl text-[0.85em] font-bold outline-none border-2 border-transparent focus:border-p transition-all shadow-inner"><button @click="addLocation" class="bg-p text-white w-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-all"><i data-lucide="plus" class="w-6 h-6 text-white"></i></button></div><div class="space-y-2"><div v-for="(loc, lidx) in form.locations" :key="lidx" class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 card-shadow animate-in slide-in-from-bottom"><div class="flex items-center text-[0.85em] font-black text-indigo-700 cursor-pointer" @click="openGoogleMaps(loc?.name)"><i data-lucide="map-pin" class="w-4 h-4 mr-3 opacity-50"></i><span>{{ loc?.name }}</span></div><button @click="form.locations.splice(lidx, 1)" class="text-red-300 p-2 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div>
                        <textarea v-model="form.diaryText" class="w-full h-48 bg-slate-50 p-6 rounded-[2.5rem] border-none outline-none focus:ring-4 ring-indigo-50 shadow-inner text-[0.9em] font-bold leading-relaxed" :placeholder="t('journal_placeholder')"></textarea>
                    </div>
                </div>
            </div>
        </transition>

        <!-- é¡åˆ¥æ˜ç´°è·³çª— (ç´…æ”¶ç¶ æ”¯) -->
        <transition name="fade">
            <div v-if="showCategoryDetailModal" class="fixed inset-0 z-[120] flex items-end justify-center">
                <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showCategoryDetailModal = false"></div>
                <div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[85vh] shadow-2xl modal-scrollable overflow-x-hidden" :class="{ 'modal-transition': !isDraggingModal }" :style="modalStyle" @touchstart="handleModalTouchStart" @touchmove="handleModalTouchMove" @touchend="handleModalTouchEnd">
                    <button @click="showCategoryDetailModal = false" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600 transition-colors z-[110]"><i data-lucide="x" class="w-6 h-6"></i></button>
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div>
                    <div class="flex items-center gap-3 mb-6 px-2"><div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-[1.5em]">{{ selectedCategoryForDetail?.icon || '?' }}</div><h2 class="text-[1.5em] font-black text-slate-800">{{ selectedCategoryForDetail?.name }} {{ t('new_record') }}</h2></div>
                    <div class="space-y-4 pb-12">
                        <div v-for="(item, idx) in categoryDetailRecords" :key="idx" @click="jumpToEdit(item.date, item.originalIndex)" class="flex justify-between items-center bg-slate-50 p-4 rounded-[1.5rem] cursor-pointer hover:bg-slate-100 transition-all animate-in slide-in-from-bottom">
                            <div class="flex flex-col"><span class="text-[0.7em] font-bold text-slate-400 uppercase tracking-widest">{{ item.date }}</span><span class="text-[0.9em] font-black text-slate-700 truncate w-48">{{ item.record.note || '---' }}</span></div>
                            <div class="flex items-center gap-4">
                                <span class="font-mono font-black text-[1.1em]" :class="item.record.type==='income'?'text-red-500':'text-green-600'">{{ item.record.type==='income'?'+':'-' }}{{ formatNumber(item.record.amount) }}</span>
                                <button @click.stop="deleteSpecificRecord(item.date, item.originalIndex)" class="text-slate-300 hover:text-red-500 transition-colors p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div v-if="categoryDetailRecords.length === 0" class="text-center py-12 text-slate-300 font-bold">ç›®å‰ç„¡æ­¤é¡åˆ¥è³‡æ–™</div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- å…¶ä»–å½ˆçª— (åˆ†é¡ã€è‚¡ç¥¨ç·¨è¼¯)... -->
        <transition name="fade"><div v-if="showEditStockModal" class="fixed inset-0 z-[200] flex items-center justify-center p-6"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showEditStockModal = false"></div><div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in"><h3 class="text-xl font-black mb-6 text-slate-800">ç·¨è¼¯æŠ•è³‡é …ç›®</h3><div class="space-y-4"><div class="p-4 bg-slate-50 rounded-2xl"><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1">è‚¡ç¥¨åç¨±</p><p class="font-black text-p">{{ editingStock?.name || '---' }}</p></div><div class="grid grid-cols-2 gap-3"><div><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1 px-1">è‚¡æ•¸</p><input v-model.number="editingStock.qty" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-black outline-none shadow-inner text-center"></div><div><p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1 px-1">æˆæœ¬</p><input v-model.number="editingStock.buyPrice" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-black outline-none shadow-inner text-center"></div></div><div class="flex gap-4 pt-4"><button @click="showEditStockModal = false" class="flex-1 py-4 rounded-2xl font-black text-slate-400">{{ t('cancel') }}</button><button @click="confirmEditStock" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95">æ›´æ–°</button></div></div></div></div></transition>
        <transition name="fade"><div v-if="showAddCategory || showEditCategory" class="fixed inset-0 z-[200] flex items-center justify-center p-6"><div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeCategoryModal"></div><div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in"><h3 class="text-[1.25em] font-black mb-8 text-slate-800">{{ showEditCategory ? t('edit_cat_title') : t('custom_cat_title') }}</h3><div class="space-y-8"><div class="grid grid-cols-5 gap-3 max-h-48 overflow-y-auto p-1 hide-scrollbar"><button v-for="ico in iconPool" :key="ico" @click="categoryForm.icon = ico" :class="categoryForm.icon === ico ? 'bg-indigo-100 ring-4 ring-indigo-200' : 'bg-slate-50'" class="text-[1.5em] p-3 rounded-2xl transition-all flex items-center justify-center">{{ ico }}</button></div><input v-model="categoryForm.name" type="text" class="w-full bg-slate-50 p-5 rounded-3xl outline-none font-bold border-none shadow-inner text-[0.9em]" :placeholder="t('cat_name_ph')"><div class="flex gap-4 pt-4"><button @click="closeCategoryModal" class="flex-1 py-5 rounded-2xl font-black text-slate-400 text-[0.8em]">{{ t('cancel') }}</button><button @click="confirmCategoryAction" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 text-[0.8em]">{{ t('confirm') }}</button></div></div></div></div></transition>

        <!-- åº•éƒ¨å°è¦½åˆ— -->
        <nav class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-slate-100 h-24 tab-bar z-40 px-3 flex items-center shadow-lg shrink-0">
            <div class="flex w-full items-center justify-around"><button v-for="v in ['ledger', 'stocks', 'add', 'charts', 'settings']" :key="v" @click="v === 'add' ? openAddModal() : (currentView = v)" :style="(currentView === v && v !== 'add') ? { color: settings.themeColor } : {}" class="flex flex-col items-center transition-all flex-1" :class="[currentView === v ? 'nav-active scale-110' : 'text-slate-300', v === 'add' ? 'relative' : '']"><template v-if="v === 'add'"><div :style="{ backgroundColor: settings.themeColor }" class="text-white w-16 h-16 rounded-[2.2rem] shadow-xl border-[6px] border-white flex items-center justify-center -translate-y-8 active:scale-90 transition-all hover:rotate-90"><i data-lucide="plus" class="w-8 h-8"></i></div></template><template v-else><i :data-lucide="v === 'ledger' ? 'calendar' : (v === 'stocks' ? 'trending-up' : (v === 'charts' ? 'pie-chart' : 'settings'))" class="w-6 h-6"></i><span class="text-[0.6em] mt-1.5 uppercase font-black tracking-tighter">{{ t(v) }}</span></template></button></div>
        </nav>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        const apiKey = ""; 
        const version = "v1.0.0.7";
        
        // æ ¸å¿ƒç‹€æ…‹
        const currentYear = ref(new Date().getFullYear());
        const currentMonth = ref(new Date().getMonth());
        const selectedDay = ref(new Date().getDate());
        const currentView = ref('ledger');
        const settings = ref({ lang: 'zh', themeColor: '#4f46e5', fontSize: 'medium' });

        const showAddModal = ref(false);
        const showCategoryDetailModal = ref(false);
        const showYearPicker = ref(false);
        const showMonthPicker = ref(false);
        const showAddCategory = ref(false);
        const showEditCategory = ref(false);
        const showEditStockModal = ref(false);
        const chartRange = ref('all');
        const chartMode = ref('expense');
        const isAILoading = ref(false);
        const editTab = ref('diary');
        const isRecording = ref(false);
        const locationSearch = ref('');
        const lastSyncTime = ref('');
        const errorMsg = ref('');
        const stockSuggestions = ref([]);
        const touchYStart = ref(0);
        const modalDeltaY = ref(0);
        const isDraggingModal = ref(false);
        const editingStock = ref({ name: '', qty: 0, buyPrice: 0 });
        const selectedCategoryForDetail = ref(null);
        
        let editingStockIdx = -1;
        let mediaRecorder = null;
        let audioChunks = [];
        let searchTimeout = null;
        let longPressTimer = null;

        const categories = ref([
            { name: 'é¤é£²', icon: 'ğŸ²', type: 'expense' }, { name: 'äº¤é€š', icon: 'ğŸš—', type: 'expense' },
            { name: 'è³¼ç‰©', icon: 'ğŸ›ï¸', type: 'expense' }, { name: 'å¨›æ¨‚', icon: 'ğŸ¬', type: 'expense' },
            { name: 'å±…å®¶', icon: 'ğŸ ', type: 'expense' }, { name: 'é†«ç™‚', icon: 'ğŸ’Š', type: 'expense' },
            { name: 'è–ªè³‡', icon: 'ğŸ’°', type: 'income' }, { name: 'ç´…åˆ©', icon: 'ğŸ§§', type: 'income' },
            { name: 'å…¶å®ƒ', icon: 'ğŸ“¦', type: 'expense' }
        ]);

        const iconPool = ['ğŸ²', 'â˜•', 'ğŸº', 'ğŸ°', 'ğŸš—', 'ğŸš²', 'â›½', 'âœˆï¸', 'ğŸ›ï¸', 'ğŸ‘•', 'ğŸ“±', 'ğŸ®', 'ğŸ¬', 'ğŸ“š', 'ğŸ’Š', 'ğŸ©º', 'ğŸ ', 'ğŸ›‹ï¸', 'ğŸˆ', 'ğŸ¶', 'ğŸŒ¿', 'ğŸ’°', 'ğŸ¦', 'ğŸ’¼', 'ğŸ', 'ğŸ·', 'ğŸš¬', 'â›ª', 'ğŸš•', 'ğŸ ', 'ğŸ¨', 'ğŸ»', 'ğŸ¸', 'ğŸ›€', 'ğŸ£', 'ğŸ¼', 'ğŸ‘¶', 'ğŸ¾', 'ğŸ’ˆ', 'ğŸ’‡', 'ğŸ’„'];
        const categoryForm = ref({ name: '', icon: 'ğŸ²' });
        let targetCategory = null;

        // é è¨­è³‡æ–™
        const entries = ref({
            "2026-02-10": { diaryText: "UI ä¿®å¾©å®Œæˆï¼ŒReferenceError å·²æ’é™¤ï¼Œè‚¡å¸‚å°æ¥ TWSEã€‚", feeling: 'ğŸ¤©', records: [{ type: 'expense', amount: 350, category: 'é¤é£²', note: 'é«˜é›„æ™šé¤' }], photos: [], locations: [{name: "é§äºŒ"}] }
        });
        const stockPortfolio = ref([{ name: 'å°ç©é›»(2330)', qty: 10, buyPrice: 1000, currentPrice: 1050 }]);
        const form = ref({ records: [], diaryText: '', feeling: 'ğŸ˜Š', photos: [], locations: [], audio: null });
        const newRecord = ref({ type: 'expense', amount: null, category: 'é¤é£²', note: '' });
        const newStock = ref({ name: '', qty: null, buyPrice: null });

        const dictionary = {
            zh: { 
                ledger: 'å¸³æœ¬', stocks: 'è‚¡å¸‚æŠ•è³‡', charts: 'åˆ†æçµ±è¨ˆ', settings: 'ç³»çµ±è¨­ç½®', add: 'æ–°å¢',
                year: 'å¹´', month: 'æœˆ', steps: 'æ­¥', in_prefix: 'æ”¶', out_prefix: 'æ”¯', daily_net: 'ç•¶æ—¥çµé¤˜',
                weekdays: ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'],
                daily_finance: 'ç•¶æ—¥è²¡å‹™', daily_diary: 'å¿ƒæƒ…æ—¥èªŒ', fetching: 'è¡Œæƒ…ç²å–ä¸­',
                no_data_hint: 'ä»Šå¤©å°šæœªæœ‰ç´€éŒ„', balance: 'çµé¤˜', choose_year: 'é¸æ“‡å¹´ä»½', choose_month: 'é¸æ“‡æœˆä»½', confirm: 'ç¢ºèª', cancel: 'å–æ¶ˆ',
                income: 'æ”¶å…¥', expense: 'æ”¯å‡º', income_short: 'æ”¶', expense_short: 'æ”¯',
                stock_name_ph: 'è¼¸å…¥åç¨±æˆ–ä»£ç¢¼ (å¦‚ï¼šå°ç©æˆ–2330)', stock_qty_ph: 'è‚¡æ•¸', stock_buy_ph: 'æˆæœ¬', add_stock_btn: 'åŠ å…¥æ¸…å–®',
                shares_unit: 'è‚¡', unrealized_pl: 'æœªå¯¦ç¾æç›Š', unrealized_pl_short: 'æœªå¯¦ç›Š', expense_structure: 'æ”¯å‡ºçµæ§‹', income_structure: 'æ”¶å…¥çµæ§‹',
                lang_label: 'èªè¨€é¸æ“‡', theme_label: 'é…è‰²æ–¹æ¡ˆ', font_label: 'æ–‡å­—å¤§å°', new_record: 'ç´€éŒ„è©³æƒ…', save: 'ä¿å­˜',
                font_small: 'å° (0.75x)', font_medium: 'ä¸­ (1.0x)', font_large: 'å¤§ (1.25x)', journal_placeholder: 'åˆ†äº«ä»Šå¤©ç™¼ç”Ÿçš„äº‹...',
                voice_memo: 'èªéŸ³å‚™å¿˜', recorded: 'éŒ„éŸ³å·²å­˜', recording: 'éŒ„éŸ³ä¸­', amount_ph: 'é‡‘é¡', note_ph: 'å‚™è¨»', add_to_list: 'åŠ å…¥',
                stat_btn: 'æ™ºæ…§çµ±è¨ˆ', no_diary_text: 'å°šæœªå¡«å¯«ä»Šæ—¥æ—¥èªŒ...', market_value: 'å¸‚å€¼', total_profit: 'æç›Š',
                photo: 'ç›¸ç‰‡', location_map: 'åœ°é»', search_on_map: 'åœ°åœ–', location_ph: 'è¼¸å…¥åœ°é»...', add_new_line: 'æ–°å¢æ”¶æ”¯æ˜ç´°', journal_feeling: 'æ„Ÿå—',
                edit_cat_title: 'ç·¨è¼¯é¡åˆ¥', custom_cat_title: 'è‡ªå®šç¾©é¡åˆ¥', cat_name_ph: 'åç¨±', total: 'åˆè¨ˆ', avg_day: 'å¹³å‡æ¯å¤©'
            },
            en: { 
                ledger: 'Ledger', stocks: 'Stocks', charts: 'Analysis', settings: 'Settings', add: 'New',
                year: 'Y', month: 'M', steps: 'steps', in_prefix: 'IN', out_prefix: 'OUT', daily_net: 'Net',
                weekdays: ['S','M','T','W','T','F','S'], daily_finance: 'Finance', daily_diary: 'Journal', fetching: 'Updating',
                no_data_hint: 'No data', balance: 'Balance', choose_year: 'Year', choose_month: 'Month', confirm: 'Done', cancel: 'Cancel',
                income: 'Income', expense: 'Expense', income_short: 'IN', expense_short: 'OUT',
                stock_name_ph: 'Name/ID', stock_qty_ph: 'Qty', stock_buy_ph: 'Cost', add_stock_btn: 'Add',
                shares_unit: 'shs', unrealized_pl: 'U-PL', unrealized_pl_short: 'U-PL', expense_structure: 'Expenses', income_structure: 'Income',
                lang_label: 'Language', theme_label: 'Theme', font_label: 'Font', new_record: 'Details', save: 'Save',
                photo: 'Photos', location_map: 'Locations', add_new_line: 'Add Record', journal_feeling: 'Feelings'
            }
        };
        const t = (key) => dictionary[settings.value.lang][key] || key;

        // è¨ˆç®—å±¬æ€§
        const yearRange = computed(() => { const y = new Date().getFullYear(); return Array.from({length: 12}, (_, i) => y - 5 + i); });
        const daysInMonth = computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate());
        const firstDayOfMonth = computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay());
        const currentDayKey = computed(() => `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`);
        const currentDayData = computed(() => entries.value[currentDayKey.value]);
        const selectedDateString = computed(() => `${currentYear.value}å¹´ ${currentMonth.value + 1}æœˆ ${selectedDay.value}æ—¥`);
        const currentCategories = computed(() => categories.value.filter(c => c.type === newRecord.value.type || !c.type));

        // è‰²å½©èˆ‡æ•¸å€¼è¨ˆç®— (ç´…æ”¶ç¶ æ”¯)
        const dayTotalIncome = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'income').reduce((a, b) => a + (b.amount || 0), 0));
        const dayTotalExpense = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'expense').reduce((a, b) => a + (b.amount || 0), 0));
        const dayNetBalance = computed(() => dayTotalIncome.value - dayTotalExpense.value);

        const allDataTotals = computed(() => {
            let inc = 0, exp = 0;
            Object.values(entries.value).forEach(e => { (e.records || []).forEach(r => { if (r.type === 'income') inc += (r.amount || 0); else exp += (r.amount || 0); }); });
            return { income: inc, expense: exp, net: inc - exp };
        });

        const stockTotalValue = computed(() => stockPortfolio.value.reduce((s, x) => s + ((x.currentPrice || x.buyPrice) * x.qty), 0));
        const stockTotalProfit = computed(() => stockPortfolio.value.reduce((s, x) => s + (((x.currentPrice || x.buyPrice) - x.buyPrice) * x.qty), 0));
        const netWorth = computed(() => allDataTotals.value.net + stockTotalValue.value);

        // æå–é¡åˆ¥æ˜ç´°
        const getRecordsByCategory = (catName) => {
            const results = [];
            Object.keys(entries.value).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                let match = chartRange.value === 'all' || (chartRange.value === 'year' && y === currentYear.value) || (chartRange.value === 'month' && m === currentMonth.value+1);
                if (match) {
                    const dailyRecs = entries.value[dateKey].records || [];
                    dailyRecs.forEach((r, idx) => {
                        if (r.category === catName && r.type === chartMode.value) {
                            results.push({ date: dateKey, record: r, originalIndex: idx });
                        }
                    });
                }
            });
            return results.sort((a, b) => new Date(b.date) - new Date(a.date));
        };

        const chartCategories = computed(() => {
            const totals = {};
            const categoryColors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#9B59B6', '#F39C12', '#1ABC9C', '#E67E22', '#3498DB', '#7F8C8D'];
            Object.keys(entries.value).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                let match = chartRange.value === 'all' || (chartRange.value === 'year' && y === currentYear.value) || (chartRange.value === 'month' && m === currentMonth.value+1);
                if (match) (entries.value[dateKey].records || []).forEach(r => { if (r.type === chartMode.value) totals[r.category] = (totals[r.category] || 0) + r.amount; });
            });
            return Object.keys(totals).map(n => ({ name: n, value: totals[n] })).sort((a, b) => b.value - a.value).map((item, i) => ({ ...item, color: categoryColors[i % categoryColors.length] }));
        });

        const chartTotalValue = computed(() => chartCategories.value.reduce((a, b) => a + b.value, 0) || 0);
        
        // ä¿®æ­£ï¼šè¨ˆç®—ç”œç”œåœˆåœ–çš„æ¼¸å±¤å­—ä¸²
        const pieGradient = computed(() => {
            const total = chartTotalValue.value;
            if (total <= 0) return '#f1f5f9';
            let offset = 0;
            const parts = chartCategories.value.map(cat => {
                const p = (cat.value / total) * 100;
                const part = `${cat.color} ${offset}% ${offset + p}%`;
                offset += p; 
                return part;
            });
            return `conic-gradient(${parts.join(', ')})`;
        });

        const categoryDetailRecords = computed(() => selectedCategoryForDetail.value ? getRecordsByCategory(selectedCategoryForDetail.value.name) : []);

        // æ–¹æ³•
        const updateIcons = () => nextTick(() => lucide.createIcons());
        const formatNumber = (num) => Math.floor(num || 0).toLocaleString();
        const showError = (msg) => { errorMsg.value = msg; setTimeout(() => { errorMsg.value = ''; }, 3000); };
        const getCategoryIcon = (n) => categories.value.find(c => c.name === n)?.icon || 'â“';
        const getPhotoGridClass = (c) => c === 1 ? 'photo-grid-1 h-48' : (c === 2 ? 'photo-grid-2 h-32' : 'photo-grid-3 h-48');

        const changeYear = (delta) => currentYear.value += delta;
        const changeMonth = (delta) => { 
            let nm = currentMonth.value + delta;
            if (nm > 11) { nm = 0; currentYear.value++; } else if (nm < 0) { nm = 11; currentYear.value--; }
            currentMonth.value = nm;
        };

        const openAddModal = (tab = 'diary') => {
            editTab.value = tab;
            form.value = entries.value[currentDayKey.value] ? JSON.parse(JSON.stringify(entries.value[currentDayKey.value])) : { records: [], diaryText: '', feeling: 'ğŸ˜Š', photos: [], locations: [], audio: null };
            showAddModal.value = true;
            updateIcons();
        };

        const saveRecord = () => {
            entries.value[currentDayKey.value] = JSON.parse(JSON.stringify(form.value));
            showAddModal.value = false;
            updateIcons();
        };

        const jumpToEdit = (dateStr, index) => {
            const [y, m, d] = dateStr.split('-').map(Number);
            currentYear.value = y;
            currentMonth.value = m - 1;
            selectedDay.value = d;
            showCategoryDetailModal.value = false;
            openAddModal('finance');
        };

        const deleteSpecificRecord = (dateStr, index) => {
            if (entries.value[dateStr]) {
                entries.value[dateStr].records.splice(index, 1);
                updateIcons();
            }
        };

        const jumpToCategoryDetails = (catName) => {
            const cat = categories.value.find(c => c.name === catName);
            if (cat) selectedCategoryForDetail.value = cat;
            showCategoryDetailModal.value = true;
            updateIcons();
        };

        const addNewRecord = () => { if (newRecord.value.amount) { form.value.records.unshift({ ...newRecord.value }); newRecord.value.amount = null; newRecord.value.note = ''; } };
        const addStockItem = () => { if (newStock.value.name) { stockPortfolio.value.push({ name: newStock.value.name, qty: newStock.value.qty || 0, buyPrice: newStock.value.buyPrice || 0, currentPrice: newStock.value.buyPrice || 0 }); newStock.value = { name: '', qty: null, buyPrice: null }; updateIcons(); } };
        
        const updatePortfolioPrices = async () => {
            if (!stockPortfolio.value.length) return;
            isAILoading.value = true;
            try {
                const syms = stockPortfolio.value.map(s => s.name).join(', ');
                const sys = `TWSE Official Analyst. SEARCH GOOGLE for the ABSOLUTE LATEST TRADE PRICES (æˆäº¤åƒ¹) on the Taiwan Stock Exchange for: ${syms}. 
                Return ONLY clean JSON: {"2330": 1050}. If data unavailable or holiday, return last close. User Time: ${new Date().toLocaleString()}.`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Search real-time TWSE prices for ${syms}` }] }], systemInstruction: { parts: [{ text: sys }] }, tools: [{ "google_search": {} }] })
                });
                const d = await res.json();
                const match = d.candidates?.[0]?.content?.parts?.[0]?.text?.match(/\{[\s\S]*\}/);
                if (match) {
                    const priceMap = JSON.parse(match[0]);
                    stockPortfolio.value.forEach(stk => {
                        const id = stk.name.match(/\d{4,}/)?.[0] || stk.name;
                        const matchKey = Object.keys(priceMap).find(k => k.includes(id) || id.includes(k));
                        if (matchKey) stk.currentPrice = priceMap[matchKey];
                    });
                    lastSyncTime.value = new Date().toLocaleTimeString();
                } else showError("è³‡æ–™æŠ“å–å¤±æ•—");
            } catch (e) { showError("è³‡æ–™æŠ“å–å¤±æ•—"); }
            isAILoading.value = false;
        };

        const debouncedSearch = () => {
            clearTimeout(searchTimeout);
            if (!newStock.value.name) { stockSuggestions.value = []; return; }
            searchTimeout = setTimeout(async () => {
                try {
                    const system = `Lookup TWSE codes. Return JSON: [{"name": "å°ç©é›»", "id": "2330"}]. Keyword: ${newStock.value.name}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Search ${newStock.value.name}` }] }], systemInstruction: { parts: [{ text: system }] }, tools: [{ "google_search": {} }] })
                    });
                    const d = await res.json();
                    const match = d.candidates?.[0]?.content?.parts?.[0]?.text?.match(/\[[\s\S]*\]/);
                    if (match) stockSuggestions.value = JSON.parse(match[0]);
                } catch (e) {}
            }, 800);
        };
        const selectStockSuggestion = (sug) => { newStock.value.name = `${sug.name}(${sug.id})`; stockSuggestions.value = []; };

        const startStockLongPress = (stk, idx) => { longPressTimer = setTimeout(() => { editingStock.value = { ...stk }; editingStockIdx = idx; showEditStockModal.value = true; }, 800); };
        const endStockLongPress = () => clearTimeout(longPressTimer);
        const confirmEditStock = () => { if (editingStockIdx !== -1) stockPortfolio.value[editingStockIdx] = { ...editingStock.value }; showEditStockModal.value = false; };
        const startCategoryLongPress = (cat) => { longPressTimer = setTimeout(() => { targetCategory = cat; categoryForm.value = { ...cat }; showEditCategory.value = true; }, 800); };
        const endCategoryLongPress = () => clearTimeout(longPressTimer);
        const closeCategoryModal = () => { showAddCategory.value = false; showEditCategory.value = false; categoryForm.value = { name: '', icon: 'ğŸ²' }; };
        const confirmCategoryAction = () => { if (!categoryForm.value.name.trim()) return; if (showEditCategory.value && targetCategory) { targetCategory.name = categoryForm.value.name.trim(); targetCategory.icon = categoryForm.value.icon; } else { categories.value.push({ name: categoryForm.value.name.trim(), icon: categoryForm.value.icon, type: newRecord.value.type }); } closeCategoryModal(); };

        const handleMultiPhotoUpload = (e) => { Array.from(e.target.files).slice(0, 10).forEach(file => { const reader = new FileReader(); reader.onload = (f) => form.value.photos.push(f.target.result); reader.readAsDataURL(file); }); };
        const addLocation = () => { if (locationSearch.value.trim()) { form.value.locations.push({ name: locationSearch.value.trim() }); locationSearch.value = ''; updateIcons(); } };
        const openGoogleMapsSearch = () => window.open(`https://www.google.com/maps`, '_blank');
        const openGoogleMaps = (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank');
        const startRecording = async () => { const s = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(s); mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data); mediaRecorder.onstop = () => { const b = new Blob(audioChunks, { type: 'audio/webm' }); const r = new FileReader(); r.onload = (x) => form.value.audio = x.target.result; r.readAsDataURL(b); audioChunks = []; }; mediaRecorder.start(); isRecording.value = true; };
        const stopRecording = () => { if (mediaRecorder) { mediaRecorder.stop(); isRecording.value = false; } };
        const playAudio = (u) => new Audio(u).play();

        const handleModalTouchStart = (e) => { if (e.currentTarget.scrollTop <= 0) { touchYStart.value = e.touches[0].clientY; isDraggingModal.value = true; } };
        const handleModalTouchMove = (e) => { if (isDraggingModal.value) { const d = e.touches[0].clientY - touchYStart.value; if (d > 0) { modalDeltaY.value = d; if (e.cancelable) e.preventDefault(); } else isDraggingModal.value = false; } };
        const handleModalTouchEnd = () => { if (modalDeltaY.value > 150) { showAddModal.value = false; showCategoryDetailModal.value = false; } modalDeltaY.value = 0; isDraggingModal.value = false; };
        const modalStyle = computed(() => { if (!isDraggingModal.value && modalDeltaY.value === 0) return {}; return { transform: `translateY(${modalDeltaY.value}px) scale(${Math.max(0.85, 1 - modalDeltaY.value/2500)})`, opacity: Math.max(0.7, 1 - modalDeltaY.value/1000), transformOrigin: 'bottom center' }; });

        onMounted(() => updateIcons());
        watch([currentView, showAddModal, settings, editTab, chartRange, chartMode, showCategoryDetailModal], () => updateIcons());

        return {
            currentView, showAddModal, showYearPicker, showMonthPicker, showAddCategory, showEditCategory, showEditStockModal, showCategoryDetailModal,
            yearRange, chartRange, chartMode, t, settings, currentYear, currentMonth, selectedDay, daysInMonth, firstDayOfMonth, selectedDateString, version, stockSuggestions, debouncedSearch,
            getDayEntries: (d) => { const k = `${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const e = entries.value[k]; return { hasDiary: !!(e?.diaryText || e?.photos?.length || e?.audio), hasFinance: !!(e?.records?.length) }; },
            form, saveRecord, openAddModal, allDataTotals, formatNumber, chartCategories, chartTotalValue, pieGradient, dayNetBalance, dayTotalIncome, dayTotalExpense, editTab, newRecord, currentCategories, errorMsg, editingStock, addNewRecord, getCategoryIcon, iconPool, categoryForm, confirmCategoryAction, closeCategoryModal, startCategoryLongPress, endCategoryLongPress, startStockLongPress, endStockLongPress, confirmEditStock,
            stockPortfolio, newStock, addStockItem, updatePortfolioPrices, stockTotalValue, stockTotalProfit, isAILoading, lastSyncTime,
            handleModalTouchStart, handleModalTouchMove, handleModalTouchEnd, isDraggingModal, modalStyle,
            handleMultiPhotoUpload, addLocation, locationSearch, openGoogleMaps, openGoogleMapsSearch, startRecording, stopRecording, playAudio, isRecording, selectStockSuggestion, netWorth, getPhotoGridClass, changeYear, changeMonth, currentDayData,
            selectedCategoryForDetail, categoryDetailRecords, jumpToCategoryDetails, jumpToEdit, deleteSpecificRecord
        };
    }
}).mount('#app');
</script>
</body>
</html>
