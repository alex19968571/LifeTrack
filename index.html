<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeTrack - Â∞àÊ•≠ AI Êó•Ë™åËàáËÇ°Â∏ÇË®òÂ∏≥</title>
    <!-- ÂºïÂÖ• Vue 3, Tailwind CSS Ëàá Lucide ÂúñÁ§∫Â∫´ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none; }
        :root { --p-color: #4f46e5; }
        
        /* Âü∫Á§é‰ΩàÂ±ÄË®≠ÂÆö */
        .app-container { height: 100dvh; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ÂÖ®Âüü‰∏ªÈ°åËâ≤ÂΩ©ÈÄ£Âãï */
        .text-p { color: var(--p-color) !important; }
        .bg-p { background-color: var(--p-color) !important; }
        .border-p { border-color: var(--p-color) !important; }
        .ring-p { --tw-ring-color: var(--p-color) !important; }

        /* ÂãïÊÖãÊñáÂ≠óÂ§ßÂ∞èÁ∏ÆÊîæÁ≥ªÁµ± (Â∞çÊ®ôÈúÄÊ±Ç: 0.75, 1, 1.25) */
        .app-font-small { font-size: 12px; }
        .app-font-medium { font-size: 16px; }
        .app-font-large { font-size: 20px; }
        
        /* ÊØî‰æãÂ∞∫ÂØ∏ÂæÆË™ø */
        .app-font-small h1 { font-size: 1.25rem; }
        .app-font-large h1 { font-size: 1.75rem; }

        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .safe-pb { padding-bottom: calc(8.5rem + env(safe-area-inset-bottom)); }

        .pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ÁÖßÁâáÊéíÁâàÁ∂≤Ê†º */
        .photo-grid-1 { grid-template-columns: 1fr; }
        .photo-grid-2 { grid-template-columns: 1fr 1fr; }
        .photo-grid-3 { grid-template-areas: "a b" "a c"; grid-template-columns: 1.5fr 1fr; }
        
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        /* ÂàÜÈ°ûÊåâÈàïÁµ±‰∏ÄÁΩÆ‰∏≠ */
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 1.25rem;
            transition: all 0.2s;
            overflow: hidden;
        }
        .nav-active { font-weight: 900; }

        /* Èò≤Ê≠¢Ê©´ÂêëÊªëÂãï‰∏îÂÖÅË®±Á∏±ÂêëÊªëÂãïÈóúÈñâÊâãÂã¢ */
        .modal-scrollable {
            touch-action: pan-y;
            overflow-x: hidden;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-slate-200 text-slate-900 antialiased overflow-hidden">

<div id="app" v-cloak class="flex justify-center items-center app-container" :style="{'--p-color': settings.themeColor}">
    <!-- App ‰∏ªÈ´îÂÆπÂô® -->
    <div :class="['w-full sm:max-w-md h-full bg-white shadow-2xl relative flex flex-col overflow-hidden transition-all duration-300', 'app-font-' + settings.fontSize]">
        
        <!-- È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü -->
        <header :style="{ backgroundColor: settings.themeColor }" class="p-4 sm:p-5 text-white shadow-md shrink-0 z-20 transition-all duration-500">
            <div class="flex justify-between items-center">
                <h1 class="font-black tracking-tight leading-tight">{{ t(currentView) }}</h1>
                <div class="flex flex-col items-end">
                    <span class="text-[0.6em] font-bold opacity-80">{{ currentYear }}{{ t('year') }}</span>
                    <span class="text-[1em] leading-none font-black">{{ currentMonth + 1 }}{{ t('month') }}</span>
                </div>
            </div>
        </header>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÊ∏≤ÊüìÂçÄ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 safe-pb">
            
            <!-- Ë¶ñÂúñ 1: Â∏≥Êú¨ (Ledger) -->
            <section v-if="currentView === 'ledger'" class="animate-in fade-in duration-300">
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="calendar-grid text-center text-[0.65em] font-bold text-slate-400 mb-2 uppercase tracking-widest">
                        <div v-for="d in t('weekdays')" :key="d">{{ d }}</div>
                    </div>
                    <div class="calendar-grid gap-1">
                        <div v-for="empty in firstDayOfMonth" :key="'e'+empty"></div>
                        <div v-for="day in daysInMonth" :key="day" @click="selectedDay = day"
                            :style="selectedDay === day ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                            class="p-2 text-center rounded-xl cursor-pointer transition relative aspect-square flex flex-col items-center justify-center hover:bg-slate-100"
                            :class="selectedDay === day ? 'shadow-lg scale-105 z-10 font-black' : ''"
                        >
                            <span class="text-[0.85em] font-bold">{{ day }}</span>
                            <div class="flex gap-0.5 mt-0.5">
                                <div v-if="getDayEntries(day).hasDiary" :class="selectedDay === day ? 'bg-white' : 'bg-blue-400'" class="w-1 h-1 rounded-full"></div>
                                <div v-if="getDayEntries(day).hasFinance" :class="selectedDay === day ? 'bg-white' : 'bg-green-400'" class="w-1 h-1 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-4">
                    <h3 class="text-[0.7em] font-black text-slate-400 uppercase tracking-wider px-1">{{ selectedDateString }}</h3>

                    <div v-if="currentDayData" class="space-y-4">
                        <!-- Ë≤°ÂãôÁ∞°Ëø∞Âç°Áâá -->
                        <div @click="openAddModal('finance')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-50">
                                <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_finance') }}</span>
                                <div :class="dayNetBalance >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[1.2em] font-black font-mono">
                                    {{ dayNetBalance >= 0 ? '+' : '' }}{{ formatNumber(dayNetBalance) }}
                                </div>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[0.65em] font-bold text-green-600 tracking-tighter">{{ t('income_short') }} +{{ formatNumber(dayTotalIncome) }}</span>
                                <span class="text-[0.65em] font-bold text-red-600 tracking-tighter">{{ t('expense_short') }} -{{ formatNumber(dayTotalExpense) }}</span>
                            </div>
                        </div>

                        <!-- Êó•Ë™åÁ∞°Ëø∞Âç°Áâá -->
                        <div @click="openAddModal('diary')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 space-y-3 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between">
                                <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_diary') }}</span>
                                <div class="text-[1.2em]">{{ currentDayData.feeling }}</div>
                            </div>
                            <div v-if="currentDayData.photos?.length" class="grid gap-1 overflow-hidden rounded-xl" :class="getPhotoGridClass(currentDayData.photos.length)">
                                <img v-for="(img, idx) in currentDayData.photos.slice(0, 3)" :key="idx" :src="img" class="w-full h-full object-cover min-h-[80px]">
                            </div>
                            <p class="text-[0.9em] text-slate-600 leading-relaxed truncate">{{ currentDayData.diaryText }}</p>
                        </div>
                    </div>
                    <div v-else class="text-center py-20 opacity-30 text-[0.8em] font-black flex flex-col items-center">
                        <i data-lucide="inbox" class="w-10 h-10 mb-2"></i>
                        {{ t('no_data_hint') }}
                    </div>
                </div>
            </section>

            <!-- Ë¶ñÂúñ 2: ËÇ°Â∏ÇÊäïË≥á (Stocks) -->
            <section v-if="currentView === 'stocks'" class="p-6 space-y-6 animate-in fade-in">
                <div class="flex justify-between items-end px-1">
                    <div>
                        <h2 class="text-[1.5em] font-black text-slate-800">{{ t('stocks') }}</h2>
                        <p class="text-[0.6em] text-slate-400 font-bold uppercase tracking-widest">Real-time Portfolio</p>
                    </div>
                    <button @click="updatePortfolioPrices" :disabled="isAILoading || !stockPortfolio.length" :style="{ backgroundColor: settings.themeColor }" class="text-white px-6 py-2 rounded-full font-black text-[0.7em] shadow-lg active:scale-90 transition-all disabled:opacity-30 flex items-center">
                        <i v-if="isAILoading" data-lucide="loader-2" class="w-3 h-3 mr-2 animate-spin text-white"></i>
                        {{ isAILoading ? t('fetching') : t('stat_btn') }}
                    </button>
                </div>

                <div class="bg-slate-900 text-white p-7 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10 space-y-5">
                        <div class="flex justify-between items-center border-b border-white/10 pb-5">
                            <div>
                                <p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('market_value') }}</p>
                                <p class="text-[2em] font-black font-mono tracking-tighter">${{ formatNumber(stockTotalValue) }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('total_profit') }}</p>
                                <p :class="stockTotalProfit >= 0 ? 'text-green-400' : 'text-red-400'" class="text-[1.5em] font-black font-mono tracking-tighter">
                                    {{ stockTotalProfit >= 0 ? '+' : '' }}{{ formatNumber(stockTotalProfit) }}
                                </p>
                            </div>
                        </div>
                        <div class="flex justify-between text-[0.6em] font-bold">
                            <span class="opacity-40 uppercase">{{ t('last_sync') }}: {{ lastSyncTime || '---' }}</span>
                            <span class="text-indigo-400 font-black italic uppercase tracking-widest font-black">TWSE / AI REALTIME</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div v-for="(stk, idx) in stockPortfolio" :key="idx" class="bg-white p-4 rounded-3xl border border-slate-100 card-shadow flex justify-between items-center group transition-all">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center mr-4 text-[1.25em] font-bold text-p shadow-inner">{{ stk.name[0] }}</div>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-black text-slate-800 truncate pr-2">{{ stk.name }}</p>
                                <p class="text-[0.6em] text-slate-400 font-bold uppercase mt-1">
                                    {{ stk.qty }} {{ t('shares_unit') }} ¬∑ @{{ formatNumber(stk.buyPrice) }}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-right">
                            <div class="shrink-0">
                                <p :class="(stk.currentPrice - stk.buyPrice) >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[0.9em] font-black font-mono">
                                    {{ (stk.currentPrice - stk.buyPrice) >= 0 ? '+' : '' }}{{ formatNumber((stk.currentPrice - stk.buyPrice) * stk.qty) }}
                                </p>
                                <p class="text-[0.55em] text-slate-400 font-bold uppercase">ÁèæÂÉπ: {{ stk.currentPrice ? formatNumber(stk.currentPrice) : '---' }}</p>
                            </div>
                            <button @click="stockPortfolio.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="p-6 bg-indigo-50/50 rounded-[2.5rem] border border-indigo-100 space-y-4">
                        <input v-model="newStock.name" type="text" class="bg-white w-full p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-sm" :placeholder="t('stock_name_ph')">
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model.number="newStock.qty" type="number" class="bg-white p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-sm" :placeholder="t('stock_qty_ph')">
                            <input v-model.number="newStock.buyPrice" type="number" class="bg-white p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-sm" :placeholder="t('stock_buy_ph')">
                        </div>
                        <button @click="addStockItem" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-4 rounded-2xl font-black text-[0.8em] shadow-xl active:scale-[0.98] transition-all">
                            {{ t('add_stock_btn') }}
                        </button>
                    </div>
                </div>
            </section>

            <!-- Ë¶ñÂúñ 3: ÂúñË°®ÂàÜÊûê (Charts) -->
            <section v-if="currentView === 'charts'" class="p-6 space-y-8 animate-in fade-in">
                <!-- ÂúñË°®ÂΩôÁ∏ΩË≥áË®ä -->
                <div class="bg-white p-4 rounded-[2rem] card-shadow border border-slate-50 flex items-center justify-between transition-all overflow-hidden">
                    <div class="text-center flex-1 min-w-0">
                        <p class="text-[0.55em] font-black text-green-600 uppercase mb-0.5 truncate">{{ t('income') }}</p>
                        <p class="text-[0.8em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.income) }}</p>
                    </div>
                    <div class="h-8 w-px bg-slate-100 mx-1"></div>
                    <div class="text-center flex-1 min-w-0">
                        <p class="text-[0.55em] font-black text-red-500 uppercase mb-0.5 truncate">{{ t('expense') }}</p>
                        <p class="text-[0.8em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.expense) }}</p>
                    </div>
                    <div class="h-8 w-px bg-slate-100 mx-1"></div>
                    <div class="text-center flex-1 min-w-0">
                        <p class="text-[0.55em] font-black text-indigo-500 uppercase mb-0.5 truncate">{{ t('balance') }}</p>
                        <p class="text-[0.8em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.net) }}</p>
                    </div>
                    <div class="h-8 w-px bg-slate-100 mx-1"></div>
                    <div class="text-center flex-1 min-w-0">
                        <p class="text-[0.55em] font-black text-orange-500 uppercase mb-0.5 truncate">{{ t('unrealized_pl') }}</p>
                        <p :class="stockTotalProfit >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[0.8em] font-black truncate">
                            {{ stockTotalProfit >= 0 ? '+' : '' }}${{ formatNumber(stockTotalProfit) }}
                        </p>
                    </div>
                </div>

                <div class="flex bg-slate-200 p-1.5 rounded-2xl text-[0.7em] font-black">
                    <button v-for="v in ['day','month','year','all']" :key="v" 
                        @click="chartRange = v"
                        :style="chartRange === v ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                        class="flex-1 py-2 rounded-xl transition-all"
                        :class="chartRange === v ? 'shadow-md scale-105' : 'text-slate-500'"
                    >
                        {{ t(v + '_view') }}
                    </button>
                </div>

                <div class="bg-white p-8 rounded-[3rem] card-shadow flex flex-col items-center">
                    <div class="flex justify-between items-center w-full mb-8 px-2">
                        <h4 class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('expense_structure') }}</h4>
                        <div class="flex bg-slate-50 p-1 rounded-full text-[8px] font-black border border-slate-100 overflow-hidden">
                            <button @click="chartMode = 'expense'" :class="chartMode === 'expense' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-2 transition-all">{{ t('expense') }}</button>
                            <button @click="chartMode = 'income'" :class="chartMode === 'income' ? 'bg-green-600 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-2 transition-all">{{ t('income') }}</button>
                        </div>
                    </div>
                    
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <div class="pie-chart shadow-inner" :style="{ background: pieGradient }"></div>
                        <div class="absolute w-32 h-32 bg-white rounded-full flex flex-col items-center justify-center shadow-lg border border-slate-50 text-center">
                            <p class="text-[0.6em] text-slate-400 font-black uppercase mb-1">{{ chartMode === 'expense' ? t('expense') : t('income') }}</p>
                            <p class="text-[1.1em] font-black" :class="chartMode === 'expense' ? 'text-red-500' : 'text-green-600'">${{ formatNumber(chartTotalValue) }}</p>
                        </div>
                    </div>

                    <div class="w-full mt-10 grid grid-cols-2 gap-3">
                        <div v-for="cat in chartCategories" :key="cat.name" class="flex items-center p-3 rounded-[1.5rem] bg-slate-50/80 border border-slate-100 transition-all hover:bg-slate-100">
                            <div class="w-3 h-3 rounded-full mr-3 shrink-0 shadow-sm" :style="{backgroundColor: cat.color}"></div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[9px] font-black text-slate-500 truncate">{{ cat.name }}</span>
                                <span class="text-xs font-black text-slate-800">${{ formatNumber(cat.value) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Ë¶ñÂúñ 4: Ë®≠ÂÆö (Settings) -->
            <section v-if="currentView === 'settings'" class="p-6">
                <div class="bg-white rounded-[2.5rem] p-8 card-shadow space-y-8 transition-all">
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('lang_label') }}</span>
                        <select v-model="settings.lang" class="bg-slate-50 rounded-xl px-4 py-3 font-black text-[0.7em] outline-none border-none ring-1 ring-slate-100">
                            <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('theme_label') }}</span>
                        <div class="flex gap-3">
                            <div v-for="color in ['#4f46e5', '#10b981', '#f43f5e', '#1e293b', '#f59e0b']" 
                                @click="settings.themeColor = color"
                                :style="{ backgroundColor: color }" 
                                class="w-8 h-8 rounded-full cursor-pointer border-2 transition-all shadow-md active:scale-75"
                                :class="settings.themeColor === color ? 'border-white ring-2 ring-indigo-200 scale-125' : 'border-transparent'">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('font_label') }}</span>
                        <div class="flex bg-slate-50 p-1 rounded-xl ring-1 ring-slate-100 overflow-hidden">
                            <button v-for="sz in ['small', 'medium', 'large']" :key="sz"
                                @click="settings.fontSize = sz"
                                :style="settings.fontSize === sz ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                                class="px-4 py-2 text-[0.65em] font-black rounded-lg transition-all"
                                :class="settings.fontSize === sz ? 'shadow-sm' : 'text-slate-400'"
                            >
                                {{ t('font_' + sz) }}
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ÂΩàÂá∫Á∑®ËºØÁ™ó (Êó•Ë®òËàáË≤°ÂãôÁµ±‰∏Ä) -->
        <transition name="fade">
            <div v-if="showAddModal" class="fixed inset-0 z-[100] flex items-end justify-center">
                <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showAddModal = false"></div>
                <!-- ÊâãÂã¢Áõ£ËÅΩËàáÊ®£ÂºèÂÑ™Âåñ -->
                <div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[96vh] overflow-y-auto shadow-2xl hide-scrollbar modal-scrollable"
                    @touchstart="handleModalTouchStart"
                    @touchend="handleModalTouchEnd"
                >
                    <!-- ÈóúÈñâÊåâÈàï (Âè≥‰∏äËßí) -->
                    <button @click="showAddModal = false" class="absolute top-6 right-6 p-2 text-slate-400 hover:text-slate-600 transition-colors z-[110]">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>

                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div>
                    <div class="flex justify-between items-center mb-6 px-1">
                        <h2 class="text-[1.3em] font-black text-slate-800">{{ currentMonth+1 }}/{{ selectedDay }} {{ t('new_record') }}</h2>
                        <button @click="saveRecord" :style="{ backgroundColor: settings.themeColor }" class="text-white px-10 py-3 rounded-full font-black shadow-xl active:scale-95 transition-all text-[0.8em] mr-8">{{ t('save') }}</button>
                    </div>

                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8">
                        <button @click="editTab = 'diary'" :class="editTab === 'diary' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'diary' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_diary') }}</button>
                        <button @click="editTab = 'finance'" :class="editTab === 'finance' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'finance' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_finance') }}</button>
                    </div>

                    <!-- Ë≤°ÂãôËº∏ÂÖ•ÂàÜÈ†Å -->
                    <div v-if="editTab === 'finance'" class="space-y-8 pb-24 overflow-x-hidden">
                        <div class="space-y-4">
                            <div v-for="(rec, ridx) in form.records" :key="ridx" class="flex items-center justify-between bg-white p-4 rounded-[1.5rem] card-shadow border border-slate-50 overflow-hidden">
                                <div class="flex items-center min-w-0 flex-1">
                                    <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center mr-3 text-[1.25em] shrink-0">{{ getCategoryIcon(rec.category) }}</div>
                                    <div class="min-w-0 flex-1">
                                        <p class="text-sm font-black text-slate-800">{{ rec.category }}</p>
                                        <p v-if="rec.note" class="text-[10px] text-slate-400 font-bold uppercase truncate pr-4">{{ rec.note }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 shrink-0">
                                    <span :class="rec.type === 'income' ? 'text-green-600' : 'text-red-600'" class="font-mono font-black text-[1.1em]">
                                        {{ rec.type === 'income' ? '+' : '-' }}{{ formatNumber(rec.amount) }}
                                    </span>
                                    <button @click="form.records.splice(ridx, 1)" class="text-slate-200 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-slate-50/80 rounded-[2.5rem] border border-slate-200 space-y-6">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-[0.7em] font-black text-slate-400 tracking-widest uppercase">{{ t('add_new_line') }}</span>
                                <div class="flex bg-white p-1 rounded-full shadow-sm text-[0.6em] font-black border border-slate-100 overflow-hidden">
                                    <button @click="newRecord.type = 'expense'" :class="newRecord.type === 'expense' ? 'bg-red-500 text-white shadow-md' : 'text-red-400'" class="px-6 py-2.5 transition-all text-[0.9em]">{{ t('expense') }}</button>
                                    <button @click="newRecord.type = 'income'" :class="newRecord.type === 'income' ? 'bg-green-500 text-white shadow-md' : 'text-green-400'" class="px-6 py-2.5 transition-all text-[0.9em]">{{ t('income') }}</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-3">
                                <button v-for="cat in currentCategories" :key="cat.name" 
                                    @click="newRecord.category = cat.name" 
                                    @touchstart="startCategoryLongPress(cat)" 
                                    @mousedown="startCategoryLongPress(cat)"
                                    @touchend="endCategoryLongPress"
                                    @mouseup="endCategoryLongPress"
                                    :class="newRecord.category === cat.name ? 'ring-4 ring-indigo-100 bg-white scale-105 shadow-sm' : 'bg-white/40 opacity-70'" class="category-btn transition-all">
                                    <span class="text-xl mb-1 flex items-center justify-center h-8 w-8">{{ cat.icon }}</span>
                                    <span class="text-[0.6em] font-black text-slate-600 truncate w-full text-center">{{ cat.name }}</span>
                                </button>
                                <button @click="showAddCategory = true" class="category-btn bg-white/40 border border-dashed border-slate-300 active:scale-90 flex items-center justify-center">
                                    <i data-lucide="plus" class="w-6 h-6 text-slate-300"></i>
                                </button>
                            </div>
                            <div class="flex gap-3 items-center w-full">
                                <div class="w-[30%] shrink-0">
                                    <input type="number" v-model="newRecord.amount" class="w-full bg-white p-4 rounded-2xl outline-none font-black text-[1em] border-none shadow-inner text-center" :placeholder="t('amount_ph')">
                                </div>
                                <div class="w-[70%] shrink-0">
                                    <input type="text" v-model="newRecord.note" class="w-full bg-white p-4 rounded-2xl outline-none font-bold text-[0.85em] border-none shadow-inner" :placeholder="t('note_ph')">
                                </div>
                            </div>
                            <button @click="addNewRecord" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-5 rounded-2xl font-black text-[0.85em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_to_list') }}</button>
                        </div>
                    </div>

                    <!-- Êó•Ë™åËº∏ÂÖ•ÂàÜÈ†Å (ÈéñÂÆöÊ©´ÂêëÊªëÂãï) -->
                    <div v-if="editTab === 'diary'" class="space-y-8 pb-24 px-1 overflow-x-hidden">
                        <div class="flex items-center justify-between bg-slate-50 p-5 rounded-[2.5rem] border border-slate-100">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-2xl bg-white shadow-md flex items-center justify-center mr-4" :class="{'recording-pulse': isRecording}">
                                    <i data-lucide="mic" class="w-6 h-6" :class="isRecording ? 'text-red-500' : 'text-p'"></i>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs font-black">{{ isRecording ? t('recording') : (form.audio ? t('recorded') : t('voice_memo')) }}</span>
                                    <span class="text-[0.6em] text-slate-400 font-bold uppercase tracking-widest">Voice</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button v-if="!isRecording" @click="startRecording" class="p-3 bg-p text-white rounded-xl shadow-lg active:scale-90 transition-all"><i data-lucide="play" class="w-4 h-4 fill-current text-white"></i></button>
                                <button v-else @click="stopRecording" class="p-3 bg-red-500 text-white rounded-xl shadow-lg animate-pulse"><i data-lucide="square" class="w-4 h-4 fill-current text-white"></i></button>
                                <button v-if="form.audio && !isRecording" @click="playAudio(form.audio)" class="p-3 bg-indigo-100 text-p rounded-xl active:scale-90"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('photo') }} ({{ form.photos?.length || 0 }}/10)</label>
                                <div class="relative p-3 bg-slate-100 rounded-2xl active:scale-90 transition-all">
                                    <i data-lucide="camera" class="w-5 h-5 text-slate-500"></i>
                                    <input type="file" multiple @change="handleMultiPhotoUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            </div>
                            <div v-if="form.photos?.length" class="flex gap-3 overflow-x-auto py-2 hide-scrollbar">
                                <div v-for="(img, idx) in form.photos" :key="idx" class="relative w-24 h-24 shrink-0 rounded-[1.5rem] overflow-hidden shadow-lg border-2 border-white">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="form.photos.splice(idx, 1)" class="absolute top-1.5 right-1.5 bg-black/60 text-white rounded-full p-1 active:scale-75"><i data-lucide="x" class="w-3 h-3 text-white"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('location_map') }}</label>
                                <button @click="openGoogleMapsSearch" class="px-5 py-2 bg-indigo-50 text-p rounded-full text-[0.6em] font-black active:scale-90 transition-all border border-indigo-100">
                                    {{ t('search_on_map') }}
                                </button>
                            </div>
                            <div class="flex gap-3">
                                <input v-model="locationSearch" @keyup.enter="addLocation" :placeholder="t('location_ph')" class="flex-1 bg-slate-50 p-4 rounded-2xl text-[0.85em] font-bold outline-none border-2 border-transparent focus:border-p transition-all shadow-inner">
                                <button @click="addLocation" class="bg-p text-white w-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-all"><i data-lucide="plus" class="w-6 h-6 text-white"></i></button>
                            </div>
                            <div class="space-y-2 px-1">
                                <div v-for="(loc, lidx) in form.locations" :key="lidx" class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 card-shadow animate-in slide-in-from-bottom">
                                    <div class="flex items-center text-[0.85em] font-black text-indigo-700 cursor-pointer" @click="openGoogleMaps(loc.name)">
                                        <i data-lucide="map-pin" class="w-4 h-4 mr-3 opacity-50"></i>
                                        <span>{{ loc.name }}</span>
                                    </div>
                                    <button @click="form.locations.splice(lidx, 1)" class="text-red-300 p-2 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('journal_feeling') }}</label>
                                <div class="flex gap-2.5">
                                    <button v-for="f in ['üòä','üòî','üò°','ü§©','üò¥','üí™','üç∑']" :key="f" @click="form.feeling = f" 
                                        :class="form.feeling === f ? 'scale-125 ring-2 ring-orange-200' : 'opacity-40'"
                                        class="text-[1.5em] transition-all">{{ f }}</button>
                                </div>
                            </div>
                            <textarea v-model="form.diaryText" class="w-full h-48 bg-slate-50 p-6 rounded-[2.5rem] border-none outline-none focus:ring-4 ring-indigo-50 shadow-inner text-[0.9em] font-bold leading-relaxed" :placeholder="t('journal_placeholder')"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ÂàÜÈ°ûÁ∑®ËºØÂΩàÁ™ó -->
        <transition name="fade">
            <div v-if="showAddCategory || showEditCategory" class="fixed inset-0 z-[200] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeCategoryModal"></div>
                <div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in">
                    <h3 class="text-[1.25em] font-black mb-8 text-slate-800">{{ showEditCategory ? t('edit_cat_title') : t('custom_cat_title') }}</h3>
                    <div class="space-y-8">
                        <div class="grid grid-cols-5 gap-3 max-h-48 overflow-y-auto p-1 hide-scrollbar">
                            <button v-for="ico in iconPool" :key="ico" @click="categoryForm.icon = ico" :class="categoryForm.icon === ico ? 'bg-indigo-100 ring-4 ring-indigo-200' : 'bg-slate-50'" class="text-[1.5em] p-3 rounded-2xl transition-all flex items-center justify-center">{{ ico }}</button>
                        </div>
                        <input v-model="categoryForm.name" type="text" class="w-full bg-slate-50 p-5 rounded-3xl outline-none font-bold border-none shadow-inner text-[0.9em]" :placeholder="t('cat_name_ph')">
                        <div class="flex gap-4 pt-4">
                            <button @click="closeCategoryModal" class="flex-1 py-5 rounded-2xl font-black text-slate-400 text-[0.8em]">{{ t('cancel') }}</button>
                            <button @click="confirmCategoryAction" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 text-[0.8em]">{{ t('confirm') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Â∫ïÈÉ®Â∞éË¶ΩÂàó -->
        <nav class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-slate-100 h-24 tab-bar z-40 px-3 transition-all shadow-lg flex items-center shrink-0">
            <div class="flex w-full items-center justify-around">
                <button v-for="v in ['ledger', 'stocks']" :key="v" @click="currentView = v"
                    :style="currentView === v ? { color: settings.themeColor } : {}"
                    class="flex flex-col items-center transition-all flex-1"
                    :class="currentView === v ? 'nav-active scale-110' : 'text-slate-300'"
                >
                    <i :data-lucide="v === 'ledger' ? 'calendar' : 'trending-up'" class="w-6 h-6"></i>
                    <span class="text-[0.6em] mt-1.5 uppercase font-black tracking-tighter">{{ t(v) }}</span>
                </button>
                
                <div class="flex justify-center relative flex-1">
                    <button @click="openAddModal()" :style="{ backgroundColor: settings.themeColor }" class="text-white w-16 h-16 rounded-[2.2rem] shadow-xl border-[6px] border-white flex items-center justify-center -translate-y-8 active:scale-90 transition-all hover:rotate-90">
                        <i data-lucide="plus" class="w-8 h-8 text-white"></i>
                    </button>
                </div>

                <button v-for="v in ['charts', 'settings']" :key="v" @click="currentView = v"
                    :style="currentView === v ? { color: settings.themeColor } : {}"
                    class="flex flex-col items-center transition-all flex-1"
                    :class="currentView === v ? 'nav-active scale-110' : 'text-slate-300'"
                >
                    <i :data-lucide="v === 'charts' ? 'pie-chart' : 'settings'" class="w-6 h-6"></i>
                    <span class="text-[0.6em] mt-1.5 uppercase font-black tracking-tighter">{{ t(v) }}</span>
                </button>
            </div>
        </nav>

    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        const apiKey = ""; 
        const currentView = ref('ledger');
        const showAddModal = ref(false);
        const showAddCategory = ref(false);
        const showEditCategory = ref(false);
        const chartRange = ref('all');
        const chartMode = ref('expense');
        const isAILoading = ref(false);
        const editTab = ref('diary');
        const isRecording = ref(false);
        const locationSearch = ref('');
        const lastSyncTime = ref('');
        let mediaRecorder = null;
        let audioChunks = [];

        const today = new Date();
        const currentYear = ref(today.getFullYear());
        const currentMonth = ref(today.getMonth());
        const selectedDay = ref(today.getDate());
        const settings = ref({ lang: 'zh', themeColor: '#4f46e5', fontSize: 'medium' });

        const dictionary = {
            zh: { 
                ledger: 'Â∏≥Êú¨', stocks: 'ËÇ°Â∏ÇÊäïË≥á', charts: 'ÂúñË°®ÂàÜÊûê', settings: 'Á≥ªÁµ±Ë®≠ÁΩÆ', 
                year: 'Âπ¥', month: 'Êúà', steps: 'Ê≠•', in_prefix: 'Êî∂', out_prefix: 'ÊîØ',
                weekdays: ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'],
                daily_finance: '‰ªäÊó•Ë≤°Âãô', daily_diary: 'ÂøÉÊÉÖÊó•Ë™å', voice_memo: 'Ë™ûÈü≥ÂÇôÂøò', recorded: 'ÈåÑÈü≥Â∑≤Â≠ò', recording: 'Ê≠£Âú®ÈåÑË£Ω',
                no_data_hint: '‰ªäÂ§©ÈÇÑÊ≤íÊúâÁ¥ÄÈåÑÂñî', net_worth: 'ÁµÑÂêàÂÉπÂÄº', total_income: 'Êî∂ÂÖ•Á∏ΩË®à', total_expense: 'ÊîØÂá∫Á∏ΩË®à',
                total_in: 'Á¥ØË®àÊî∂ÂÖ•', total_out_short: 'Á¥ØË®àÊîØÂá∫', balance: 'Á¥ØË®àÁµêÈ§ò', fetching: 'Ë°åÊÉÖÁç≤Âèñ‰∏≠',
                day_view: 'Êú¨Êó•', month_view: 'Êú¨Êúà', year_view: 'Âπ¥Â∫¶', all_view: 'ÂÖ®ÈÉ®Ë≥áÊñô',
                expense_structure: 'ÊîØÂá∫‰ΩîÊØîÂàÜÊûê', income_structure: 'Êî∂ÂÖ•‰ΩîÊØîÂàÜÊûê',
                lang_label: '‰ªãÈù¢Ë™ûË®Ä', theme_label: 'ÈÖçËâ≤ÊñπÊ°à', font_label: 'ÊñáÂ≠óÂ§ßÂ∞è',
                font_small: 'Â∞è (0.75x)', font_medium: '‰∏≠ (1.0x)', font_large: 'Â§ß (1.25x)',
                new_record: 'Êñ∞Â¢ûÁ¥ÄÈåÑ', save: '‰øùÂ≠òÁ¥ÄÈåÑ', ai_fill: 'AI Êô∫ÊÖßÂä©ÁêÜ',
                photo: 'ÂõûÊÜ∂Áõ∏Áâá', location_map: 'Ë∂≥Ë∑°Âú∞Èªû', footprints_list: '‰ªäÊó•Ë°åÁ®ãÊ∏ÖÂñÆ', custom_cat_title: 'Êñ∞Â¢ûÈ°ûÂà•', edit_cat_title: 'Á∑®ËºØÈ°ûÂà•',
                market_value: 'ÁµÑÂêàÁèæÂÄº', total_profit: 'È†ê‰º∞ÊêçÁõä', unrealized_pl: 'Êú™ÂØ¶ÁèæÊêçÁõä',
                stock_name_ph: 'ËÇ°Á•®ÂêçÁ®± (‰ª£Á¢º)', stock_qty_ph: 'ËÇ°Êï∏', stock_buy_ph: 'Ë≤∑ÂÖ•ÊàêÊú¨', add_stock_btn: 'Âä†ÂÖ•Ê∏ÖÂñÆ',
                shares_unit: 'ËÇ°', last_sync: 'ÊúÄÂæåÂêåÊ≠•', search_on_map: 'ÊêúÂ∞ãÂú∞Âúñ', location_ph: 'Ëº∏ÂÖ•Âú∞ÈªûÂêçÁ®±...',
                journal_feeling: 'ÂøÉÊÉÖÊÑüÂèó', journal_placeholder: 'ÂàÜ‰∫´‰ªäÂ§©ÁôºÁîüÁöÑ‰∫ãÔºü', amount_ph: 'ÈáëÈ°ç', note_ph: 'ÂÇôË®ª', add_to_list: 'Âä†ÂÖ•Ê∏ÖÂñÆ',
                income: 'Êî∂ÂÖ•', expense: 'ÊîØÂá∫', stat_btn: 'Êô∫ÊÖßÁµ±Ë®à', income_short: 'Êî∂', expense_short: 'ÊîØ',
                add_new_line: 'Êñ∞Â¢ûÊî∂ÊîØÊòéÁ¥∞', cancel: 'ÂèñÊ∂à', confirm: 'Á¢∫Ë™ç', cat_name_ph: '‰æãÂ¶ÇÔºöÂè∞Á©çÈõª„ÄÅË®ÇÈñ±Ë≤ª...'
            },
            en: { 
                ledger: 'Ledger', stocks: 'Stocks', charts: 'Charts', settings: 'Settings',
                year: '.', month: '.', steps: 'steps', in_prefix: 'IN', out_prefix: 'OUT',
                weekdays: ['S','M','T','W','T','F','S'],
                daily_finance: 'Finance', daily_diary: 'Journal', voice_memo: 'Voice', recorded: 'Saved', recording: 'Recording',
                no_data_hint: 'No records today', net_worth: 'Portfolio', total_income: 'Total In', total_expense: 'Total Out',
                total_in: 'Total In', total_out_short: 'Total Out', balance: 'Balance', fetching: 'Updating',
                day_view: 'Day', month_view: 'Month', year_view: 'Year', all_view: 'All Data',
                expense_structure: 'Expenses Analysis', income_structure: 'Income Analysis',
                lang_label: 'Language', theme_label: 'Color Theme', font_label: 'Font Size',
                font_small: 'S', font_medium: 'M', font_large: 'L',
                new_record: 'New Record', save: 'Save', ai_fill: 'AI Assistant',
                photo: 'Photos', location_map: 'Locations', footprints_list: 'Routes', custom_cat_title: 'Add Category', edit_cat_title: 'Edit Category',
                market_value: 'Market Value', total_profit: 'P/L Estimate', unrealized_pl: 'Unrealized P/L',
                stock_name_ph: 'Symbol/Name', stock_qty_ph: 'Shares', stock_buy_ph: 'Price', add_stock_btn: 'Add Stock',
                shares_unit: 'shs', last_sync: 'Sync', search_on_map: 'Map Search', location_ph: 'Enter location...',
                journal_feeling: 'Feelings', journal_placeholder: 'Tell me more...', amount_ph: '0', note_ph: 'Note', add_to_list: 'Add',
                income: 'Income', expense: 'Expense', stat_btn: 'AI Stats', income_short: 'In', expense_short: 'Out',
                add_new_line: 'Add Detail', cancel: 'Cancel', confirm: 'OK', cat_name_ph: 'Pet, Sub...'
            }
        };

        const t = (key) => dictionary[settings.value.lang][key] || key;

        const daysInMonth = computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate());
        const firstDayOfMonth = computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay());
        const selectedDateString = computed(() => `${currentYear.value}${t('year')}${currentMonth.value + 1}${t('month')}${selectedDay.value}Êó•`);

        const categories = ref([
            { name: 'È§êÈ£≤', icon: 'üç≤', type: 'expense' }, { name: '‰∫§ÈÄö', icon: 'üöó', type: 'expense' },
            { name: 'Ë≥ºÁâ©', icon: 'üõçÔ∏è', type: 'expense' }, { name: 'Â®õÊ®Ç', icon: 'üé¨', type: 'expense' },
            { name: 'Â±ÖÂÆ∂', icon: 'üè†', type: 'expense' }, { name: 'ÈÜ´ÁôÇ', icon: 'üíä', type: 'expense' },
            { name: '‰∫∫ÊÉÖ', icon: 'üéÅ', type: 'expense' }, { name: 'Ëñ™Ë≥á', icon: 'üí∞', type: 'income' },
            { name: 'Á¥ÖÂà©', icon: 'üßß', type: 'income' }, { name: 'ÂÖ∂ÂÆÉ', icon: 'üì¶', type: 'expense' }
        ]);
        const iconPool = ['üç≤', '‚òï', 'üç∫', 'üç∞', 'üöó', 'üö≤', '‚õΩ', '‚úàÔ∏è', 'üõçÔ∏è', 'üëï', 'üì±', 'üíÑ', 'üéÆ', 'üìö', 'üíä', 'ü©∫', 'üè†', 'üõãÔ∏è', 'üêà', 'üê∂', 'üåø', 'üí∞', 'üè¶', 'üíº', 'üéÅ', 'üç∑', 'üö¨', '‚õ™', 'üöï', 'üé†', 'üé®', 'üéª', 'üè∏', 'üõÄ', 'üßº', 'üî≠', 'üçî', 'üçü', 'üç£', 'üçº', 'üë∂', 'üêæ', 'üíà', 'üíá'];
        const categoryForm = ref({ name: '', icon: 'üç≤' });
        let targetCategory = null;

        let longPressTimer = null;
        const startCategoryLongPress = (cat) => {
            longPressTimer = setTimeout(() => {
                targetCategory = cat;
                categoryForm.value = { ...cat };
                showEditCategory.value = true;
            }, 800);
        };
        const endCategoryLongPress = () => clearTimeout(longPressTimer);

        const closeCategoryModal = () => {
            showAddCategory.value = false;
            showEditCategory.value = false;
            categoryForm.value = { name: '', icon: 'üç≤' };
        };

        const confirmCategoryAction = () => {
            if (!categoryForm.value.name.trim()) return;
            if (showEditCategory.value && targetCategory) {
                targetCategory.name = categoryForm.value.name.trim();
                targetCategory.icon = categoryForm.value.icon;
            } else {
                categories.value.push({ name: categoryForm.value.name.trim(), icon: categoryForm.value.icon, type: newRecord.value.type });
            }
            closeCategoryModal();
        };

        const entries = ref({
            "2026-02-10": { diaryText: "UI ÂÖ®Èù¢Áµ±‰∏ÄÔºåËÇ°Â∏ÇÂ∞çÊé• AI ÊêúÂ∞ãÂ∑•ÂÖ∑ÔºåÊñáÂ≠óÂ§ßÂ∞èÁ∏ÆÊîæÂØ¶Ë£ùÔºÅ", feeling: 'ü§©', records: [{ type: 'expense', amount: 350, category: 'È§êÈ£≤', note: 'È´òÈõÑÊôöÈ§ê' }], photos: [], locations: [{name: "ÈßÅ‰∫åËóùË°ìÁâπÂçÄ"}] }
        });
        const stockPortfolio = ref([{ name: 'Âè∞Á©çÈõª(2330)', qty: 10, buyPrice: 1850, currentPrice: 1850 }]);

        const form = ref({ diaryText: '', feeling: 'üòä', photos: [], locations: [], steps: 0, audio: null, records: [] });
        const newRecord = ref({ type: 'expense', amount: null, category: 'È§êÈ£≤', note: '' });
        const newStock = ref({ name: '', qty: null, buyPrice: null });

        // --- ‰øÆÊ≠£ÂæåÁöÑ AI ËÇ°Â∏ÇÁµ±Ë®à (Â∞çÊé• TWSE Êï∏Êìö) ---
        const callGeminiWithRetry = async (symbols, timeStr) => {
            // Âº∑Âåñ Prompt Ë¶ÅÊ±Ç AI ÂèÉËÄÉÂè∞ÁÅ£Ë≠âÂà∏‰∫§ÊòìÊâÄÂÆòÁ∂≤Êï∏Êìö
            const system = `You are a real-time financial analyst. SEARCH GOOGLE specifically for the ABSOLUTE LATEST market prices on the Taiwan Stock Exchange (TWSE). Respond ONLY with clean JSON: {"2330": 1880}. Time: ${timeStr}.`;
            const maxRetries = 5;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: symbols }] }], 
                            systemInstruction: { parts: [{ text: system }] }, 
                            tools: [{ "google_search": {} }] 
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    attempt++;
                    if (attempt === maxRetries) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                }
            }
        };

        const updatePortfolioPrices = async () => {
            if (!stockPortfolio.value.length) return;
            isAILoading.value = true;
            try {
                const now = new Date();
                const symbols = stockPortfolio.value.map(s => s.name).join(', ');
                const resText = await callGeminiWithRetry(symbols, now.toLocaleString());
                
                // ‰ΩøÁî® Regex Âº∑Âà∂ÊèêÂèñ JSON Â°äÔºåÊéíÈô§ Markdown ÂåÖË£π
                const jsonMatch = resText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const priceMap = JSON.parse(jsonMatch[0]);
                    stockPortfolio.value.forEach(stk => {
                        const match = Object.keys(priceMap).find(k => stk.name.includes(k) || k.includes(stk.name));
                        if (match) stk.currentPrice = priceMap[match];
                    });
                    lastSyncTime.value = now.toLocaleTimeString();
                }
            } catch (e) { 
                console.error("Stock Update Error:", e);
            }
            isAILoading.value = false;
        };

        // --- ÊâãÂã¢Êìç‰Ωú: ‰∏ãÊªëÈóúÈñâÂΩàÁ™ó ---
        const touchStartY = ref(0);
        const handleModalTouchStart = (e) => { touchStartY.value = e.touches[0].clientY; };
        const handleModalTouchEnd = (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const deltaY = touchEndY - touchStartY.value;
            const modalContent = e.currentTarget;
            // Âè™ÊúâÂú® modal Êç≤ÂãïÂà∞ÊúÄÈ†ÇÁ´Ø‰∏î‰∏ãÊªëË∂ÖÈÅé 150px ÊôÇÊâçÈóúÈñâ
            if (modalContent.scrollTop <= 0 && deltaY > 150) {
                showAddModal.value = false;
            }
        };

        const allDataTotals = computed(() => {
            let inc = 0, exp = 0;
            Object.values(entries.value).forEach(e => {
                (e.records || []).forEach(r => { if (r.type === 'income') inc += (r.amount || 0); else exp += (r.amount || 0); });
            });
            return { income: inc, expense: exp, net: inc - exp };
        });
        const stockTotalValue = computed(() => stockPortfolio.value.reduce((s, x) => s + (x.currentPrice * x.qty), 0));
        const stockTotalProfit = computed(() => stockPortfolio.value.reduce((s, x) => s + ((x.currentPrice - x.buyPrice) * x.qty), 0));

        const chartCategories = computed(() => {
            const totals = {};
            Object.keys(entries.value).forEach(dateKey => {
                const [y, m, d] = dateKey.split('-').map(Number);
                let match = chartRange.value === 'all' || (chartRange.value === 'year' && y === currentYear.value) || (chartRange.value === 'month' && m === currentMonth.value+1) || (chartRange.value === 'day' && d === selectedDay.value);
                if (match) (entries.value[dateKey].records || []).forEach(r => { if (r.type === chartMode.value) totals[r.category] = (totals[r.category] || 0) + r.amount; });
            });
            return Object.keys(totals).map((n, i) => ({ name: n, value: totals[n], color: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b', '#ec4899', '#8b5cf6'][i % 6] }));
        });
        const chartTotalValue = computed(() => chartCategories.value.reduce((a, b) => a + b.value, 0) || 0);
        const pieGradient = computed(() => {
            let offset = 0; const total = chartTotalValue.value || 1;
            const parts = chartCategories.value.map(cat => { const p = (cat.value / total) * 100; const part = `${cat.color} ${offset}% ${offset + p}%`; offset += p; return part; });
            return parts.length ? `conic-gradient(${parts.join(', ')})` : '#f1f5f9';
        });

        const startRecording = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader(); reader.onload = (f) => { form.value.audio = f.target.result; }; reader.readAsDataURL(blob); audioChunks = [];
            };
            mediaRecorder.start(); isRecording.value = true;
        };
        const stopRecording = () => { if (mediaRecorder) { mediaRecorder.stop(); isRecording.value = false; } };
        const playAudio = (url) => new Audio(url).play();
        const handleMultiPhotoUpload = (e) => {
            Array.from(e.target.files).slice(0, 10).forEach(file => {
                const reader = new FileReader(); reader.onload = (f) => form.value.photos.push(f.target.result); reader.readAsDataURL(file);
            });
        };
        const addLocation = () => { if (locationSearch.value.trim()) { form.value.locations.push({ name: locationSearch.value.trim() }); locationSearch.value = ''; updateIcons(); } };

        const openAddModal = (tab = 'diary') => {
            editTab.value = tab;
            const key = `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`;
            form.value = entries.value[key] ? JSON.parse(JSON.stringify(entries.value[key])) : { diaryText: '', feeling: 'üòä', photos: [], locations: [], steps: 0, audio: null, records: [] };
            showAddModal.value = true; updateIcons();
        };
        const saveRecord = () => {
            const key = `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`;
            entries.value[key] = JSON.parse(JSON.stringify(form.value)); showAddModal.value = false; updateIcons();
        };

        const addNewRecord = () => { if (newRecord.value.amount) { form.value.records.push({ ...newRecord.value }); newRecord.value.amount = null; newRecord.value.note = ''; } };
        const addStockItem = () => { if (newStock.value.name) { stockPortfolio.value.push({ ...newStock.value, currentPrice: newStock.value.buyPrice || 0 }); newStock.value = { name: '', qty: null, buyPrice: null }; } };
        const formatNumber = (num) => Math.floor(num || 0).toLocaleString();
        const updateIcons = () => nextTick(() => lucide.createIcons());
        const openGoogleMaps = (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank');
        const openGoogleMapsSearch = () => window.open(`https://www.google.com/maps`, '_blank');

        onMounted(() => updateIcons());
        watch([currentView, showAddModal, settings, editTab, chartRange, chartMode, showAddCategory, showEditCategory], () => updateIcons(), { deep: true });

        return {
            currentView, showAddModal, showAddCategory, showEditCategory, chartRange, chartMode, t, settings, currentYear, currentMonth, selectedDay, daysInMonth, firstDayOfMonth,
            selectedDateString, currentDayData: computed(() => entries.value[`${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`]),
            getDayEntries: (d) => { const k = `${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const e = entries.value[k]; return { hasDiary: !!(e?.diaryText || e?.photos?.length), hasFinance: !!(e?.records?.length) }; },
            form, saveRecord, openAddModal, allDataTotals, formatNumber, chartCategories, chartTotalValue, pieGradient,
            dayNetBalance: computed(() => { const e = (currentView.value === 'ledger' ? entries.value[`${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(selectedDay.value).padStart(2,'0')}`] : form.value)?.records || []; return e.filter(r => r.type === 'income').reduce((a, b) => a + b.amount, 0) - e.filter(r => r.type === 'expense').reduce((a, b) => a + b.amount, 0); }),
            dayTotalIncome: computed(() => (entries.value[`${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(selectedDay.value).padStart(2,'0')}`]?.records || []).filter(r => r.type === 'income').reduce((a, b) => a + b.amount, 0)),
            dayTotalExpense: computed(() => (entries.value[`${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(selectedDay.value).padStart(2,'0')}`]?.records || []).filter(r => r.type === 'expense').reduce((a, b) => a + b.amount, 0)),
            editTab, newRecord, currentCategories: computed(() => categories.value.filter(c => c.type === newRecord.value.type)), 
            addNewRecord, getCategoryIcon: (n) => categories.value.find(c => c.name === n)?.icon || '‚ùì', iconPool, categoryForm, confirmCategoryAction, closeCategoryModal,
            startCategoryLongPress, endCategoryLongPress, getPhotoGridClass: (c) => c === 1 ? 'photo-grid-1 h-48' : (c === 2 ? 'photo-grid-2 h-32' : 'photo-grid-3 h-48'),
            stockPortfolio, newStock, addStockItem, updatePortfolioPrices, stockTotalValue, stockTotalProfit, isAILoading, lastSyncTime, locationSearch, addLocation,
            isRecording, startRecording, stopRecording, playAudio, openGoogleMaps, openGoogleMapsSearch, handleMultiPhotoUpload, netWorth: computed(() => allDataTotals.value.net + stockTotalValue.value),
            handleModalTouchStart, handleModalTouchEnd
        };
    }
}).mount('#app');
</script>
</body>
</html>
