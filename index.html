<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeTrack - Â∞àÊ•≠ AI Êó•Ë™åËàáÂÆòÊñπËÇ°Â∏ÇË®òÂ∏≥</title>
    <!-- ÂºïÂÖ• Vue 3, Tailwind CSS Ëàá Lucide ÂúñÁ§∫Â∫´ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none; }
        :root { --p-color: #4f46e5; }
        
        /* Âü∫Á§é‰ΩàÂ±ÄËàáÈéñÂÆöÁ∏ÆÊîæÈÅ∏Âèñ */
        .app-container { height: 100dvh; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background-color: #f1f5f9;
        }

        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .text-p { color: var(--p-color) !important; }
        .bg-p { background-color: var(--p-color) !important; }
        .border-p { border-color: var(--p-color) !important; }
        .ring-p { --tw-ring-color: var(--p-color) !important; }

        /* ÊñáÂ≠óÂ§ßÂ∞èÁ∏ÆÊîæÁ≥ªÁµ± */
        .app-font-small { font-size: 12px; }
        .app-font-medium { font-size: 16px; }
        .app-font-large { font-size: 20px; }
        
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .safe-pb { padding-bottom: calc(8.5rem + env(safe-area-inset-bottom)); }

        .pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ÁÖßÁâáÊéíÁâàÁ∂≤Ê†º */
        .photo-grid-1 { grid-template-columns: 1fr; }
        .photo-grid-2 { grid-template-columns: 1fr 1fr; }
        .photo-grid-3 { grid-template-areas: "a b" "a c"; grid-template-columns: 1.5fr 1fr; }
        
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .modal-scrollable {
            touch-action: pan-y;
            overflow-x: hidden;
            overflow-y: auto;
            will-change: transform, opacity;
        }
        .modal-transition {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .category-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 1.25rem;
            transition: all 0.2s;
            overflow: hidden;
        }
        .nav-active { font-weight: 900; }

        /* ÈÄöÁü•ÂàóÂãïÁï´ */
        .slide-down-enter-active, .slide-down-leave-active { transition: all 0.3s ease; }
        .slide-down-enter-from, .slide-down-leave-to { transform: translateY(-100%); opacity: 0; }
    </style>
</head>
<body class="antialiased overflow-hidden text-slate-900">

<div id="app" v-cloak class="flex justify-center items-center app-container" :style="{'--p-color': settings.themeColor}">
    <div :class="['w-full sm:max-w-md h-full bg-slate-50 shadow-2xl relative flex flex-col overflow-hidden transition-all duration-300', 'app-font-' + settings.fontSize]">
        
        <!-- ÈÄöÁü•Âàó (Error Bar) -->
        <transition name="slide-down">
            <div v-if="errorMsg" class="absolute top-0 left-0 right-0 z-[100] bg-red-500 text-white py-3 px-6 text-center font-black text-xs shadow-xl flex items-center justify-center gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                {{ errorMsg }}
            </div>
        </transition>

        <!-- Ê®ôÈ°åÂçÄÂüü -->
        <header :style="{ backgroundColor: settings.themeColor }" class="p-4 text-white shadow-md shrink-0 z-50 transition-all duration-500">
            <!-- Â∏≥Êú¨È†ÅÈù¢ÔºöÂàÜÂàóÈ°ØÁ§∫Âπ¥Êúà -->
            <div v-if="currentView === 'ledger'" class="space-y-2">
                <div class="flex items-center justify-between">
                    <button @click="changeYear(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showYearPicker = true" class="text-lg font-black tracking-widest cursor-pointer active:opacity-70">{{ currentYear }} {{ t('year') }}</span>
                    <button @click="changeYear(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="flex items-center justify-between">
                    <button @click="changeMonth(-1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span @click="showMonthPicker = true" class="text-xl font-black tracking-widest cursor-pointer active:opacity-70">{{ currentMonth + 1 }} {{ t('month') }}</span>
                    <button @click="changeMonth(1)" class="p-2 active:opacity-50 transition-all"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>
            <!-- ÂÖ∂‰ªñÈ†ÅÈù¢ÔºöÂ∑¶ÂÅ¥ IconÔºåÂè≥‰∏äÊó•Êúü -->
            <div v-else class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-sm">
                        <path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="white" stroke-width="2.5"/>
                        <path d="M12 8V16M8 12H16" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="12" cy="12" r="3" fill="white" fill-opacity="0.3"/>
                    </svg>
                    <h1 class="font-black tracking-tight" style="font-size: 1.3em">{{ t(currentView) }}</h1>
                </div>
                <div @click="showYearPicker = true" class="text-right cursor-pointer active:opacity-60 bg-white/10 px-3 py-1 rounded-xl backdrop-blur-sm border border-white/10">
                    <p class="text-[0.6em] font-bold opacity-70">{{ currentYear }}{{ t('year') }}</p>
                    <p class="text-[1.1em] font-black leading-none">{{ currentMonth + 1 }}{{ t('month') }}</p>
                </div>
            </div>
        </header>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-slate-50 safe-pb">
            
            <!-- Âπ¥‰ªΩ/Êúà‰ªΩÈÅ∏ÂñÆÂΩàÁ™ó -->
            <div v-if="showYearPicker || showMonthPicker" class="absolute inset-0 z-[60] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="showYearPicker = false; showMonthPicker = false"></div>
                <div class="relative w-full max-w-xs bg-white rounded-[2.5rem] p-6 shadow-2xl animate-in zoom-in duration-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-black text-slate-400 text-xs uppercase tracking-widest">
                            {{ showYearPicker ? t('choose_year') : t('choose_month') }}
                        </h3>
                        <div class="flex gap-2">
                            <button @click="showYearPicker = true; showMonthPicker = false" :class="showYearPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                            <button @click="showMonthPicker = true; showYearPicker = false" :class="showMonthPicker ? 'text-p' : 'text-slate-300'"><i data-lucide="layers" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="picker-grid max-h-60 overflow-y-auto hide-scrollbar">
                        <template v-if="showYearPicker">
                            <button v-for="y in yearRange" :key="y" @click="currentYear = y; showYearPicker = false; showMonthPicker = true" 
                                :class="currentYear === y ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ y }}</button>
                        </template>
                        <template v-if="showMonthPicker">
                            <button v-for="m in 12" :key="m" @click="currentMonth = m-1; showMonthPicker = false" 
                                :class="currentMonth === m-1 ? 'bg-p text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-600'"
                                class="py-3 rounded-xl font-black transition-all">{{ m }}{{ t('month') }}</button>
                        </template>
                    </div>
                </div>
            </div>

            <!-- ÂàÜÈ†ÅÔºöÂ∏≥Êú¨ -->
            <section v-if="currentView === 'ledger'" class="animate-in fade-in duration-300">
                <!-- Êó•ÊõÜÁ∂≤Ê†º -->
                <div class="p-4 bg-white border-b sticky top-0 z-10 shadow-sm">
                    <div class="calendar-grid text-center text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-widest">
                        <div v-for="d in t('weekdays')" :key="d">{{ d }}</div>
                    </div>
                    <div class="calendar-grid gap-1">
                        <div v-for="empty in firstDayOfMonth" :key="'e'+empty"></div>
                        <div v-for="day in daysInMonth" :key="day" @click="selectedDay = day"
                            :style="selectedDay === day ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                            class="p-2 text-center rounded-xl cursor-pointer transition relative aspect-square flex flex-col items-center justify-center hover:bg-slate-100"
                            :class="selectedDay === day ? 'shadow-lg scale-105 z-10 font-black' : ''"
                        >
                            <span class="text-[0.85em] font-bold">{{ day }}</span>
                            <div class="flex gap-0.5 mt-0.5">
                                <div v-if="getDayEntries(day).hasDiary" :class="selectedDay === day ? 'bg-white' : 'bg-blue-400'" class="w-1 h-1 rounded-full"></div>
                                <div v-if="getDayEntries(day).hasFinance" :class="selectedDay === day ? 'bg-white' : 'bg-green-400'" class="w-1 h-1 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 space-y-4">
                    <h3 class="text-[0.75em] font-black text-slate-400 uppercase tracking-wider px-1">{{ selectedDateString }}</h3>

                    <div v-if="currentDayData" class="space-y-4">
                        <!-- Áï∂Êó•Ë≤°ÂãôÂç°Áâá -->
                        <div @click="openAddModal('finance')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between mb-4 border-b border-slate-50 pb-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="circle-dollar-sign" class="w-4 h-4 text-p"></i>
                                    <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_finance') }}</span>
                                </div>
                                <span class="text-[0.7em] font-bold text-slate-300">#{{ currentDayData.records?.length || 0 }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-green-50 flex items-center justify-center text-green-600 font-black"><i data-lucide="arrow-down-left" class="w-3 h-3"></i></div>
                                        <span class="text-[0.95em] font-black text-green-600 font-mono">+{{ formatNumber(dayTotalIncome) }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-red-50 flex items-center justify-center text-red-600 font-black"><i data-lucide="arrow-up-right" class="w-3 h-3"></i></div>
                                        <span class="text-[0.95em] font-black text-red-600 font-mono">-{{ formatNumber(dayTotalExpense) }}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[0.6em] text-slate-400 font-bold uppercase mb-1">{{ t('daily_net') }}</p>
                                    <div :class="dayNetBalance >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[1.8em] font-black font-mono tracking-tighter leading-none">
                                        {{ dayNetBalance >= 0 ? '+' : '' }}{{ formatNumber(dayNetBalance) }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂøÉÊÉÖÊó•Ë™åÂç°Áâá -->
                        <div @click="openAddModal('diary')" class="bg-white p-5 rounded-[1.5rem] card-shadow border border-slate-100 space-y-3 cursor-pointer active:scale-[0.98] transition-all">
                            <div class="flex items-center justify-between border-b border-slate-50 pb-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="pen-tool" class="w-4 h-4 text-orange-400"></i>
                                    <span class="text-[0.8em] font-black text-slate-700 uppercase tracking-widest">{{ t('daily_diary') }}</span>
                                </div>
                                <div class="text-[1.2em]">{{ currentDayData.feeling || 'üòä' }}</div>
                            </div>
                            <div v-if="currentDayData.photos?.length" class="grid gap-1 overflow-hidden rounded-xl" :class="getPhotoGridClass(currentDayData.photos.length)">
                                <img v-for="(img, idx) in currentDayData.photos.slice(0, 3)" :key="idx" :src="img" class="w-full h-full object-cover min-h-[80px]">
                            </div>
                            <p class="text-[0.9em] text-slate-600 leading-relaxed truncate">{{ currentDayData.diaryText || t('no_diary_text') }}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ÂàÜÈ†ÅÔºöËÇ°Â∏ÇÊäïË≥á -->
            <section v-if="currentView === 'stocks'" class="p-6 space-y-6 animate-in fade-in">
                <div class="bg-slate-900 text-white p-7 rounded-[2.5rem] shadow-xl relative overflow-hidden">
                    <div class="absolute -right-5 -top-5 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl"></div>
                    <div class="relative z-10 space-y-5">
                        <div class="flex justify-between items-center border-b border-white/10 pb-5 text-center">
                            <div class="flex-1">
                                <p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('market_value') }}</p>
                                <p class="text-xl font-black font-mono tracking-tighter">${{ formatNumber(stockTotalValue) }}</p>
                            </div>
                            <div class="w-px h-10 bg-white/10 mx-2"></div>
                            <div class="flex-1">
                                <p class="text-[0.6em] opacity-50 uppercase font-black tracking-widest">{{ t('total_profit') }}</p>
                                <p :class="stockTotalProfit >= 0 ? 'text-green-400' : 'text-red-400'" class="text-xl font-black font-mono tracking-tighter">
                                    {{ stockTotalProfit >= 0 ? '+' : '' }}{{ formatNumber(stockTotalProfit) }}
                                </p>
                            </div>
                        </div>
                        <button @click="updatePortfolioPrices" :disabled="isAILoading" class="w-full py-3 bg-white/10 rounded-2xl font-black text-[0.75em] flex items-center justify-center gap-2 active:scale-95 transition-all">
                            <i v-if="isAILoading" data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>
                            {{ isAILoading ? t('fetching') : t('stat_btn') }}
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(stk, idx) in stockPortfolio" :key="idx" class="bg-white p-4 rounded-3xl border border-slate-100 card-shadow flex justify-between items-center transition-all">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center mr-4 text-[1.25em] font-bold text-p shadow-inner">{{ stk.name[0] }}</div>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-black text-slate-800 truncate pr-2">{{ stk.name }}</p>
                                <p class="text-[0.6em] text-slate-400 font-bold uppercase mt-1">{{ stk.qty }} {{ t('shares_unit') }} ¬∑ @{{ formatNumber(stk.buyPrice) }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 text-right shrink-0">
                            <div>
                                <p :class="(stk.currentPrice - stk.buyPrice) >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[0.9em] font-black font-mono">
                                    {{ (stk.currentPrice - stk.buyPrice) >= 0 ? '+' : '' }}{{ formatNumber((stk.currentPrice - stk.buyPrice) * stk.qty) }}
                                </p>
                                <p class="text-[0.55em] text-slate-400 font-bold uppercase">ÁèæÂÉπ: {{ stk.currentPrice || '---' }}</p>
                            </div>
                            <button @click="stockPortfolio.splice(idx, 1)" class="text-slate-200 hover:text-red-400 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="p-6 bg-white rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4">
                        <input v-model="newStock.name" type="text" class="bg-slate-50 w-full p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner" :placeholder="t('stock_name_ph')">
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model.number="newStock.qty" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_qty_ph')">
                            <input v-model.number="newStock.buyPrice" type="number" class="bg-slate-50 p-4 rounded-2xl text-[0.85em] font-black outline-none border-none shadow-inner text-center" :placeholder="t('stock_buy_ph')">
                        </div>
                        <button @click="addStockItem" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-4 rounded-2xl font-black text-[0.8em] shadow-xl active:scale-[0.98] transition-all">
                            {{ t('add_stock_btn') }}
                        </button>
                    </div>
                </div>
            </section>

            <!-- ÂàÜÈ†ÅÔºöÂàÜÊûêÁµ±Ë®à -->
            <section v-if="currentView === 'charts'" class="p-6 space-y-8 animate-in fade-in text-center">
                <div class="bg-white p-4 rounded-[2rem] card-shadow border border-slate-50 flex items-center justify-between transition-all overflow-hidden gap-1">
                    <div class="flex-1 min-w-0">
                        <p class="text-[0.5em] font-black text-green-600 uppercase mb-0.5 truncate">{{ t('income_short') }}</p>
                        <p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.income) }}</p>
                    </div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[0.5em] font-black text-red-500 uppercase mb-0.5 truncate">{{ t('expense_short') }}</p>
                        <p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.expense) }}</p>
                    </div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[0.5em] font-black text-indigo-500 uppercase mb-0.5 truncate">{{ t('balance') }}</p>
                        <p class="text-[0.75em] font-black text-slate-700 truncate">${{ formatNumber(allDataTotals.net) }}</p>
                    </div>
                    <div class="h-6 w-px bg-slate-100"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[0.5em] font-black text-orange-500 uppercase mb-0.5 truncate">{{ t('unrealized_pl_short') }}</p>
                        <p :class="stockTotalProfit >= 0 ? 'text-green-600' : 'text-red-600'" class="text-[0.75em] font-black truncate">${{ formatNumber(stockTotalProfit) }}</p>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[3rem] card-shadow flex flex-col items-center border border-slate-50">
                    <div class="flex justify-between items-center w-full mb-8">
                        <h4 class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ chartMode === 'expense' ? t('expense_structure') : t('income_structure') }}</h4>
                        <div class="flex bg-slate-50 p-1 rounded-full text-[0.6em] font-black overflow-hidden border border-slate-100">
                            <button @click="chartMode = 'expense'" :class="chartMode === 'expense' ? 'bg-red-500 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('expense_short') }}</button>
                            <button @click="chartMode = 'income'" :class="chartMode === 'income' ? 'bg-green-600 text-white shadow-sm' : 'text-slate-400'" class="px-5 py-1.5 rounded-full transition-all">{{ t('income_short') }}</button>
                        </div>
                    </div>
                    <div class="relative w-48 h-48 flex items-center justify-center">
                        <div class="pie-chart shadow-inner" :style="{ background: pieGradient }"></div>
                        <div class="absolute w-32 h-32 bg-white rounded-full flex flex-col items-center justify-center shadow-lg text-center border border-slate-50">
                            <p class="text-[0.6em] text-slate-400 font-black uppercase mb-1">{{ chartMode === 'expense' ? t('expense') : t('income') }}</p>
                            <p class="text-[1.1em] font-black" :class="chartMode === 'expense' ? 'text-red-500' : 'text-green-600'">${{ formatNumber(chartTotalValue) }}</p>
                        </div>
                    </div>
                    <div class="w-full mt-10 grid grid-cols-2 gap-3 text-left">
                        <div v-for="cat in chartCategories" :key="cat.name" class="flex items-center p-3 rounded-[1.5rem] bg-slate-50 border border-slate-100 shadow-sm">
                            <div class="w-3 h-3 rounded-full mr-3 shrink-0 shadow-sm" :style="{backgroundColor: cat.color}"></div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[0.9em] font-black text-slate-500 truncate">{{ cat.name }}</span>
                                <span class="text-xs font-black text-slate-800">${{ formatNumber(cat.value) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ë®≠ÂÆöÂàÜÈ†Å -->
            <section v-if="currentView === 'settings'" class="p-6">
                <div class="bg-white rounded-[2.5rem] p-8 card-shadow space-y-8">
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('lang_label') }}</span>
                        <select v-model="settings.lang" class="bg-slate-50 rounded-xl px-4 py-3 font-black text-[0.7em] outline-none border-none ring-1 ring-slate-100">
                            <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('theme_label') }}</span>
                        <div class="flex gap-3">
                            <div v-for="color in ['#4f46e5', '#10b981', '#f43f5e', '#1e293b', '#f59e0b']" 
                                @click="settings.themeColor = color"
                                :style="{ backgroundColor: color }" 
                                class="w-8 h-8 rounded-full cursor-pointer border-2 transition-all shadow-md active:scale-75"
                                :class="settings.themeColor === color ? 'border-white ring-2 ring-indigo-200 scale-125' : 'border-transparent'">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[0.9em] font-black text-slate-700">{{ t('font_label') }}</span>
                        <div class="flex bg-slate-50 p-1 rounded-xl ring-1 ring-slate-100 overflow-hidden">
                            <button v-for="sz in ['small', 'medium', 'large']" :key="sz"
                                @click="settings.fontSize = sz"
                                :style="settings.fontSize === sz ? { backgroundColor: settings.themeColor, color: 'white' } : {}"
                                class="px-4 py-2 text-[0.65em] font-black rounded-lg transition-all"
                            >{{ t('font_' + sz) }}</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Á∑®ËºØ/Êñ∞Â¢ûË¶ñÁ™ó -->
        <transition name="fade">
            <div v-if="showAddModal" class="fixed inset-0 z-[100] flex items-end justify-center">
                <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" @click="showAddModal = false"></div>
                <div class="relative w-full sm:max-w-md bg-white rounded-t-[3.5rem] p-6 max-h-[96vh] shadow-2xl modal-scrollable overflow-x-hidden"
                    :class="{ 'modal-transition': !isDraggingModal }"
                    :style="modalStyle"
                    @touchstart="handleModalTouchStart"
                    @touchmove="handleModalTouchMove"
                    @touchend="handleModalTouchEnd"
                >
                    <button @click="showAddModal = false" class="absolute top-6 right-6 p-2 text-slate-300 hover:text-slate-600 transition-colors z-[110]">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 cursor-pointer"></div>
                    
                    <div class="flex justify-between items-center mb-6 px-1">
                        <h2 class="text-[1.3em] font-black text-slate-800">{{ currentMonth+1 }}/{{ selectedDay }} {{ t('new_record') }}</h2>
                        <button @click="saveRecord" :style="{ backgroundColor: settings.themeColor }" class="text-white px-10 py-3 rounded-full font-black shadow-xl active:scale-95 transition-all text-[0.8em] mr-8">{{ t('save') }}</button>
                    </div>

                    <div class="flex bg-slate-100 p-1.5 rounded-2xl mb-8">
                        <button @click="editTab = 'diary'" :class="editTab === 'diary' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'diary' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_diary') }}</button>
                        <button @click="editTab = 'finance'" :class="editTab === 'finance' ? 'bg-white shadow font-black' : 'text-slate-400 font-bold'" :style="editTab === 'finance' ? { color: settings.themeColor } : {}" class="flex-1 py-3 text-[0.8em] rounded-xl transition-all">{{ t('daily_finance') }}</button>
                    </div>

                    <!-- Ë≤°ÂãôËº∏ÂÖ• -->
                    <div v-if="editTab === 'finance'" class="space-y-8 pb-24">
                        <div class="grid grid-cols-4 gap-3 px-1">
                            <button v-for="cat in currentCategories" :key="cat.name" 
                                @click="newRecord.category = cat.name" 
                                @touchstart="startCategoryLongPress(cat)" @touchend="endCategoryLongPress"
                                @mousedown="startCategoryLongPress(cat)" @mouseup="endCategoryLongPress"
                                :class="newRecord.category === cat.name ? 'ring-4 ring-indigo-100 bg-white scale-105 shadow-sm' : 'bg-white/40 opacity-70'" 
                                class="category-btn transition-all"
                            >
                                <span class="text-xl mb-1 flex items-center justify-center h-8 w-8">{{ cat.icon }}</span>
                                <span class="text-[0.6em] font-black text-slate-600 truncate w-full text-center">{{ cat.name }}</span>
                            </button>
                            <button @click="showAddCategory = true" class="category-btn bg-white/40 border border-dashed border-slate-300 active:scale-90 flex items-center justify-center">
                                <i data-lucide="plus" class="w-6 h-6 text-slate-300"></i>
                            </button>
                        </div>
                        <div class="p-6 bg-slate-50/80 rounded-[2.5rem] border border-slate-200 space-y-6">
                            <div class="flex justify-between items-center px-1">
                                <span class="text-[0.7em] font-black text-slate-400 tracking-widest uppercase">{{ t('add_new_line') }}</span>
                                <div class="flex bg-white p-1 rounded-full shadow-sm text-[0.6em] font-black border border-slate-100 overflow-hidden">
                                    <button @click="newRecord.type = 'expense'" :class="newRecord.type === 'expense' ? 'bg-red-500 text-white shadow-md' : 'text-red-400'" class="px-6 py-2.5 transition-all">{{ t('expense_short') }}</button>
                                    <button @click="newRecord.type = 'income'" :class="newRecord.type === 'income' ? 'bg-green-500 text-white shadow-md' : 'text-green-400'" class="px-6 py-2.5 transition-all">{{ t('income_short') }}</button>
                                </div>
                            </div>
                            <div class="flex gap-3 items-center w-full">
                                <div class="w-[30%] shrink-0">
                                    <input type="number" v-model="newRecord.amount" class="w-full bg-white p-4 rounded-2xl outline-none font-black text-[1em] border-none shadow-inner text-center" :placeholder="t('amount_ph')">
                                </div>
                                <div class="w-[70%] shrink-0">
                                    <input type="text" v-model="newRecord.note" class="w-full bg-white p-4 rounded-2xl outline-none font-bold text-[0.85em] border-none shadow-inner" :placeholder="t('note_ph')">
                                </div>
                            </div>
                            <button @click="addNewRecord" :style="{ backgroundColor: settings.themeColor }" class="w-full text-white py-5 rounded-2xl font-black text-[0.85em] shadow-xl active:scale-[0.98] transition-all">{{ t('add_to_list') }}</button>
                        </div>
                    </div>

                    <!-- ÂøÉÊÉÖÊó•Ë™åËº∏ÂÖ• -->
                    <div v-if="editTab === 'diary'" class="space-y-8 pb-24 px-1 overflow-x-hidden">
                        <div class="space-y-4">
                            <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest px-1">{{ t('journal_feeling') }}</label>
                            <div class="flex gap-2.5 px-1 overflow-x-auto hide-scrollbar">
                                <button v-for="f in ['üòä','üòî','üò°','ü§©','üò¥','üí™','üç∑','üè¢','‚úàÔ∏è']" :key="f" @click="form.feeling = f" 
                                    :class="form.feeling === f ? 'scale-125 ring-2 ring-orange-200 bg-white' : 'opacity-40'"
                                    class="text-[1.5em] p-2 rounded-xl transition-all">{{ f }}</button>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('photo') }} ({{ form.photos?.length || 0 }}/10)</label>
                                <div class="relative p-3 bg-slate-100 rounded-2xl active:scale-90 transition-all">
                                    <i data-lucide="camera" class="w-5 h-5 text-slate-500"></i>
                                    <input type="file" multiple @change="handleMultiPhotoUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            </div>
                            <div v-if="form.photos?.length" class="flex gap-3 overflow-x-auto py-2 hide-scrollbar px-1">
                                <div v-for="(img, idx) in form.photos" :key="idx" class="relative w-24 h-24 shrink-0 rounded-[1.5rem] overflow-hidden shadow-lg border-2 border-white">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="form.photos.splice(idx, 1)" class="absolute top-1.5 right-1.5 bg-black/60 text-white rounded-full p-1 active:scale-75"><i data-lucide="x" class="w-3.5 h-3.5 text-white"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[0.7em] font-black text-slate-400 uppercase tracking-widest">{{ t('location_map') }}</label>
                                <button @click="openGoogleMapsSearch" class="px-5 py-2 bg-indigo-50 text-p rounded-full text-[0.6em] font-black active:scale-90 transition-all border border-indigo-100">{{ t('search_on_map') }}</button>
                            </div>
                            <div class="flex gap-3">
                                <input v-model="locationSearch" @keyup.enter="addLocation" :placeholder="t('location_ph')" class="flex-1 bg-slate-50 p-4 rounded-2xl text-[0.85em] font-bold outline-none border-2 border-transparent focus:border-p transition-all shadow-inner">
                                <button @click="addLocation" class="bg-p text-white w-14 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-all"><i data-lucide="plus" class="w-6 h-6 text-white"></i></button>
                            </div>
                            <div class="space-y-2">
                                <div v-for="(loc, lidx) in form.locations" :key="lidx" class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 card-shadow animate-in slide-in-from-bottom">
                                    <div class="flex items-center text-[0.85em] font-black text-indigo-700 cursor-pointer" @click="openGoogleMaps(loc.name)">
                                        <i data-lucide="map-pin" class="w-4 h-4 mr-3 opacity-50"></i>
                                        <span>{{ loc.name }}</span>
                                    </div>
                                    <button @click="form.locations.splice(lidx, 1)" class="text-red-300 p-2 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>
                        <textarea v-model="form.diaryText" class="w-full h-48 bg-slate-50 p-6 rounded-[2.5rem] border-none outline-none focus:ring-4 ring-indigo-50 shadow-inner text-[0.9em] font-bold leading-relaxed" :placeholder="t('journal_placeholder')"></textarea>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Ëá™ÂÆöÁæ©È°ûÂà•ÂΩàÁ™ó -->
        <transition name="fade">
            <div v-if="showAddCategory || showEditCategory" class="fixed inset-0 z-[200] flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeCategoryModal"></div>
                <div class="relative w-full max-w-sm bg-white rounded-[3rem] p-10 shadow-2xl animate-in zoom-in">
                    <h3 class="text-[1.25em] font-black mb-8 text-slate-800">{{ showEditCategory ? t('edit_cat_title') : t('custom_cat_title') }}</h3>
                    <div class="space-y-8">
                        <div class="grid grid-cols-5 gap-3 max-h-48 overflow-y-auto p-1 hide-scrollbar">
                            <button v-for="ico in iconPool" :key="ico" @click="categoryForm.icon = ico" :class="categoryForm.icon === ico ? 'bg-indigo-100 ring-4 ring-indigo-200' : 'bg-slate-50'" class="text-[1.5em] p-3 rounded-2xl transition-all flex items-center justify-center">{{ ico }}</button>
                        </div>
                        <input v-model="categoryForm.name" type="text" class="w-full bg-slate-50 p-5 rounded-3xl outline-none font-bold border-none shadow-inner text-[0.9em]" :placeholder="t('cat_name_ph')">
                        <div class="flex gap-4 pt-4">
                            <button @click="closeCategoryModal" class="flex-1 py-5 rounded-2xl font-black text-slate-400 text-[0.8em]">{{ t('cancel') }}</button>
                            <button @click="confirmCategoryAction" :style="{ backgroundColor: settings.themeColor }" class="flex-1 text-white py-5 rounded-2xl font-black shadow-xl active:scale-95 text-[0.8em]">{{ t('confirm') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Â∫ïÈÉ®Â∞éË¶ΩÂàó -->
        <nav class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-slate-100 h-24 tab-bar z-40 px-3 flex items-center shadow-lg shrink-0">
            <div class="flex w-full items-center justify-around">
                <button v-for="v in ['ledger', 'stocks', 'add', 'charts', 'settings']" :key="v" 
                    @click="v === 'add' ? openAddModal() : (currentView = v)"
                    :style="(currentView === v && v !== 'add') ? { color: settings.themeColor } : {}"
                    class="flex flex-col items-center transition-all flex-1"
                    :class="[currentView === v ? 'nav-active scale-110' : 'text-slate-300', v === 'add' ? 'relative' : '']"
                >
                    <template v-if="v === 'add'">
                        <div :style="{ backgroundColor: settings.themeColor }" class="text-white w-16 h-16 rounded-[2.2rem] shadow-xl border-[6px] border-white flex items-center justify-center -translate-y-8 active:scale-90 transition-all hover:rotate-90">
                            <i data-lucide="plus" class="w-8 h-8"></i>
                        </div>
                    </template>
                    <template v-else>
                        <i :data-lucide="v === 'ledger' ? 'calendar' : (v === 'stocks' ? 'trending-up' : (v === 'charts' ? 'pie-chart' : 'settings'))" class="w-6 h-6"></i>
                        <span class="text-[0.6em] mt-1.5 uppercase font-black tracking-tighter">{{ t(v) }}</span>
                    </template>
                </button>
            </div>
        </nav>

    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        const apiKey = ""; 
        const currentView = ref('ledger');
        const showAddModal = ref(false);
        const showYearPicker = ref(false);
        const showMonthPicker = ref(false);
        const showAddCategory = ref(false);
        const showEditCategory = ref(false);
        const chartRange = ref('all');
        const chartMode = ref('expense');
        const isAILoading = ref(false);
        const editTab = ref('diary');
        const isRecording = ref(false);
        const locationSearch = ref('');
        const lastSyncTime = ref('');
        const errorMsg = ref('');
        const touchYStart = ref(0);
        const modalDeltaY = ref(0);
        const isDraggingModal = ref(false);
        let mediaRecorder = null;
        let audioChunks = [];

        // 1. Âü∫Á§éÁãÄÊÖã
        const today = new Date();
        const currentYear = ref(today.getFullYear());
        const currentMonth = ref(today.getMonth());
        const selectedDay = ref(today.getDate());
        const settings = ref({ lang: 'zh', themeColor: '#4f46e5', fontSize: 'medium' });

        const dictionary = {
            zh: { 
                ledger: 'Â∏≥Êú¨', stocks: 'ËÇ°Â∏ÇÊäïË≥á', charts: 'ÂàÜÊûêÁµ±Ë®à', settings: 'Á≥ªÁµ±Ë®≠ÁΩÆ', add: 'Êñ∞Â¢û',
                year: 'Âπ¥', month: 'Êúà', steps: 'Ê≠•', in_prefix: 'Êî∂', out_prefix: 'ÊîØ', daily_net: 'Áï∂Êó•ÁµêÈ§ò',
                weekdays: ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'],
                daily_finance: 'Áï∂Êó•Ë≤°Âãô', daily_diary: 'ÂøÉÊÉÖÊó•Ë™å', fetching: 'Ë°åÊÉÖÁç≤Âèñ‰∏≠',
                no_data_hint: '‰ªäÂ§©Â∞öÊú™ÊúâÁ¥ÄÈåÑ', balance: 'ÁµêÈ§ò',
                choose_year: 'ÈÅ∏ÊìáÂπ¥‰ªΩ', choose_month: 'ÈÅ∏ÊìáÊúà‰ªΩ', confirm: 'Á¢∫Ë™ç',
                income: 'Êî∂ÂÖ•', expense: 'ÊîØÂá∫', income_short: 'Êî∂', expense_short: 'ÊîØ',
                stock_name_ph: 'ËÇ°Á•®ÂêçÁ®± (‰ª£Á¢º)', stock_qty_ph: 'ËÇ°Êï∏', stock_buy_ph: 'ÊàêÊú¨', add_stock_btn: 'Âä†ÂÖ•Ê∏ÖÂñÆ',
                shares_unit: 'ËÇ°', unrealized_pl: 'Êú™ÂØ¶ÁèæÊêçÁõä', unrealized_pl_short: 'Êú™ÂØ¶Áõä', expense_structure: 'ÊîØÂá∫‰ΩîÊØîÂàÜÊûê', income_structure: 'Êî∂ÂÖ•‰ΩîÊØîÂàÜÊûê',
                lang_label: 'Ë™ûË®ÄÈÅ∏Êìá', theme_label: 'ÈÖçËâ≤ÊñπÊ°à', font_label: 'ÊñáÂ≠óÂ§ßÂ∞è', new_record: 'Á¥ÄÈåÑË©≥ÊÉÖ', save: '‰øùÂ≠ò',
                font_small: 'Â∞è (0.75x)', font_medium: '‰∏≠ (1.0x)', font_large: 'Â§ß (1.25x)', journal_placeholder: 'ÂàÜ‰∫´‰ªäÂ§©ÁôºÁîüÁöÑ‰∫ã...',
                voice_memo: 'Ë™ûÈü≥ÂÇôÂøò', recorded: 'ÈåÑÈü≥Â∑≤Â≠ò', recording: 'ÈåÑÈü≥‰∏≠', amount_ph: 'ÈáëÈ°ç', note_ph: 'ÂÇôË®ª', add_to_list: 'Âä†ÂÖ•',
                stat_btn: 'Êô∫ÊÖßÁµ±Ë®à', no_diary_text: 'Â∞öÊú™Â°´ÂØ´‰ªäÊó•Êó•Ë™å...', market_value: 'Â∏ÇÂÄº', total_profit: 'Á∏ΩÊêçÁõä',
                photo: 'Áõ∏Áâá', location_map: 'Âú∞Èªû', search_on_map: 'Âú∞Âúñ', location_ph: 'Ëº∏ÂÖ•Âú∞Èªû...', add_new_line: 'Êñ∞Â¢ûÊî∂ÊîØÊòéÁ¥∞', journal_feeling: 'ÂøÉÊÉÖÊÑüÂèó',
                edit_cat_title: 'Á∑®ËºØÈ°ûÂà•', custom_cat_title: 'Ëá™ÂÆöÁæ©È°ûÂà•', cat_name_ph: 'ÂêçÁ®±'
            },
            en: { 
                ledger: 'Ledger', stocks: 'Stocks', charts: 'Charts', settings: 'Settings', add: 'New',
                year: 'Y', month: 'M', steps: 'steps', in_prefix: 'IN', out_prefix: 'OUT', daily_net: 'Net',
                weekdays: ['S','M','T','W','T','F','S'],
                daily_finance: 'Finance', daily_diary: 'Journal', fetching: 'Updating',
                no_data_hint: 'No data', balance: 'Balance',
                choose_year: 'Year', choose_month: 'Month', confirm: 'Done',
                income: 'Income', expense: 'Expense', income_short: 'IN', expense_short: 'OUT',
                stock_name_ph: 'Symbol', stock_qty_ph: 'Shares', stock_buy_ph: 'Cost', add_stock_btn: 'Add',
                shares_unit: 'shs', unrealized_pl: 'Unrealized P/L', unrealized_pl_short: 'U-PL', expense_structure: 'Expenses', income_structure: 'Income',
                lang_label: 'Language', theme_label: 'Theme', font_label: 'Font Size', new_record: 'Details', save: 'Save',
                add_new_line: 'Add Detail', journal_feeling: 'Feelings'
            }
        };

        const t = (key) => dictionary[settings.value.lang][key] || key;

        // 2. Ê†∏ÂøÉÊï∏Êìö
        const categories = ref([
            { name: 'È§êÈ£≤', icon: 'üç≤', type: 'expense' }, { name: '‰∫§ÈÄö', icon: 'üöó', type: 'expense' },
            { name: 'Ë≥ºÁâ©', icon: 'üõçÔ∏è', type: 'expense' }, { name: 'Â®õÊ®Ç', icon: 'üé¨', type: 'expense' },
            { name: 'Â±ÖÂÆ∂', icon: 'üè†', type: 'expense' }, { name: 'ÈÜ´ÁôÇ', icon: 'üíä', type: 'expense' },
            { name: 'Ëñ™Ë≥á', icon: 'üí∞', type: 'income' }, { name: 'Á¥ÖÂà©', icon: 'üßß', type: 'income' },
            { name: 'ÂÖ∂ÂÆÉ', icon: 'üì¶', type: 'expense' }
        ]);
        const iconPool = ['üç≤', '‚òï', 'üç∫', 'üç∞', 'üöó', 'üö≤', '‚õΩ', '‚úàÔ∏è', 'üõçÔ∏è', 'üëï', 'üì±', 'üéÆ', 'üé¨', 'üìö', 'üíä', 'ü©∫', 'üè†', 'üõãÔ∏è', 'üêà', 'üê∂', 'üåø', 'üí∞', 'üè¶', 'üíº', 'üéÅ', 'üç∑', 'üö¨', '‚õ™', 'üé®', 'üè∏', 'üçî', 'üç£', 'üçº', 'üë∂', 'üêæ', 'üíà', 'üíÑ'];
        
        const entries = ref({
            "2026-02-10": { diaryText: "UI ‰øÆÂæ©ÂÆåÊàêÔºåËÇ°Â∏ÇÁµ±Ë®àÂ∞çÊé• TWSE ÂÆòÊñπÊêúÂ∞ãÊï∏Êìö„ÄÇ", feeling: 'ü§©', records: [{ type: 'expense', amount: 350, category: 'È§êÈ£≤', note: 'È´òÈõÑÊôöÈ§ê' }], photos: [], locations: [{name: "ÈßÅ‰∫å"}] }
        });
        const stockPortfolio = ref([{ name: 'Âè∞Á©çÈõª(2330)', qty: 10, buyPrice: 1000, currentPrice: 1050 }]);
        const form = ref({ records: [], diaryText: '', feeling: 'üòä', photos: [], locations: [] });
        const newRecord = ref({ type: 'expense', amount: null, category: 'È§êÈ£≤', note: '' });
        const newStock = ref({ name: '', qty: null, buyPrice: null });
        const categoryForm = ref({ name: '', icon: 'üç≤' });
        let targetCategory = null;

        // 3. Ë®àÁÆóÂ±¨ÊÄß
        const currentDayKey = computed(() => `${currentYear.value}-${String(currentMonth.value + 1).padStart(2, '0')}-${String(selectedDay.value).padStart(2, '0')}`);
        const currentDayData = computed(() => entries.value[currentDayKey.value]);
        const daysInMonth = computed(() => new Date(currentYear.value, currentMonth.value + 1, 0).getDate());
        const firstDayOfMonth = computed(() => new Date(currentYear.value, currentMonth.value, 1).getDay());
        const selectedDateString = computed(() => {
            if (settings.value.lang === 'zh') return `${currentYear.value}Âπ¥ ${currentMonth.value + 1}Êúà ${selectedDay.value}Êó•`;
            return `${selectedDay.value} ${t('weekdays')[new Date(currentYear.value, currentMonth.value, selectedDay.value).getDay()]}, ${currentMonth+1}/${currentYear.value}`;
        });

        const dayTotalIncome = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'income').reduce((a, b) => a + (b.amount || 0), 0));
        const dayTotalExpense = computed(() => (currentDayData.value?.records || []).filter(r => r.type === 'expense').reduce((a, b) => a + (b.amount || 0), 0));
        const dayNetBalance = computed(() => dayTotalIncome.value - dayTotalExpense.value);

        const allDataTotals = computed(() => {
            let inc = 0, exp = 0;
            Object.values(entries.value).forEach(e => {
                (e.records || []).forEach(r => { if (r.type === 'income') inc += (r.amount || 0); else exp += (r.amount || 0); });
            });
            return { income: inc, expense: exp, net: inc - exp };
        });

        const stockTotalValue = computed(() => stockPortfolio.value.reduce((s, x) => s + ((x.currentPrice || x.buyPrice) * x.qty), 0));
        const stockTotalProfit = computed(() => stockPortfolio.value.reduce((s, x) => s + (((x.currentPrice || x.buyPrice) - x.buyPrice) * x.qty), 0));
        const netWorth = computed(() => allDataTotals.value.net + stockTotalValue.value);

        const chartCategories = computed(() => {
            const totals = {};
            Object.keys(entries.value).forEach(dateKey => {
                const [y, m] = dateKey.split('-').map(Number);
                if (y === currentYear.value && (m === currentMonth.value + 1)) {
                    (entries.value[dateKey].records || []).forEach(r => { if (r.type === chartMode.value) totals[r.category] = (totals[r.category] || 0) + r.amount; });
                }
            });
            return Object.keys(totals).map((n, i) => ({ name: n, value: totals[n], color: ['#6366f1', '#10b981', '#f43f5e', '#f59e0b', '#ec4899', '#8b5cf6'][i % 6] }));
        });
        const chartTotalValue = computed(() => chartCategories.value.reduce((a, b) => a + b.value, 0) || 0);
        const pieGradient = computed(() => {
            let offset = 0; const total = chartTotalValue.value || 1;
            const parts = chartCategories.value.map(cat => { const p = (cat.value / total) * 100; const part = `${cat.color} ${offset}% ${offset + p}%`; offset += p; return part; });
            return parts.length ? `conic-gradient(${parts.join(', ')})` : '#f1f5f9';
        });

        const yearRange = computed(() => { const y = new Date().getFullYear(); return Array.from({length: 12}, (_, i) => y - 5 + i); });
        const currentCategories = computed(() => categories.value.filter(c => c.type === newRecord.value.type));

        // 4. ÊñπÊ≥ïÂÆöÁæ©
        const changeYear = (delta) => currentYear.value += delta;
        const changeMonth = (delta) => { 
            let nm = currentMonth.value + delta;
            if (nm > 11) { nm = 0; currentYear.value++; }
            else if (nm < 0) { nm = 11; currentYear.value--; }
            currentMonth.value = nm;
        };

        const showError = (msg) => { errorMsg.value = msg; setTimeout(() => { errorMsg.value = ''; }, 3000); };

        const addNewRecord = () => { if (newRecord.value.amount) { form.value.records.push({ ...newRecord.value }); newRecord.value.amount = null; newRecord.value.note = ''; } };
        const addStockItem = () => { if (newStock.value.name) { stockPortfolio.value.push({ ...newStock.value, currentPrice: newStock.value.buyPrice || 0 }); newStock.value = { name: '', qty: null, buyPrice: null }; updateIcons(); } };

        // --- Ê†∏ÂøÉÂÑ™ÂåñÔºöÂÆòÊñπËÇ°Â∏ÇÁµ±Ë®àËàáÈåØË™§ÈÄöÁü•Ê©üÂà∂ (ÂèÉËÄÉ twstock ÈÇèËºØ) ---
        const updatePortfolioPrices = async () => {
            if (!stockPortfolio.value.length) return;
            isAILoading.value = true;
            
            const fetchWithRetry = async (symbols, attempt = 0) => {
                const now = new Date();
                const system = `You are a real-time data parser specializing in the Taiwan Stock Exchange (TWSE) and Taipei Exchange (TPEx). SEARCH GOOGLE for the ABSOLUTE LATEST trade prices (Êàê‰∫§ÂÉπ) on TWSE or TPEx for these symbols: ${symbols}. 
                Return ONLY a clean JSON object like {"2330": 1050}. If symbols have names like "Âè∞Á©çÈõª(2330)", focus ONLY on the ID. DO NOT VIRTUALIZE DATA. If data is unavailable, return an empty object {}. Current User context: ${now.toLocaleString()}.`;
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Search real-time TWSE prices for ${symbols}` }] }], systemInstruction: { parts: [{ text: system }] }, tools: [{ "google_search": {} }] })
                    });
                    const d = await res.json();
                    return d.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    if (attempt < 3) {
                        await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                        return fetchWithRetry(symbols, attempt + 1);
                    }
                    throw e;
                }
            };

            try {
                const syms = stockPortfolio.value.map(s => s.name).join(', ');
                const t = await fetchWithRetry(syms);
                if (t) {
                    const match = t.match(/\{[\s\S]*\}/);
                    if (match) {
                        const priceMap = JSON.parse(match[0]);
                        if (Object.keys(priceMap).length === 0) { showError("Ë≥áÊñôÊäìÂèñÂ§±Êïó (ÁÑ°Ê≠£Á¢∫Êï∏Êìö)"); }
                        else {
                            stockPortfolio.value.forEach(stk => {
                                const idOnly = stk.name.match(/\d{4,}/)?.[0] || stk.name;
                                const matchKey = Object.keys(priceMap).find(k => k.includes(idOnly) || idOnly.includes(k));
                                if (matchKey) stk.currentPrice = priceMap[matchKey];
                            });
                            lastSyncTime.value = new Date().toLocaleTimeString();
                        }
                    } else { showError("Ë≥áÊñôÊäìÂèñÂ§±Êïó"); }
                }
            } catch (e) { showError("Ë≥áÊñôÊäìÂèñÂ§±Êïó (Á∂≤Ë∑ØÈåØË™§)"); }
            isAILoading.value = false;
        };

        const handleMultiPhotoUpload = (e) => {
            Array.from(e.target.files).slice(0, 10).forEach(file => {
                const reader = new FileReader(); reader.onload = (f) => form.value.photos.push(f.target.result); reader.readAsDataURL(file);
            });
        };
        const addLocation = () => { if (locationSearch.value.trim()) { form.value.locations.push({ name: locationSearch.value.trim() }); locationSearch.value = ''; updateIcons(); } };
        const openGoogleMapsSearch = () => window.open(`https://www.google.com/maps`, '_blank');
        const openGoogleMaps = (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank');

        let longPressTimer = null;
        const startCategoryLongPress = (cat) => {
            longPressTimer = setTimeout(() => { targetCategory = cat; categoryForm.value = { ...cat }; showEditCategory.value = true; }, 800);
        };
        const endCategoryLongPress = () => clearTimeout(longPressTimer);
        const closeCategoryModal = () => { showAddCategory.value = false; showEditCategory.value = false; categoryForm.value = { name: '', icon: 'üç≤' }; };
        const confirmCategoryAction = () => {
            if (!categoryForm.value.name.trim()) return;
            if (showEditCategory.value && targetCategory) { targetCategory.name = categoryForm.value.name.trim(); targetCategory.icon = categoryForm.value.icon; }
            else { categories.value.push({ name: categoryForm.value.name.trim(), icon: categoryForm.value.icon, type: newRecord.value.type }); }
            closeCategoryModal();
        };

        const handleModalTouchStart = (e) => { if (e.currentTarget.scrollTop <= 0) { touchYStart.value = e.touches[0].clientY; isDraggingModal.value = true; } };
        const handleModalTouchMove = (e) => {
            if (!isDraggingModal.value) return;
            const d = e.touches[0].clientY - touchYStart.value;
            if (d > 0) { modalDeltaY.value = d; if (e.cancelable) e.preventDefault(); } else isDraggingModal.value = false;
        };
        const handleModalTouchEnd = () => { if (modalDeltaY.value > 150) showAddModal.value = false; modalDeltaY.value = 0; isDraggingModal.value = false; };
        const modalStyle = computed(() => {
            if (!isDraggingModal.value && modalDeltaY.value === 0) return {};
            return { transform: `translateY(${modalDeltaY.value}px) scale(${Math.max(0.85, 1 - modalDeltaY.value/2500)})`, opacity: Math.max(0.7, 1 - modalDeltaY.value/1000), transformOrigin: 'bottom center' };
        });

        const openAddModal = (tab = 'diary') => {
            editTab.value = tab;
            form.value = entries.value[currentDayKey.value] ? JSON.parse(JSON.stringify(entries.value[currentDayKey.value])) : { records: [], diaryText: '', feeling: 'üòä', photos: [], locations: [] };
            showAddModal.value = true; updateIcons();
        };
        const saveRecord = () => { entries.value[currentDayKey.value] = JSON.parse(JSON.stringify(form.value)); showAddModal.value = false; updateIcons(); };

        const formatNumber = (num) => Math.floor(num || 0).toLocaleString();
        const updateIcons = () => nextTick(() => lucide.createIcons());
        onMounted(() => updateIcons());
        watch([currentView, showAddModal, settings, editTab, chartRange, chartMode, showYearPicker, showMonthPicker, showAddCategory, showEditCategory], () => updateIcons());

        return {
            currentView, showAddModal, showYearPicker, showMonthPicker, showAddCategory, showEditCategory, yearRange, chartRange, chartMode, t, settings, currentYear, currentMonth, selectedDay, daysInMonth, firstDayOfMonth,
            selectedDateString, currentDayData, changeYear, changeMonth,
            getDayEntries: (d) => { const k = `${currentYear.value}-${String(currentMonth.value+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const e = entries.value[k]; return { hasDiary: !!(e?.diaryText || e?.photos?.length), hasFinance: !!(e?.records?.length) }; },
            form, saveRecord, openAddModal, allDataTotals, formatNumber, chartCategories, chartTotalValue, pieGradient,
            dayNetBalance, dayTotalIncome, dayTotalExpense, editTab, newRecord, currentCategories, errorMsg,
            addNewRecord, getCategoryIcon: (n) => categories.value.find(c => c.name === n)?.icon || '‚ùì', iconPool, categoryForm, confirmCategoryAction, closeCategoryModal,
            startCategoryLongPress, endCategoryLongPress, getPhotoGridClass: (c) => c === 1 ? 'photo-grid-1 h-48' : (c === 2 ? 'photo-grid-2 h-32' : 'photo-grid-3 h-48'),
            stockPortfolio, newStock, addStockItem, updatePortfolioPrices, stockTotalValue, stockTotalProfit, isAILoading, lastSyncTime,
            handleModalTouchStart, handleModalTouchMove, handleModalTouchEnd, isDraggingModal, modalStyle,
            handleMultiPhotoUpload, addLocation, locationSearch, openGoogleMaps: (n) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}`, '_blank'), openGoogleMapsSearch,
            netWorth
        };
    }
}).mount('#app');
</script>
</body>
</html>
